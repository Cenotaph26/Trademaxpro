<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>TRADEMAXPRO â€” AI Futures Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRADEMAXPRO v10 â€” Bloomberg Ã— Cyberpunk Terminal
   Complete redesign with all pro features
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg0:#010508; --bg1:#060c14; --bg2:#0a1120;
  --bg3:#0f1828; --bg4:#141e30; --bg5:#1a2438;
  --b1:rgba(0,210,255,.07); --b2:rgba(0,210,255,.15);
  --b3:rgba(0,210,255,.28);
  --t1:#cce4f8; --t2:#5b7fa0; --t3:#2a4460;
  --cyan:#00d2ff; --cyan2:#0099cc;
  --cg:rgba(0,210,255,.10); --cg2:rgba(0,210,255,.05);
  --green:#00e87c; --green2:#009950;
  --gg:rgba(0,232,124,.09);
  --red:#ff2b5a; --red2:#991a38;
  --rg:rgba(255,43,90,.09);
  --yellow:#ffcc00; --orange:#ff7020;
  --purple:#a855f7;
  --mono:'Space Mono',monospace;
  --sans:'Inter',sans-serif;
  --disp:'Orbitron',sans-serif;
  --r:3px; --r2:6px; --r3:10px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg0);color:var(--t1);font-family:var(--mono);font-size:11px;display:flex;flex-direction:column}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
::-webkit-scrollbar-track{background:transparent}

/* â•â• TICKER â•â• */
.ticker{height:26px;background:#000;border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 16px;overflow:hidden;flex-shrink:0;gap:0}
.ti{display:flex;align-items:center;gap:6px;padding:0 14px;border-right:1px solid var(--b1);height:100%}
.ti-s{font-size:9px;color:var(--t3);font-weight:700;letter-spacing:.07em}
.ti-p{color:var(--t1);font-size:10px}
.ti-c{font-size:9px;font-weight:700;padding:1px 5px;border-radius:2px}
.ti-c.p{color:var(--green);background:var(--gg)}
.ti-c.n{color:var(--red);background:var(--rg)}
.ti-c.z{color:var(--t3)}
.tlive{margin-left:auto;display:flex;align-items:center;gap:6px;font-size:9px;color:var(--t3);letter-spacing:.08em}
.ldot{width:5px;height:5px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s infinite}
.ldot.off{background:var(--red);box-shadow:0 0 6px var(--red);animation:none}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

/* â•â• HEADER â•â• */
header{height:54px;background:linear-gradient(180deg,var(--bg2) 0%,var(--bg1) 100%);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 20px;gap:0;flex-shrink:0;position:relative}
header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--cyan) 50%,transparent);opacity:.3}
.logo{font-family:var(--disp);font-size:15px;font-weight:800;color:var(--cyan);letter-spacing:.12em;text-shadow:0 0 24px rgba(0,210,255,.35);line-height:1}
.logo-sub{font-size:8px;letter-spacing:.18em;color:var(--t3);font-family:var(--sans);text-transform:uppercase;margin-top:2px}
.vsep{width:1px;height:30px;background:var(--b2);margin:0 22px;flex-shrink:0}
.hkpis{display:flex;gap:0;flex:1;height:100%}
.hkpi{display:flex;flex-direction:column;justify-content:center;gap:2px;padding:0 20px;border-right:1px solid var(--b1)}
.hkpi:first-child{padding-left:0}
.hkpi-l{font-size:8px;color:var(--t3);letter-spacing:.14em;text-transform:uppercase;font-family:var(--sans)}
.hkpi-v{font-family:var(--disp);font-size:17px;font-weight:600;line-height:1}
.cy{color:var(--cyan)} .g{color:var(--green)} .r{color:var(--red)} .y{color:var(--yellow)} .p{color:var(--purple)}
.hdr-r{display:flex;align-items:center;gap:8px;margin-left:auto}
.connbadge{display:flex;align-items:center;gap:6px;padding:5px 12px;background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);font-size:9px;letter-spacing:.08em;color:var(--t2)}
.hbtn{height:30px;padding:0 14px;border-radius:var(--r);font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:.06em;cursor:pointer;transition:all .15s;border:1px solid;display:flex;align-items:center;gap:6px}
.hbtn-a{background:var(--cg);border-color:var(--cyan2);color:var(--cyan)}
.hbtn-a:hover{background:rgba(0,210,255,.18);box-shadow:0 0 14px var(--cg)}
.hbtn-s{background:var(--rg);border-color:rgba(255,43,90,.35);color:var(--red)}
.hbtn-s:hover{background:rgba(255,43,90,.18)}

/* â•â• STATS BAR â•â• */
.sbar{height:52px;background:var(--bg1);border-bottom:1px solid var(--b1);display:grid;grid-template-columns:repeat(8,1fr);flex-shrink:0}
.sc{display:flex;flex-direction:column;justify-content:center;padding:0 16px;border-right:1px solid var(--b1);gap:1px;transition:background .15s}
.sc:hover{background:var(--cg2)} .sc:last-child{border-right:none}
.sc-l{font-size:8px;color:var(--t3);letter-spacing:.1em;text-transform:uppercase;font-family:var(--sans);font-weight:500}
.sc-v{font-size:13px;font-weight:700;font-family:var(--mono);line-height:1}
.sc-s{font-size:9px;color:var(--t3);margin-top:1px}

/* â•â• MAIN LAYOUT â•â• */
.app{display:grid;grid-template-columns:1fr 320px 264px;flex:1;overflow:hidden;min-height:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lpanel{display:flex;flex-direction:column;border-right:1px solid var(--b1);overflow:hidden;min-height:0}
.tabbar{display:flex;background:var(--bg1);border-bottom:1px solid var(--b1);padding:0 16px;flex-shrink:0}
.tab{padding:11px 16px 10px;font-size:10px;letter-spacing:.1em;color:var(--t3);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:color .15s;font-family:var(--sans);font-weight:600;text-transform:uppercase;white-space:nowrap}
.tab:hover{color:var(--t2)}
.tab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.pcontent{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.pcontent.active{display:flex}

/* Market search */
.msrow{display:flex;align-items:center;gap:8px;padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--b1);flex-shrink:0}
.msearch{flex:1;background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);padding:6px 10px 6px 30px;color:var(--t1);font-family:var(--mono);font-size:11px;outline:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235b7fa0' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:8px center;transition:border-color .15s}
.msearch:focus{border-color:var(--cyan2);box-shadow:0 0 0 2px var(--cg)}
.msearch::placeholder{color:var(--t3)}
.sbtn-grp{display:flex;gap:4px}
.sbtn{height:26px;padding:0 10px;background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;font-weight:700;cursor:pointer;transition:all .1s}
.sbtn:hover,.sbtn.active{border-color:var(--cyan2);color:var(--cyan);background:var(--cg)}

/* Coin grid */
.cgscroll{flex:1;overflow-y:auto;min-height:0}
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(92px,1fr));gap:1px;background:var(--b1);padding:1px}
.cc{background:var(--bg2);padding:7px 8px;cursor:pointer;transition:background .1s;display:flex;flex-direction:column;gap:2px;position:relative;min-height:52px}
.cc:hover{background:var(--bg3)}
.cc.sel{background:var(--cg);outline:1px solid var(--cyan2)}
.cc.sel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--cyan)}
.cc-sym{font-size:10px;font-weight:700;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cc-px{font-size:9px;color:var(--t2)}
.cc-chg{font-size:9px;font-weight:700}
.cc-chg.p{color:var(--green)} .cc-chg.n{color:var(--red)}

/* Bottom: chart + strategy */
.mbot{display:grid;grid-template-columns:1fr 1fr;border-top:1px solid var(--b1);height:195px;flex-shrink:0}
.ph{height:28px;background:var(--bg3);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 12px;gap:8px;flex-shrink:0}
.pt{font-size:9px;letter-spacing:.1em;color:var(--t3);text-transform:uppercase;font-family:var(--sans);font-weight:600}
.pbadge{font-size:8px;padding:1px 6px;border-radius:2px;font-weight:700;letter-spacing:.05em}
.pbadge.live{background:var(--gg);color:var(--green);border:1px solid rgba(0,232,124,.3)}
.cpane{border-right:1px solid var(--b1);display:flex;flex-direction:column;overflow:hidden}
.civs{display:flex;gap:1px;margin-left:auto}
.ivbtn{height:18px;padding:0 6px;background:transparent;border:none;color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;border-radius:2px;transition:all .1s}
.ivbtn:hover,.ivbtn.active{color:var(--cyan);background:var(--cg)}
.cbody{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:5px;color:var(--t3);font-size:10px}

/* Strategy panel */
.stpane{display:flex;flex-direction:column;overflow:hidden}
.stlist{flex:1;overflow-y:auto;padding:5px 7px;display:flex;flex-direction:column;gap:3px}
.strow{display:flex;align-items:center;gap:7px;padding:5px 8px;background:var(--bg3);border-radius:var(--r);border:1px solid transparent;transition:border-color .1s}
.strow:hover{border-color:var(--b2)}
.stag{font-size:8px;padding:2px 5px;border-radius:2px;font-weight:700;flex-shrink:0}
.stag.b{background:var(--gg);color:var(--green);border:1px solid rgba(0,232,124,.2)}
.stag.g{background:var(--cg);color:var(--cyan2);border:1px solid var(--b2)}
.stag.m{background:rgba(255,112,32,.1);color:var(--orange);border:1px solid rgba(255,112,32,.2)}
.stag.d{background:var(--rg);color:var(--red);border:1px solid rgba(255,43,90,.2)}
.sname{font-size:10px;color:var(--t1);flex:1;font-family:var(--sans)}
.sbarbg{width:80px;height:3px;background:var(--bg5);border-radius:2px;overflow:hidden;flex-shrink:0}
.sbarfill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--cyan),rgba(0,210,255,.3));transition:width .8s}
.swr{font-size:9px;color:var(--t2);width:32px;text-align:right;flex-shrink:0}
.spf{font-size:9px;font-weight:700;width:28px;text-align:right;flex-shrink:0}

/* â”€â”€ POSITIONS TAB â”€â”€ */
.pospane{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:0}
/* Rich position card like reference img */
.poscard{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:12px 14px;transition:border-color .15s}
.poscard:hover{border-color:var(--b2)}
.poscard.lng{border-left:3px solid var(--green)}
.poscard.shrt{border-left:3px solid var(--red)}
.pc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px}
.pc-left{display:flex;flex-direction:column;gap:5px}
.pc-symrow{display:flex;align-items:center;gap:6px}
.pc-sym{font-size:15px;font-weight:700;color:var(--t1);font-family:var(--mono)}
.pc-badge{font-size:9px;font-weight:700;letter-spacing:.07em;padding:2px 8px;border-radius:2px}
.pc-badge.lng{background:var(--gg);color:var(--green);border:1px solid rgba(0,232,124,.25)}
.pc-badge.shrt{background:var(--rg);color:var(--red);border:1px solid rgba(255,43,90,.25)}
.pc-lev{font-size:9px;background:var(--bg3);border:1px solid var(--b2);border-radius:2px;padding:2px 6px;color:var(--yellow)}
.pc-ai{font-size:9px;background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.25);border-radius:2px;padding:2px 6px;color:var(--purple)}
.pc-age{font-size:9px;color:var(--t3)}
.pc-right{text-align:right}
.pc-pnl{font-family:var(--disp);font-size:18px;font-weight:700}
.pc-pnlpct{font-size:10px;opacity:.8;margin-top:1px}
/* Metrics */
.pc-metrics{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:9px}
.pc-m{background:var(--bg3);border-radius:var(--r);padding:6px 9px;display:flex;flex-direction:column;gap:1px}
.pc-ml{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.07em;font-family:var(--sans)}
.pc-mv{font-size:11px;font-weight:700;color:var(--t1)}
.pc-mv.g{color:var(--green)} .pc-mv.r{color:var(--red)} .pc-mv.cy{color:var(--cyan)}
/* SL/TP bar */
.pc-sltp{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:9px}
.pc-sl-val{color:var(--red);font-weight:700}
.pc-tp-val{color:var(--green);font-weight:700}
.pc-sltp-bar{flex:1;height:4px;background:var(--bg5);border-radius:2px;position:relative;overflow:visible}
.pc-bar-fill{height:100%;border-radius:2px;position:absolute;top:0}
.pc-bar-sl{background:var(--red);left:0}
.pc-bar-tp{background:var(--green);right:0}
.pc-bar-cur{width:3px;height:10px;background:#fff;border-radius:1px;position:absolute;top:-3px;transform:translateX(-50%);transition:left .5s}
/* Indicators row */
.pc-inds{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px}
.ind{font-size:9px;font-weight:700;padding:2px 7px;border-radius:2px;background:var(--bg4);border:1px solid var(--b2);color:var(--t2)}
.ind.bull{background:rgba(0,232,124,.08);border-color:rgba(0,232,124,.2);color:var(--green)}
.ind.bear{background:rgba(255,43,90,.08);border-color:rgba(255,43,90,.2);color:var(--red)}
.ind.warn{background:rgba(255,204,0,.08);border-color:rgba(255,204,0,.2);color:var(--yellow)}
/* AI Analysis */
.pc-analysis{background:var(--bg3);border:1px solid var(--b1);border-radius:var(--r);padding:8px 10px;margin-bottom:9px}
.pc-analysis-hdr{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.pc-analysis-title{font-size:8px;letter-spacing:.1em;color:var(--cyan);text-transform:uppercase;font-family:var(--sans);font-weight:600}
.pc-score{font-size:9px;font-weight:700;padding:1px 6px;border-radius:2px}
.pc-score.pos{background:var(--gg);color:var(--green)}
.pc-score.neg{background:var(--rg);color:var(--red)}
.pc-analysis-body{font-size:9px;color:var(--t2);line-height:1.7;display:flex;flex-wrap:wrap;gap:3px}
.pc-detail{background:var(--bg4);border-radius:2px;padding:1px 6px;color:var(--t2)}
/* Close btn */
.pc-close{width:100%;height:28px;background:var(--rg);border:1px solid rgba(255,43,90,.28);border-radius:var(--r);color:var(--red);font-family:var(--mono);font-size:9px;font-weight:700;letter-spacing:.07em;cursor:pointer;transition:all .15s}
.pc-close:hover{background:rgba(255,43,90,.2);border-color:var(--red)}

/* Signals tab */
.sigpane{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:0}
.sig-card{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:10px 12px}
.sig-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
.sig-sym{font-size:12px;font-weight:700;color:var(--t1)}
.sig-side{font-size:9px;font-weight:700;letter-spacing:.08em;padding:2px 8px;border-radius:2px}
.sig-side.buy{background:var(--gg);color:var(--green)} .sig-side.sell{background:var(--rg);color:var(--red)} .sig-side.none{background:var(--bg4);color:var(--t3)}
.sig-sbg{height:2px;background:var(--bg5);border-radius:1px;overflow:hidden;margin-bottom:5px}
.sig-sfill{height:100%;border-radius:1px}
.sig-sfill.positive{background:var(--green)} .sig-sfill.negative{background:var(--red)}
.signal-detail-row{font-size:9px;color:var(--t3);border-top:1px solid var(--b1);padding-top:3px;margin-top:3px}
.signal-card .signal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
.signal-card .signal-symbol{font-size:12px;font-weight:700;color:var(--t1)}
.signal-card .signal-side{font-size:9px;font-weight:700;letter-spacing:.08em;padding:2px 8px;border-radius:2px}
.signal-card .signal-side.buy{background:var(--gg);color:var(--green)}
.signal-card .signal-side.sell{background:var(--rg);color:var(--red)}
.signal-card .signal-side.none{background:var(--bg4);color:var(--t3)}
.signal-score-bar{height:2px;background:var(--bg5);border-radius:1px;overflow:hidden;margin-bottom:5px}
.signal-score-fill{height:100%;border-radius:1px}
.signal-score-fill.positive{background:var(--green)}
.signal-score-fill.negative{background:var(--red)}

/* Ctrl pane */
.ctrlpane{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:0}
.csect{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);overflow:hidden}
.csect-hdr{height:32px;background:var(--bg3);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 14px;gap:8px;font-size:9px;letter-spacing:.1em;color:var(--t2);text-transform:uppercase;font-family:var(--sans);font-weight:600}
.csect-body{padding:12px;display:flex;flex-direction:column;gap:9px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.fg{display:flex;flex-direction:column;gap:3px}
.fl{font-size:8px;color:var(--t3);letter-spacing:.09em;text-transform:uppercase;font-family:var(--sans);font-weight:500}
input,select{background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);padding:7px 10px;color:var(--t1);font-family:var(--mono);font-size:11px;outline:none;transition:border-color .15s,box-shadow .15s;width:100%}
input:focus,select:focus{border-color:var(--cyan2);box-shadow:0 0 0 2px var(--cg)}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235b7fa0'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
input[type=range]{padding:0;background:transparent;border:none;height:16px;accent-color:var(--cyan);box-shadow:none}
.prevrow{background:var(--bg3);border:1px solid var(--b1);border-radius:var(--r);padding:7px 11px;font-size:10px;color:var(--t2);line-height:1.65}
.trade-btns{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.btn-long{height:38px;background:var(--gg);border:1px solid rgba(0,232,124,.4);border-radius:var(--r);color:var(--green);font-family:var(--mono);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-long:hover{background:rgba(0,232,124,.2);box-shadow:0 0 16px var(--gg)}
.btn-long:disabled{opacity:.28;cursor:not-allowed}
.btn-short{height:38px;background:var(--rg);border:1px solid rgba(255,43,90,.35);border-radius:var(--r);color:var(--red);font-family:var(--mono);font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-short:hover{background:rgba(255,43,90,.2);box-shadow:0 0 14px var(--rg)}
.btn-short:disabled{opacity:.28;cursor:not-allowed}
.btn-closeall{width:100%;height:34px;background:rgba(255,112,32,.08);border:1px solid rgba(255,112,32,.28);border-radius:var(--r);color:var(--orange);font-family:var(--mono);font-size:10px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-closeall:hover{background:rgba(255,112,32,.16)}
.btn-apply{width:100%;height:34px;background:var(--cg);border:1px solid var(--cyan2);border-radius:var(--r);color:var(--cyan);font-family:var(--mono);font-size:10px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-apply:hover{background:rgba(0,210,255,.2);box-shadow:0 0 12px var(--cg)}

/* â•â• SLIDER SETTING â€” reference image style â•â• */
.slider-setting{display:flex;flex-direction:column;gap:5px}
.slider-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
.slider-label{font-size:9px;color:var(--t2);font-family:var(--sans);font-weight:500;letter-spacing:.04em}
.slider-val{font-size:13px;font-weight:700;color:var(--cyan);font-family:var(--mono)}
.slider-desc{font-size:8px;color:var(--t3);line-height:1.4;margin-top:2px}
input[type=range].slider-input{width:100%;height:4px;border-radius:2px;border:none;background:var(--bg5);accent-color:var(--cyan);cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIDDLE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mpanel{display:flex;flex-direction:column;border-right:1px solid var(--b1);overflow:hidden;background:var(--bg1)}
.trade-hdr{padding:12px 16px 10px;border-bottom:1px solid var(--b1);background:var(--bg2);flex-shrink:0}
.tsrow{display:flex;align-items:baseline;justify-content:space-between}
.tsym{font-size:14px;font-weight:700;color:var(--t1)}
.tprice{font-family:var(--disp);font-size:22px;font-weight:700;color:var(--cyan);letter-spacing:.03em;text-shadow:0 0 20px rgba(0,210,255,.3)}
.tsymlink{font-size:9px;color:var(--cyan2);cursor:pointer;letter-spacing:.04em;display:block;margin-top:2px}
.tsymlink:hover{color:var(--cyan)}
.tform{padding:12px 16px;display:flex;flex-direction:column;gap:9px;border-bottom:1px solid var(--b1);flex-shrink:0}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.lev-disp{display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);padding:5px 10px;height:34px}
.lev-l{font-size:9px;color:var(--t3)}
.lev-v{font-family:var(--disp);font-size:17px;color:var(--yellow);font-weight:600}
.maxtprow{display:flex;justify-content:flex-end;gap:5px;font-size:9px}
.pnl-prev{background:var(--bg3);border:1px solid var(--b1);border-radius:var(--r);padding:8px 11px;font-size:10px;color:var(--t2);line-height:1.7}
.pnl-prev span{color:var(--t1);font-weight:700}
.tactions{padding:11px 16px;display:flex;flex-direction:column;gap:7px;border-bottom:1px solid var(--b1);flex-shrink:0}
.tbtn-l{height:44px;background:linear-gradient(135deg,rgba(0,232,124,.13),rgba(0,232,124,.06));border:1px solid rgba(0,232,124,.4);border-radius:var(--r);color:var(--green);font-family:var(--disp);font-size:12px;font-weight:700;letter-spacing:.1em;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px}
.tbtn-l:hover{background:linear-gradient(135deg,rgba(0,232,124,.24),rgba(0,232,124,.12));box-shadow:0 0 22px rgba(0,232,124,.2)}
.tbtn-l:disabled{opacity:.22;cursor:not-allowed}
.tbtn-s{height:44px;background:linear-gradient(135deg,rgba(255,43,90,.13),rgba(255,43,90,.06));border:1px solid rgba(255,43,90,.35);border-radius:var(--r);color:var(--red);font-family:var(--disp);font-size:12px;font-weight:700;letter-spacing:.1em;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px}
.tbtn-s:hover{background:linear-gradient(135deg,rgba(255,43,90,.24),rgba(255,43,90,.12));box-shadow:0 0 18px rgba(255,43,90,.18)}
.tbtn-s:disabled{opacity:.22;cursor:not-allowed}

/* Agent mini */
.agent-mini{padding:12px 16px;border-bottom:1px solid var(--b1);flex-shrink:0}
.agent-mini-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.agent-ttl{font-size:9px;letter-spacing:.14em;color:var(--t3);text-transform:uppercase;font-family:var(--sans);font-weight:600}
.toggle{width:38px;height:20px;background:var(--bg5);border:1px solid var(--b2);border-radius:10px;position:relative;cursor:pointer;-webkit-appearance:none;outline:none;transition:all .2s}
.toggle:checked{background:rgba(0,232,124,.2);border-color:rgba(0,232,124,.5)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--t3);border-radius:50%;transition:all .2s}
.toggle:checked::after{left:20px;background:var(--green);box-shadow:0 0 8px rgba(0,232,124,.5)}
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.acell{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r);padding:7px 10px;display:flex;flex-direction:column;gap:2px}
.acell-l{font-size:8px;color:var(--t3);letter-spacing:.09em;text-transform:uppercase;font-family:var(--sans)}
.acell-v{font-size:13px;font-weight:700;color:var(--t1);font-family:var(--mono)}
.acell-v.on{color:var(--green)} .acell-v.off{color:var(--t3)} .acell-v.y{color:var(--yellow)}

/* Market list mini */
.mlist-sect{border-top:1px solid var(--b1);flex-shrink:0;max-height:190px;display:flex;flex-direction:column}
.mlist-hdr{height:28px;background:var(--bg2);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 12px;gap:6px;flex-shrink:0}
.mlist-cnt{font-size:10px;font-weight:700;color:var(--cyan)}
.mlist-s{flex:1;background:var(--bg3);border:1px solid var(--b2);border-radius:var(--r);padding:3px 8px;color:var(--t1);font-family:var(--mono);font-size:10px;outline:none}
.mlist-s:focus{border-color:var(--cyan2)} .mlist-s::placeholder{color:var(--t3)}
.mlist-scroll{flex:1;overflow-y:auto}
.mi{display:flex;align-items:center;padding:5px 12px;border-bottom:1px solid var(--b1);cursor:pointer;transition:background .1s;gap:6px}
.mi:hover{background:var(--bg3)} .mi.sel{background:var(--cg)}
.mi-sym{font-size:10px;font-weight:700;color:var(--t1);flex:1}
.mi-q{font-size:9px;color:var(--t3)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rpanel{display:flex;flex-direction:column;overflow:hidden;background:var(--bg0)}
.ftabbar{display:flex;background:var(--bg1);border-bottom:1px solid var(--b1);flex-shrink:0}
.ftab{flex:1;height:34px;display:flex;align-items:center;justify-content:center;font-size:9px;letter-spacing:.1em;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;font-family:var(--sans);font-weight:600;text-transform:uppercase;background:none;border-top:none;border-left:none;border-right:1px solid var(--b1)}
.ftab:last-child{border-right:none}
.ftab:hover{color:var(--t2);background:var(--cg2)}
.ftab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:var(--cg2)}
.fcontent{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0}
.fcontent.active{display:flex}

/* Log filters */
.lfrow{display:flex;align-items:center;gap:4px;padding:5px 8px;background:var(--bg1);border-bottom:1px solid var(--b1);flex-wrap:wrap;flex-shrink:0}
.lfbtn{height:20px;padding:0 7px;background:transparent;border:1px solid var(--b1);border-radius:2px;color:var(--t3);font-family:var(--mono);font-size:8px;font-weight:700;cursor:pointer;transition:all .1s}
.lfbtn:hover,.lfbtn.active{border-color:var(--cyan2);color:var(--cyan);background:var(--cg)}
.lactions{margin-left:auto;display:flex;gap:3px;align-items:center}
.libtn{width:22px;height:20px;background:transparent;border:1px solid var(--b1);border-radius:2px;color:var(--t3);font-size:10px;cursor:pointer;transition:all .1s;display:flex;align-items:center;justify-content:center}
.libtn:hover{border-color:var(--b2);color:var(--t2)}
.auto-lbl{font-size:8px;color:var(--t3);display:flex;align-items:center;gap:3px;cursor:pointer}
.auto-lbl input{width:11px;height:11px;accent-color:var(--cyan)}
.logarea{flex:1;overflow-y:auto;background:#000;min-height:0}
.logline{display:flex;gap:6px;padding:2px 9px;border-bottom:1px solid rgba(0,210,255,.025);line-height:1.5}
.logline:hover{background:rgba(255,255,255,.015)}
.log-t{color:var(--t3);flex-shrink:0;font-size:9px;padding-top:1px;min-width:44px}
.log-m{color:var(--t2);flex:1;word-break:break-all;font-size:10px}
.logline.ok{border-left:2px solid rgba(0,232,124,.5)}
.logline.ok .log-m{color:rgba(0,232,124,.9)}
.logline.error{border-left:2px solid rgba(255,43,90,.6)}
.logline.error .log-m{color:rgba(255,43,90,.9)}
.logline.warn{border-left:2px solid rgba(255,204,0,.5)}
.logline.warn .log-m{color:rgba(255,204,0,.9)}

/* Signals right panel */
.smini{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--b1);border-bottom:1px solid var(--b1);flex-shrink:0}
.smcell{background:var(--bg1);padding:7px 11px}
.sml{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.09em;font-family:var(--sans)}
.smv{font-size:12px;font-weight:700;color:var(--t1)}
.spanel{flex:1;overflow-y:auto;min-height:0;padding:10px;display:flex;flex-direction:column;gap:8px}
.spcard{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:10px 12px}

/* Trade feed (right side - reference img 3 style) */
.tradefeed{flex:1;overflow-y:auto;min-height:0;font-size:10px}
.tfd-item{display:flex;align-items:flex-start;gap:8px;padding:7px 11px;border-bottom:1px solid var(--b1);transition:background .1s}
.tfd-item:hover{background:var(--bg2)}
.tfd-side{font-size:8px;font-weight:700;padding:2px 6px;border-radius:2px;flex-shrink:0;margin-top:1px}
.tfd-side.lng{background:var(--gg);color:var(--green)} .tfd-side.shrt{background:var(--rg);color:var(--red)}
.tfd-body{flex:1;min-width:0}
.tfd-sym{font-size:10px;font-weight:700;color:var(--t1)}
.tfd-meta{font-size:9px;color:var(--t3);line-height:1.5;word-break:break-word}
.tfd-pnl{text-align:right;flex-shrink:0}
.tfd-pnl-val{font-size:11px;font-weight:700}
.tfd-pnl-pct{font-size:9px;opacity:.7}

/* Modal */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,4,12,.88);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center}
.modal-ov.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--b3);border-radius:var(--r2);padding:20px;width:360px;max-height:70vh;display:flex;flex-direction:column;gap:12px;box-shadow:0 20px 60px rgba(0,0,0,.8);position:relative}
.modal-ttl{font-family:var(--disp);font-size:13px;font-weight:700;color:var(--cyan);letter-spacing:.07em}
.modal-cls{position:absolute;top:14px;right:14px;background:var(--bg4);border:1px solid var(--b2);border-radius:3px;color:var(--t3);width:24px;height:24px;font-size:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center}
.modal-cls:hover{color:var(--t1);border-color:var(--b3)}
#toast-container{position:fixed;top:78px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:7px}
.toast{display:flex;align-items:center;gap:9px;padding:9px 13px;border-radius:var(--r);font-size:11px;font-family:var(--mono);min-width:240px;max-width:320px;animation:slideIn .3s ease;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.toast.error{background:rgba(255,43,90,.14);border:1px solid rgba(255,43,90,.4);color:var(--red)}
.toast.success{background:rgba(0,232,124,.1);border:1px solid rgba(0,232,124,.35);color:var(--green)}
.toast.info{background:var(--cg);border:1px solid var(--b2);color:var(--cyan)}
.toast.warn{background:rgba(255,204,0,.1);border:1px solid rgba(255,204,0,.35);color:var(--yellow)}
.toast-icon{font-size:14px;flex-shrink:0}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes fadeOut{to{opacity:0;transform:translateX(20px)}}
.spinner{width:10px;height:10px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state,.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:9px;color:var(--t3);font-size:11px;min-height:80px;padding:20px;text-align:center}
.loading-text{color:var(--t3);padding:20px;text-align:center;font-size:11px;display:flex;align-items:center;gap:8px;justify-content:center}
.kill-switch-banner{background:rgba(255,43,90,.12);border:1px solid rgba(255,43,90,.3);border-radius:var(--r);padding:8px 12px;font-size:10px;color:var(--red);display:none}
.kill-switch-banner.visible{display:block}
.agent-info-item{background:var(--bg3);border-radius:var(--r);padding:7px 9px;display:flex;flex-direction:column;gap:2px}
.agent-info-label{font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;font-family:var(--sans)}
.agent-info-value{font-size:12px;font-weight:700;color:var(--t1)}

@media(max-width:1200px){.app{grid-template-columns:1fr 320px}.rpanel{display:none}.sbar{grid-template-columns:repeat(4,1fr)}}
@media(max-width:900px){.app{grid-template-columns:1fr}.mpanel{display:none}}
</style>
</head>
<body>

<!-- TICKER -->
<div class="ticker">
  <div class="ti" id="t-btc"><span class="ti-s">BTC</span><span class="ti-p">â€“</span><span class="ti-c z">â€“</span></div>
  <div class="ti" id="t-eth"><span class="ti-s">ETH</span><span class="ti-p">â€“</span><span class="ti-c z">â€“</span></div>
  <div class="ti" id="t-sol"><span class="ti-s">SOL</span><span class="ti-p">â€“</span><span class="ti-c z">â€“</span></div>
  <div class="ti" id="t-bnb"><span class="ti-s">BNB</span><span class="ti-p">â€“</span><span class="ti-c z">â€“</span></div>
  <div class="ti" id="t-xrp"><span class="ti-s">XRP</span><span class="ti-p">â€“</span><span class="ti-c z">â€“</span></div>
  <div class="tlive"><div class="ldot off" id="conn-dot"></div><span id="conn-label">BAÄLANIYOR</span></div>
</div>

<!-- HEADER -->
<header>
  <div>
    <div class="logo">TRADEMAXPRO</div>
    <div class="logo-sub">BINANCE FUTURES Â· AI ENGINE Â· TESTNET</div>
  </div>
  <div class="vsep"></div>
  <div class="hkpis">
    <div class="hkpi"><div class="hkpi-l">Bakiye</div><div class="hkpi-v cy" id="header-balance">$0.00</div></div>
    <div class="hkpi"><div class="hkpi-l">PNL</div><div class="hkpi-v g" id="header-pnl">+$0.00</div></div>
    <div class="hkpi"><div class="hkpi-l">Win Rate</div><div class="hkpi-v y" id="header-wr">â€“</div></div>
    <div class="hkpi"><div class="hkpi-l">Drawdown</div><div class="hkpi-v r" id="header-dd">â€“</div></div>
    <div class="hkpi"><div class="hkpi-l">P.Factor</div><div class="hkpi-v p" id="header-pf">â€“</div></div>
  </div>
  <div class="hdr-r">
    <div class="connbadge"><div class="ldot off" id="conn-dot2" style="width:6px;height:6px"></div><span id="conn-label2">BaÄŸlanÄ±yor</span></div>
    <button class="hbtn hbtn-a" id="header-agent-btn" onclick="toggleAgent(true)">â–¶ BAÅLAT</button>
    <button class="hbtn hbtn-s" onclick="ctrlCloseAll()">â–  DURDUR</button>
  </div>
</header>

<!-- STATS BAR -->
<div class="sbar">
  <div class="sc"><div class="sc-l">PortfÃ¶y</div><div class="sc-v cy" id="balance-val">$0.00</div><div class="sc-s" id="balance-start">BaÅŸlangÄ±Ã§: â€“</div></div>
  <div class="sc"><div class="sc-l">Toplam PNL</div><div class="sc-v g" id="pnl-val">+$0.00</div><div class="sc-s" id="pnl-pct">+0.00%</div></div>
  <div class="sc"><div class="sc-l">Win Rate</div><div class="sc-v y" id="winrate-val">â€“</div><div class="sc-s" id="winrate-sub">W: â€“ / L: â€“</div></div>
  <div class="sc"><div class="sc-l">Profit Factor</div><div class="sc-v p" id="pf-val">â€“</div><div class="sc-s">KazanÃ§ / KayÄ±p</div></div>
  <div class="sc"><div class="sc-l">Drawdown</div><div class="sc-v r" id="dd-val">â€“</div><div class="sc-s">Zirve dÃ¼ÅŸÃ¼ÅŸ</div></div>
  <div class="sc"><div class="sc-l">AÃ§Ä±k Poz</div><div class="sc-v p" id="open-pos-val">0</div><div class="sc-s" id="max-pos-sub">Maks 10 poz</div></div>
  <div class="sc"><div class="sc-l">Ä°ÅŸlem SayÄ±sÄ±</div><div class="sc-v" id="daily-trades-val">0</div><div class="sc-s">Toplam trade</div></div>
  <div class="sc"><div class="sc-l">Coin SayÄ±sÄ±</div><div class="sc-v cy" id="coin-count-val">â€“</div><div class="sc-s" id="market-count">â€“ Futures Ã§ifti</div></div>
</div>

<!-- MAIN APP -->
<div class="app">

  <!-- â•â•â•â•â•â•â•â• LEFT PANEL â•â•â•â•â•â•â•â• -->
  <div class="lpanel">
    <div class="tabbar">
      <button class="tab active" data-tab="market">Piyasa</button>
      <button class="tab" data-tab="positions">Pozisyonlar</button>
      <button class="tab" data-tab="signals">Sinyaller</button>
      <button class="tab" data-tab="control">âš™ Kontrol</button>
    </div>

    <!-- PIYASA TAB -->
    <div class="pcontent active" id="tab-market">
      <div class="msrow">
        <input type="text" class="msearch" id="market-search-input" placeholder="ğŸ” Coin ara... (BTC, ETH, SOL)" oninput="filterMarket(this.value)"/>
        <div class="sbtn-grp">
          <button class="sbtn active" onclick="sortMarket('chg',this)">% DEÄÄ°ÅÄ°M</button>
          <button class="sbtn" onclick="sortMarket('vol',this)">HACÄ°M</button>
          <button class="sbtn" onclick="sortMarket('name',this)">Ä°SÄ°M</button>
        </div>
      </div>
      <div class="cgscroll">
        <div class="cgrid" id="market-list">
          <div class="empty-state" style="grid-column:1/-1"><div>âŸ³</div>YÃ¼kleniyor...</div>
        </div>
      </div>
      <div class="mbot">
        <div class="cpane">
          <div class="ph">
            <span class="pt" id="chart-sym-label">CHART</span>
            <span style="font-size:9px;color:var(--t3)">PNL</span>
            <span class="pbadge live">CANLI</span>
            <div class="civs">
              <button class="ivbtn active" onclick="setInterval2('1m',this)">1m</button>
              <button class="ivbtn" onclick="setInterval2('3m',this)">3m</button>
              <button class="ivbtn" onclick="setInterval2('5m',this)">5m</button>
              <button class="ivbtn" onclick="setInterval2('15m',this)">15m</button>
              <button class="ivbtn" onclick="setInterval2('1h',this)">1h</button>
              <button class="ivbtn" onclick="setInterval2('4h',this)">4h</button>
            </div>
          </div>
          <div class="cbody">
            <div style="font-size:22px;opacity:.2">ğŸ“Š</div>
            <div>Grafik verisi yÃ¼kleniyor...</div>
            <div style="font-size:9px;color:var(--t3)">Fiyat: <span id="current-price">â€“</span></div>
          </div>
        </div>
        <div class="stpane">
          <div class="ph"><span class="pt">Strateji Ã–ÄŸrenimi</span><span class="pbadge live">CANLI</span><span style="margin-left:auto;font-size:9px;color:var(--t3)">EN Ä°YÄ° â–¼</span></div>
          <div class="stlist">
            <div class="strow"><span class="stag b">EN Ä°YÄ°</span><span class="sname">Mean Reversion</span><div class="sbarbg"><div class="sbarfill" style="width:76%"></div></div><span class="swr">38.1% WR</span><span class="spf g">1.66</span></div>
            <div class="strow"><span class="stag g">Ä°YÄ°</span><span class="sname">Breakout</span><div class="sbarbg"><div class="sbarfill" style="width:62%"></div></div><span class="swr">33.3% WR</span><span class="spf g">1.42</span></div>
            <div class="strow"><span class="stag g">Ä°YÄ°</span><span class="sname">Trend Following</span><div class="sbarbg"><div class="sbarfill" style="width:58%"></div></div><span class="swr">30.4% WR</span><span class="spf g">1.30</span></div>
            <div class="strow"><span class="stag m">ORTA</span><span class="sname">Scalping</span><div class="sbarbg"><div class="sbarfill" style="width:28%;background:linear-gradient(90deg,var(--orange),rgba(255,112,32,.3))"></div></div><span class="swr">15.4% WR</span><span class="spf" style="color:var(--orange)">0.70</span></div>
            <div class="strow"><span class="stag d">DÃœÅÃœK</span><span class="sname">VWAP Bounce</span><div class="sbarbg"><div class="sbarfill" style="width:22%;background:linear-gradient(90deg,var(--red),rgba(255,43,90,.3))"></div></div><span class="swr">11.1% WR</span><span class="spf r">0.70</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- POZISYONLAR TAB -->
    <div class="pcontent" id="tab-positions">
      <div style="display:flex;align-items:center;padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--b1);flex-shrink:0;gap:10px">
        <span class="pt">AÃ§Ä±k Pozisyonlar</span>
        <span id="pos-total-pnl" style="font-size:10px;font-weight:700;color:var(--t3)"></span>
        <button onclick="loadPositions()" style="margin-left:auto;height:22px;padding:0 9px;background:var(--cg);border:1px solid var(--b2);border-radius:var(--r);color:var(--cyan);font-family:var(--mono);font-size:9px;cursor:pointer">â†» Yenile</button>
      </div>
      <div class="pospane" id="positions-content">
        <div class="empty-state"><div>ğŸ“‚</div>AÃ§Ä±k pozisyon yok</div>
      </div>
    </div>

    <!-- SÄ°NYALLER TAB -->
    <div class="pcontent" id="tab-signals">
      <div class="sigpane" id="signals-content">
        <div class="empty-state"><div>ğŸ“¡</div>Sinyal bekleniyor...</div>
      </div>
    </div>

    <!-- KONTROL TAB -->
    <div class="pcontent" id="tab-control">
      <div class="ctrlpane">

        <!-- Ä°ÅŸlem Testi -->
        <div class="csect">
          <div class="csect-hdr">âœ Manuel Ä°ÅŸlem AÃ§</div>
          <div class="csect-body">
            <div class="g2">
              <div class="fg"><div class="fl">Sembol</div><input type="text" id="test-symbol" value="BTCUSDT" oninput="ctrlUpdateTestPreview()"/></div>
              <div class="fg"><div class="fl">YÃ¶n</div><select id="test-side" onchange="ctrlUpdateTestPreview()"><option value="BUY">LONG</option><option value="SELL">SHORT</option></select></div>
            </div>
            <div class="g2">
              <div class="fg"><div class="fl">Miktar (USDT)</div><input type="number" id="test-qty" value="100" oninput="ctrlUpdateTestPreview()"/></div>
              <div class="fg"><div class="fl">KaldÄ±raÃ§</div><input type="number" id="test-lev" value="3" oninput="ctrlUpdateTestPreview()"/></div>
            </div>
            <div class="g2">
              <div class="fg"><div class="fl">SL %</div><input type="number" id="test-sl" value="1.5" step="0.1" oninput="ctrlUpdateTestPreview()"/></div>
              <div class="fg"><div class="fl">TP %</div><input type="number" id="test-tp" value="3.0" step="0.1" oninput="ctrlUpdateTestPreview()"/></div>
            </div>
            <div class="fg"><div class="fl">Emir Tipi</div><select id="test-order-type"><option value="MARKET">MARKET</option><option value="LIMIT">LIMIT</option></select></div>
            <div class="prevrow" id="test-preview">â€“</div>
            <div class="trade-btns">
              <button class="btn-long" id="ctrl-btn-long" onclick="ctrlOpenTrade('BUY')">â–² LONG</button>
              <button class="btn-short" id="ctrl-btn-short" onclick="ctrlOpenTrade('SELL')">â–¼ SHORT</button>
            </div>
            <button class="btn-closeall" onclick="ctrlCloseAll()">ğŸ”´ TÃ¼m PozisyonlarÄ± Kapat</button>
          </div>
        </div>

        <!-- Risk & Bot AyarlarÄ± â€” slider style like reference image 3 -->
        <div class="csect">
          <div class="csect-hdr" style="justify-content:space-between">
            <span>âš™ Risk &amp; Bot AyarlarÄ±</span>
            <span style="font-size:8px;color:var(--cyan);cursor:pointer;letter-spacing:.06em" onclick="showToast('Ayarlar canlÄ± deÄŸiÅŸtirilebilir','info')">CANLI DEÄÄ°ÅTÄ°R</span>
          </div>
          <div class="csect-body">
            <div class="g2">
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Max Pozisyon</span><span class="slider-val" id="sv-max-pos">10</span></div>
                <input type="range" class="slider-input" id="ctrl-max-pos" min="1" max="20" value="10" oninput="document.getElementById('sv-max-pos').textContent=this.value"/>
                <div class="slider-desc">AynÄ± anda aÃ§Ä±lacak max poz sayÄ±sÄ±</div>
              </div>
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Poz BÃ¼yÃ¼klÃ¼ÄŸÃ¼ %</span><span class="slider-val" id="sv-risk-pt">5 %</span></div>
                <input type="range" class="slider-input" id="ctrl-risk-pt" min="1" max="20" value="5" oninput="document.getElementById('sv-risk-pt').textContent=this.value+' %'"/>
                <div class="slider-desc">Her trade iÃ§in bakiyenin yÃ¼zdesi</div>
              </div>
            </div>
            <div class="g2">
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Take Profit %</span><span class="slider-val" id="sv-tp">3.0 %</span></div>
                <input type="range" class="slider-input" id="ctrl-tp-pct" min="0.5" max="20" step="0.5" value="3" oninput="document.getElementById('sv-tp').textContent=parseFloat(this.value).toFixed(1)+' %'"/>
                <div class="slider-desc">KÃ¢r hedefi (kaldÄ±raÃ§la Ã§arpÄ±lÄ±r)</div>
              </div>
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Stop Loss %</span><span class="slider-val" id="sv-sl">1.5 %</span></div>
                <input type="range" class="slider-input" id="ctrl-sl-pct" min="0.2" max="10" step="0.1" value="1.5" oninput="document.getElementById('sv-sl').textContent=parseFloat(this.value).toFixed(1)+' %'"/>
                <div class="slider-desc">Zarar kes (kaldÄ±raÃ§la Ã§arpÄ±lÄ±r)</div>
              </div>
            </div>
            <!-- KaldÄ±raÃ§ buttons like reference -->
            <div class="slider-setting">
              <div class="slider-hdr"><span class="slider-label">KaldÄ±raÃ§</span></div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <button onclick="selectLev(0,this)" style="flex:1;min-width:44px;height:28px;background:var(--bg4);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700;transition:all .12s">RAST.</button>
                <button onclick="selectLev(2,this)" style="flex:1;min-width:44px;height:28px;background:var(--cg);border:1px solid var(--cyan2);border-radius:var(--r);color:var(--cyan);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700">2x</button>
                <button onclick="selectLev(3,this)" style="flex:1;min-width:44px;height:28px;background:var(--bg4);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700;transition:all .12s">3x</button>
                <button onclick="selectLev(5,this)" style="flex:1;min-width:44px;height:28px;background:var(--bg4);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700;transition:all .12s">5x</button>
                <button onclick="selectLev(10,this)" style="flex:1;min-width:44px;height:28px;background:var(--bg4);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700;transition:all .12s">10x</button>
                <button onclick="selectLev(20,this)" style="flex:1;min-width:44px;height:28px;background:var(--bg4);border:1px solid var(--b2);border-radius:var(--r);color:var(--t3);font-family:var(--mono);font-size:9px;cursor:pointer;font-weight:700;transition:all .12s">20x</button>
              </div>
            </div>
            <div class="g2">
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Min Sinyal Skoru</span><span class="slider-val" id="sv-minscore">3</span></div>
                <input type="range" class="slider-input" id="ctrl-min-score" min="1" max="10" value="3" oninput="document.getElementById('sv-minscore').textContent=this.value"/>
                <div class="slider-desc">DÃ¼ÅŸÃ¼k = daha fazla trade</div>
              </div>
              <div class="slider-setting">
                <div class="slider-hdr"><span class="slider-label">Tarama BÃ¼yÃ¼klÃ¼ÄŸÃ¼</span><span class="slider-val" id="sv-scan">12</span></div>
                <input type="range" class="slider-input" id="ctrl-scan-interval" min="1" max="50" value="12" oninput="document.getElementById('sv-scan').textContent=this.value"/>
                <div class="slider-desc">Her turda kaÃ§ coin taransÄ±n</div>
              </div>
            </div>
            <div class="g2">
              <div class="fg"><div class="fl">GÃ¼nlÃ¼k Max KayÄ±p %</div><input type="number" id="ctrl-daily-loss" value="3"/></div>
              <div class="fg"><div class="fl">Kill-Switch (Ard. KayÄ±p)</div><input type="number" id="ctrl-consec-loss" value="5"/></div>
            </div>
            <div class="fg"><div class="fl">RL Epsilon</div><input type="number" id="ctrl-epsilon" value="0.150" step="0.01"/></div>
            <div class="prevrow" id="ctrl-agent-preview">â€“</div>
            <div id="ctrl-agent-status-text" style="font-size:10px;color:var(--t3);padding:2px 0">â¹ Ajan durduruldu</div>
            <div class="g2" style="align-items:center">
              <div style="display:flex;align-items:center;gap:8px">
                <span style="font-size:9px;color:var(--t3)">Otomatik Ajan</span>
                <input type="checkbox" class="toggle" id="ctrl-agent-toggle" onchange="ctrlToggleAgent(this.checked)"/>
              </div>
              <button class="btn-apply" onclick="ctrlApplySettings()">ğŸ’¾ Kaydet</button>
            </div>
          </div>
        </div>

        <!-- Webhook -->
        <div class="csect">
          <div class="csect-hdr">ğŸ”— Webhook</div>
          <div class="csect-body">
            <div class="fg"><div class="fl">Webhook URL</div><input type="text" id="webhook-url" readonly/></div>
            <div style="display:flex;gap:7px">
              <button class="btn-apply" onclick="copyWebhookUrl()" style="flex:1">URL Kopyala</button>
              <button class="btn-apply" onclick="copyWebhookJson()" style="flex:1;background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.4);color:var(--purple)">JSON Kopyala</button>
            </div>
          </div>
        </div>

        <div class="kill-switch-banner" id="kill-switch-status">
          ğŸš¨ Kill switch aktif â€” Risk limiti aÅŸÄ±ldÄ±
        </div>

      </div>
    </div>
  </div><!-- /lpanel -->

  <!-- â•â•â•â•â•â•â•â• MIDDLE PANEL â•â•â•â•â•â•â•â• -->
  <div class="mpanel">
    <div class="trade-hdr">
      <div class="tsrow">
        <div>
          <div class="tsym" id="selected-symbol">BTCUSDT</div>
          <a class="tsymlink" onclick="openMarketModal()">Sembol seÃ§ â†’</a>
        </div>
        <div class="tprice" id="current-price">â€“</div>
      </div>
    </div>

    <div class="tform">
      <div class="fg"><div class="fl">Miktar (USDT)</div>
        <input type="number" id="qty-input" value="100" oninput="updatePnLPreview()"/>
      </div>
      <div class="frow">
        <div class="fg"><div class="fl">Emir Tipi</div>
          <select id="order-type"><option value="MARKET">Market</option><option value="LIMIT">Limit</option></select>
        </div>
        <div class="fg"><div class="fl">KaldÄ±raÃ§</div>
          <div class="lev-disp">
            <div class="lev-l">MAX <span style="color:var(--t2)" id="max-lev-label">20x</span></div>
            <div class="lev-v" id="lev-display">3x</div>
          </div>
          <input type="range" id="leverage-input" min="1" max="20" value="3" style="width:100%;margin-top:4px;height:4px;border:none"
            oninput="document.getElementById('lev-display').textContent=this.value+'x';updatePnLPreview()"/>
        </div>
      </div>
      <div class="frow">
        <div class="fg"><div class="fl">SL %</div><input type="number" id="sl-input" value="1.5" step="0.1" oninput="updatePnLPreview()"/></div>
        <div class="fg"><div class="fl">TP %</div><input type="number" id="tp-input" value="3.0" step="0.1" oninput="updatePnLPreview()"/></div>
      </div>
      <div class="maxtprow">
        <span style="color:var(--t3)">max TP</span>
        <span style="color:var(--green);font-weight:700" id="max-tp-preview">+$0.00 max TP</span>
      </div>
      <div class="pnl-prev" id="pnl-preview">â€“</div>
    </div>

    <div class="tactions">
      <button class="tbtn-l" onclick="handleLong()">â–² LONG Ä°ÅLEM AÃ‡</button>
      <button class="tbtn-s" onclick="handleShort()">â–¼ SHORT Ä°ÅLEM AÃ‡</button>
    </div>

    <div class="agent-mini">
      <div class="agent-mini-hdr">
        <span class="agent-ttl">Otomatik Ajan</span>
        <input type="checkbox" class="toggle" id="agent-toggle" onchange="ctrlToggleAgent(this.checked)"/>
      </div>
      <div class="agrid">
        <div class="acell"><div class="acell-l">Durum</div><div class="acell-v off" id="agent-status-val">Pasif</div></div>
        <div class="acell"><div class="acell-l">Ä°ÅŸlem SayÄ±sÄ±</div><div class="acell-v" id="agent-trade-count">0</div></div>
        <div class="acell"><div class="acell-l">Tarama</div><div class="acell-v" id="agent-scan-interval">15 dk</div></div>
        <div class="acell"><div class="acell-l">RL Epsilon</div><div class="acell-v y" id="agent-epsilon">â€“</div></div>
      </div>
    </div>

    <div class="mlist-sect">
      <div class="mlist-hdr">
        <span class="pt">Piyasalar</span>
        <input type="text" class="mlist-s" id="market-list-search" placeholder="Sembol ara..." oninput="filterMarketList(this.value)" style="flex:1;margin-left:8px"/>
        <span class="mlist-cnt" id="market-count-label">â€“</span>
        <span class="mlist-cnt" id="market-count2" style="display:none"></span>
      </div>
      <div class="mlist-scroll"><div id="market-list-right"></div></div>
    </div>
  </div><!-- /mpanel -->

  <!-- â•â•â•â•â•â•â•â• RIGHT PANEL â•â•â•â•â•â•â•â• -->
  <div class="rpanel">
    <div class="ftabbar">
      <button class="ftab active" onclick="switchFarTab('logs',this)">Loglar</button>
      <button class="ftab" onclick="switchFarTab('signals',this)">Sinyaller</button>
    </div>

    <!-- LOGS -->
    <div class="fcontent active" id="far-logs">
      <div class="lfrow">
        <button class="lfbtn active" onclick="setLogFilter('all',this)">TÃ¼mÃ¼</button>
        <button class="lfbtn" onclick="setLogFilter('error',this)">Hata</button>
        <button class="lfbtn" onclick="setLogFilter('warn',this)">UyarÄ±</button>
        <button class="lfbtn" onclick="setLogFilter('ok',this)">BaÅŸarÄ±</button>
        <button class="lfbtn" onclick="setLogFilter('agent',this)">Ajan</button>
        <div class="lactions">
          <button class="libtn" onclick="fetchLogs()">â†»</button>
          <button class="libtn" onclick="clearLogs()">âœ•</button>
          <label class="auto-lbl"><input type="checkbox" id="log-auto-refresh" checked/>Otomatik</label>
        </div>
      </div>
      <div class="logarea" id="log-area"></div>
    </div>

    <!-- SIGNALS -->
    <div class="fcontent" id="far-signals">
      <div class="smini">
        <div class="smcell"><div class="sml">Piyasa Rejimi</div><div class="smv" id="regime-val">â€“</div></div>
        <div class="smcell"><div class="sml">ATR</div><div class="smv" id="atr-sub">â€“</div></div>
        <div class="smcell"><div class="sml">Margin Kull.</div><div class="smv" id="margin-val2">0.0%</div></div>
        <div class="smcell"><div class="sml">Sinyal SayÄ±sÄ±</div><div class="smv" id="sig-trade-count">0</div></div>
      </div>
      <div class="spanel">
        <div class="spcard">
          <div class="pt" style="margin-bottom:8px;color:var(--t2)">Son Otomatik Sinyal</div>
          <div id="last-signal-content"><div class="empty-state"><div>ğŸ“¡</div>Sinyal bekleniyor...</div></div>
        </div>
        <div class="spcard">
          <div class="pt" style="margin-bottom:6px;color:var(--t2)">Ajan Durumu</div>
          <div id="sig-agent-status" style="font-size:10px;color:var(--t3)">â¹ Durduruldu</div>
          <div style="font-size:10px;color:var(--t3);margin-top:3px">RL Epsilon: <span id="sig-epsilon">â€“</span></div>
        </div>
        <div class="spcard">
          <div class="pt" style="margin-bottom:6px;color:var(--t2)">Risk Durumu</div>
          <div id="risk-content" style="font-size:10px;color:var(--t2)">â€“</div>
        </div>
        <div class="spcard">
          <div class="pt" style="margin-bottom:6px;color:var(--t2)">AÃ§Ä±k Pozisyonlar</div>
          <div id="overview-positions-list" style="font-size:10px;color:var(--t3)">AÃ§Ä±k pozisyon yok</div>
        </div>
        <div id="overview-positions-wrap" style="display:none"></div>
      </div>
    </div>

  </div><!-- /rpanel -->
</div><!-- /app -->

<!-- MODAL -->
<div class="modal-ov" id="market-modal">
  <div class="modal">
    <button class="modal-cls" onclick="closeMarketModal()">âœ•</button>
    <div class="modal-ttl">Sembol SeÃ§</div>
    <input type="text" id="modal-search" placeholder="BTC, ETH, SOL..." oninput="filterModal(this.value)" style="margin-bottom:10px"/>
    <div id="modal-list" style="max-height:320px;overflow-y:auto;"></div>
  </div>
</div>
<div id="toast-container"></div>


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function extractErrorMessage(response) {
  if (!response) return "Bilinmeyen hata";
  if (typeof response === "string") return response;
  if (response.reason)  return String(response.reason);
  if (response.message) return String(response.message);
  if (response.detail) {
    if (Array.isArray(response.detail))
      return response.detail.map(e => e.msg || JSON.stringify(e)).join(", ");
    return String(response.detail);
  }
  try { return JSON.stringify(response); } catch { return "Hata"; }
}

function showToast(message, type = "error") {
  const icons = { error: "âœ•", success: "âœ“", info: "â„¹", warn: "âš " };
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]||"â€¢"}</span><span class="toast-msg">${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.animation = 'fadeOut 0.4s ease forwards'; setTimeout(() => toast.remove(), 400); }, 3600);
}

async function apiFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...options,
    });
    let data;
    try { data = await res.json(); }
    catch { data = { ok: false, reason: await res.text().catch(() => "Parse error") }; }

    if (!res.ok || data?.ok === false) {
      const msg = extractErrorMessage(data);
      showToast(msg, "error");
      return { ok: false, reason: msg, _raw: data };
    }
    return { ok: true, ...data };
  } catch (err) {
    const msg = err?.message || "AÄŸ baÄŸlantÄ± hatasÄ±";
    showToast(msg, "error");
    return { ok: false, reason: msg };
  }
}

function fmt(val, decimals = 2) {
  if (val === null || val === undefined || val === "â€“") return "â€“";
  const n = parseFloat(val);
  if (isNaN(n)) return String(val);
  return n.toFixed(decimals);
}

function fmtUSD(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "â€“";
  const sign = n >= 0 ? "+" : "";
  return sign + "$" + Math.abs(n).toFixed(2);
}

function fmtPrice(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "â€“";
  if (n >= 1000) return n.toFixed(2);
  if (n >= 1)    return n.toFixed(4);
  return n.toFixed(6);
}

function colorClass(val) {
  const n = parseFloat(val);
  if (isNaN(n) || n === 0) return "";
  return n > 0 ? "green" : "red";
}

function timeAgo(isoStr) {
  if (!isoStr) return "â€“";
  try {
    const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
    if (diff < 60)   return Math.round(diff) + "s Ã¶nce";
    if (diff < 3600) return Math.round(diff/60) + "dk Ã¶nce";
    return Math.round(diff/3600) + "sa Ã¶nce";
  } catch { return "â€“"; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let state = {
  symbol: "BTCUSDT",
  price: 0,
  allSymbols: [],
  filteredSymbols: [],
  positions: [],
  signalHistory: [],
  agentRunning: false,
  marketPrices: {},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".panel-content").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
    if (tab.dataset.tab === "positions") loadPositions();
    if (tab.dataset.tab === "logs") fetchLogs();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS / OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshStatus() {
  try {
    const res = await fetch("/status/overview");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // Connection
    document.getElementById("conn-dot").className = "ldot";
    const cd2=document.getElementById("conn-dot2"); if(cd2) cd2.className="ldot";
    document.getElementById("conn-label").textContent = "ONLINE";
    const cl2=document.getElementById("conn-label2"); if(cl2) cl2.textContent="Online";

    // Helper fonksiyonlar â€” null-safe DOM gÃ¼ncelleme
    const _s = (id) => document.getElementById(id);
    const _set = (id, val) => { const el = _s(id); if (el) el.textContent = val; };

    // Header
    const bal = data.balance ?? data.wallet_balance ?? 0;
    _set("header-balance", "$" + parseFloat(bal).toFixed(2));

    // Stats â€” null-safe
    _set("balance-val", "$" + parseFloat(bal).toFixed(2));
    const pnl = data.unrealized_pnl ?? data.total_pnl ?? 0;
    const pnlEl = _s("pnl-val");
    if (pnlEl) {
      pnlEl.textContent = fmtUSD(pnl);
      pnlEl.className = "stat-val " + colorClass(pnl);
    }

    const pnlPct = bal > 0 ? (pnl / bal * 100) : 0;
    _set("pnl-pct", (pnlPct >= 0 ? "+" : "") + pnlPct.toFixed(2) + "%");

    _set("open-pos-val", data.open_positions ?? 0);
    _set("daily-trades-val", data.daily_trades ?? 0);

    const dt2 = _s("daily-trades-val2");
    if (dt2) dt2.textContent = data.daily_trades ?? 0;
    const risk = data.risk ?? {};
    const marginEl = _s("margin-val2");
    if (marginEl) marginEl.textContent = (parseFloat(risk.margin_usage_pct || data.margin_usage_pct || 0)).toFixed(1) + "%";
    const maxPosEl = _s("max-pos-sub");
    if (maxPosEl) maxPosEl.textContent = "Maks " + (risk.max_positions || 5) + " pozisyon";

    // Update header stats
    updateHeaderStats(data);

    const dailyPnl = data.daily_pnl ?? 0;
    const dailySub = _s("daily-pnl-sub");
    if (dailySub) {
      dailySub.textContent = fmtUSD(dailyPnl);
      dailySub.style.color = dailyPnl >= 0 ? "var(--green)" : "var(--red)";
    }

    // Signal engine
    const se = data.signal_engine ?? {};
    _set("signal-count-val", se.signal_count ?? 0);
    _set("agent-trade-count", se.signal_count ?? 0);
    _set("agent-scan-interval", (se.scan_interval_min ?? 15) + " dk");

    if (se.running !== undefined) {
      state.agentRunning = se.running;
      const agentToggle = _s("agent-toggle");
      if (agentToggle) agentToggle.checked = se.running;
      const agentStatusEl = _s("agent-status-val");
      if (agentStatusEl) {
        agentStatusEl.textContent = se.running ? "Aktif" : "Pasif";
        agentStatusEl.style.color = se.running ? "var(--green)" : "var(--t3)";
      }
      const ctrlToggle = _s("ctrl-agent-toggle");
      if (ctrlToggle) ctrlToggle.checked = se.running;
      const ctrlStatusText = _s("ctrl-agent-status-text");
      if (ctrlStatusText) {
        ctrlStatusText.textContent = se.running ? "âœ… Ajan Ã§alÄ±ÅŸÄ±yor" : "â¹ Ajan durduruldu";
        ctrlStatusText.style.color = se.running ? "var(--green)" : "var(--text3)";
      }
    }

    // RL agent
    const rl = data.rl_agent ?? {};
    _set("agent-epsilon", rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "â€“");

    // Sinyaller sekmesi ajan paneli gÃ¼ncelle
    const sigStatus = document.getElementById("sig-agent-status");
    if (sigStatus) {
      const isRunning = se.running ?? false;
      sigStatus.textContent = isRunning ? "âœ… Ã‡alÄ±ÅŸÄ±yor" : "â¹ Durduruldu";
      sigStatus.style.color = isRunning ? "var(--green)" : "var(--text3)";
    }
    const sigCount = document.getElementById("sig-trade-count");
    if (sigCount) sigCount.textContent = se.signal_count ?? se.trade_count ?? 0;
    const sigEps = document.getElementById("sig-epsilon");
    if (sigEps) sigEps.textContent = rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "â€“";

    // Regime
    const regime = data.regime ?? data.market_regime ?? "â€“";
    const regimeEl = _s("regime-val");
    if (regimeEl) {
      regimeEl.textContent = regime;
      regimeEl.style.color = regime === "trend" ? "var(--green)"
                           : regime === "range" ? "var(--yellow)"
                           : "var(--text)";
    }

    const atrVal = data.atr_14 ?? data.atr ?? 0;
    _set("atr-sub", "ATR: " + fmtPrice(atrVal));

    // Price
    const price = data.mark_price ?? data.last_price ?? 0;
    if (price) {
      state.price = price;
      _set("current-price", fmtPrice(price));
      updatePnLPreview();
    }

    // Last signal
    renderLastSignal(se.last_signal);

    // Risk
    renderRisk(data);

  } catch (err) {
    document.getElementById("conn-dot").className = "ldot off";
    const cd2b=document.getElementById("conn-dot2"); if(cd2b) cd2b.className="ldot off";
    document.getElementById("conn-label").textContent = "BAÄLANTI YOK";
    const cl2b=document.getElementById("conn-label2"); if(cl2b) cl2b.textContent="BaÄŸlantÄ± yok";
    addLog("Durum gÃ¼ncellenemedi: " + (err?.message || err), "warn");
  }
}

function renderLastSignal(sig) {
  const el = document.getElementById("last-signal-content");
  if (!el) return;
  if (!sig || !sig.time) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ“¡</div>Sinyal bekleniyor...</div>';
    return;
  }
  // last-signal-time opsiyonel (eski layout'ta vardÄ±)
  const timeEl = document.getElementById("last-signal-time");
  if (timeEl) timeEl.textContent = timeAgo(sig.time);

  const side = sig.side;
  const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
  const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
  const score = parseFloat(sig.score || 0);
  const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
  const fillClass = score > 0 ? "positive" : score < 0 ? "negative" : "positive";

  // Push to history
  if (sig.time && !state.signalHistory.find(s => s.time === sig.time)) {
    state.signalHistory.unshift(sig);
    if (state.signalHistory.length > 50) state.signalHistory.pop();
    renderSignalsTab();
  }

  const detailsHtml = (sig.details || []).slice(0, 5).map(d =>
    `<div class="signal-detail-row"><span>${d}</span></div>`
  ).join("");

  el.innerHTML = `
    <div class="signal-card" style="margin-bottom:0">
      <div class="signal-header">
        <div class="signal-symbol">${sig.symbol || state.symbol}</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
          <div class="signal-side ${sideClass}">${sideLabel}</div>
        </div>
      </div>
      <div class="signal-score-bar">
        <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px">
        <span>Skor: <strong style="color:var(--text)">${score >= 0 ? "+" : ""}${score.toFixed(3)}</strong></span>
        <span>GÃ¼Ã§: <strong style="color:var(--text)">${sig.strength || "â€“"}</strong></span>
      </div>
      ${detailsHtml ? `<div class="signal-details open">${detailsHtml}</div>` : ""}
    </div>`;
}

function renderSignalsTab() {
  const el = document.getElementById("signals-content");
  if (!state.signalHistory.length) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ“Š</div>Sinyal bekleniyor...</div>';
    return;
  }
  el.innerHTML = state.signalHistory.map(sig => {
    const side = sig.side;
    const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
    const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
    const score = parseFloat(sig.score || 0);
    const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
    const fillClass = score > 0 ? "positive" : "negative";
    return `
      <div class="signal-card">
        <div class="signal-header">
          <div class="signal-symbol" style="font-size:13px">${sig.symbol || "â€“"}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
            <div class="signal-side ${sideClass}">${sideLabel}</div>
          </div>
        </div>
        <div class="signal-score-bar">
          <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:10px;color:var(--text3)">Skor: ${score >= 0 ? "+" : ""}${score.toFixed(3)} Â· ${sig.strength || ""}</div>
      </div>`;
  }).join("");
}

function renderRisk(data) {
  const el = document.getElementById("risk-content");
  const risk = data.risk ?? {};
  const maxPos = risk.max_positions ?? data.max_positions ?? 5;
  const openPos = data.open_positions ?? 0;
  const margin = risk.margin_usage_pct ?? data.margin_usage_pct ?? 0;
  const marginPct = parseFloat(margin).toFixed(1);
  const marginColor = marginPct > 70 ? "var(--red)" : marginPct > 40 ? "var(--yellow)" : "var(--green)";

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="agent-info-item">
        <div class="agent-info-label">Pozisyon KullanÄ±mÄ±</div>
        <div class="agent-info-value">${openPos} / ${maxPos}</div>
      </div>
      <div class="agent-info-item">
        <div class="agent-info-label">Margin KullanÄ±mÄ±</div>
        <div class="agent-info-value" style="color:${marginColor}">${marginPct}%</div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW POZÄ°SYON Ã–ZETÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshOverviewPositions() {
  try {
    const result = await apiFetch("/execution/positions/live");
    const positions = (result.ok ? result.positions : null) || [];
    state.positions = positions;

    const list = document.getElementById("overview-positions-list");
    const wrap = document.getElementById("overview-positions-wrap");
    const _opv = document.getElementById("open-pos-val"); if (_opv) _opv.textContent = positions.length;

    if (!positions.length) {
      if (wrap) wrap.style.display = "none";
      if (list) list.innerHTML = '<div style="color:var(--text3);font-size:11px;padding:8px 0">AÃ§Ä±k pozisyon yok</div>';
      return;
    }
    if (wrap) wrap.style.display = "block";

    list.innerHTML = positions.map(pos => {
      const pnl    = parseFloat(pos.unrealized_pnl ?? 0);
      const pnlPct = parseFloat(pos.pnl_pct ?? 0);
      const isLong = (pos.side || "").toUpperCase() === "LONG";
      const sideColor = isLong ? "var(--green)" : "var(--red)";
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="color:#fff;font-weight:600">${pos.symbol}</span>
            <span style="color:${sideColor};font-size:10px;font-weight:700">${pos.side}</span>
            <span style="color:var(--yellow);font-size:10px">${pos.leverage}x</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div style="font-size:11px;color:var(--text2)">GiriÅŸ: ${fmtPrice(pos.entry_price)}</div>
              <div style="font-size:10px;color:var(--text3)">Mark: ${fmtPrice(pos.mark_price)}</div>
            </div>
            <div style="text-align:right;min-width:70px">
              <div style="font-size:13px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
              <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
            </div>
            <button onclick="closePosition('${pos.symbol}','${pos.side}')"
              style="padding:4px 8px;background:rgba(255,61,87,0.1);border:1px solid rgba(255,61,87,0.3);color:var(--red);font-family:var(--mono);font-size:10px;border-radius:4px;cursor:pointer">
              Kapat
            </button>
          </div>
        </div>`;
    }).join("");
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadPositions() {
  const el = document.getElementById("positions-content");
  el.innerHTML = '<div class="loading-text"><span class="spinner"></span> Binance\'den yÃ¼kleniyor...</div>';

  // Ã–nce canlÄ± endpoint'i dene, olmazsa eski endpoint
  let result = await apiFetch("/execution/positions/live");
  if (!result.ok) result = await apiFetch("/execution/positions");

  if (!result.ok) {
    el.innerHTML = `<div class="empty-state"><div>âš </div>${result.reason || "BaÄŸlantÄ± hatasÄ±"}</div>`;
    return;
  }

  const positions = result.positions || [];
  state.positions = positions;
  const _opv = document.getElementById("open-pos-val"); if (_opv) _opv.textContent = positions.length;

  // Toplam PNL hesapla
  const totalPnl = positions.reduce((s, p) => s + parseFloat(p.unrealized_pnl ?? 0), 0);
  const pnlEl = document.getElementById("pos-total-pnl");
  if (pnlEl) {
    pnlEl.textContent = `PNL: ${totalPnl >= 0 ? "+" : ""}$${Math.abs(totalPnl).toFixed(2)}`;
    pnlEl.style.color = totalPnl >= 0 ? "var(--green)" : "var(--red)";
  }

  if (!positions.length) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ”</div>AÃ§Ä±k pozisyon yok</div>';
    return;
  }

  el.innerHTML = positions.map(pos => {
    const pnl     = parseFloat(pos.unrealized_pnl ?? 0);
    const pnlPct  = parseFloat(pos.pnl_pct ?? 0);
    const side    = (pos.side || "â€“").toUpperCase();
    const isLong  = side === "LONG" || side === "BUY";
    const sideColor = isLong ? "var(--green)" : "var(--red)";
    const sideBg    = isLong ? "rgba(0,230,118,0.1)" : "rgba(255,61,87,0.1)";
    const liq     = parseFloat(pos.liquidation_price ?? 0);
    const margin  = parseFloat(pos.margin ?? 0);
    const notional= parseFloat(pos.notional ?? 0);

    return `
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;">
      <!-- BaÅŸlÄ±k satÄ±rÄ± -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:var(--sans);font-size:15px;font-weight:700;color:#fff">${pos.symbol || "â€“"}</span>
          <span style="background:${sideBg};color:${sideColor};border:1px solid ${sideColor}33;border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:0.05em">${side}</span>
          <span style="background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:10px;color:var(--yellow)">${pos.leverage ?? 1}x</span>
        </div>
        <div style="text-align:right">
          <div style="font-size:15px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
          <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
        </div>
      </div>

      <!-- Detay grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">GiriÅŸ</div>
          <div style="font-size:12px;color:var(--text)">${fmtPrice(pos.entry_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Mark</div>
          <div style="font-size:12px;color:var(--cyan)">${fmtPrice(pos.mark_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Liq.</div>
          <div style="font-size:12px;color:${liq > 0 ? "var(--red)" : "var(--text3)"}">${liq > 0 ? fmtPrice(liq) : "â€“"}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Miktar</div>
          <div style="font-size:12px;color:var(--text)">${fmt(pos.contracts ?? 0, 4)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Notional</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(notional, 2)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Margin</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(margin, 2)}</div>
        </div>
      </div>

      <!-- Kapat butonu -->
      <button onclick="closePosition('${pos.symbol}','${side}')"
        style="width:100%;padding:8px;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.25);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;transition:all 0.15s;font-weight:600"
        onmouseover="this.style.background='rgba(255,61,87,0.2)'"
        onmouseout="this.style.background='rgba(255,61,87,0.08)'">
        ğŸ›‘ ${pos.symbol} Pozisyonunu Kapat
      </button>
    </div>`;
  }).join("");
}

async function closePosition(symbol, side) {
  if (!confirm(`${symbol} ${side} pozisyonunu kapatmak istediÄŸinize emin misiniz?`)) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol, side }),
  });
  if (result.ok) {
    showToast(`âœ… ${symbol} pozisyonu kapatÄ±ldÄ±`, "success");
    addLog(`Pozisyon kapatÄ±ldÄ±: ${symbol} ${side}`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    const errMsg = result.reason || result.error || "Bilinmeyen hata";
    showToast(`âŒ Kapatma hatasÄ±: ${errMsg}`, "error");
    addLog(`Kapatma hatasÄ± [${symbol}]: ${errMsg}`, "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKET LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadMarketList() {
  try {
    const res = await fetch("/status/symbols");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    state.allSymbols = data.symbols || data || [];
    const cnt = state.allSymbols.length + " Ã§ift";
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = cnt;
    if (el2) el2.textContent = state.allSymbols.length;
    renderMarketList(state.allSymbols);
    renderMarketListRight(state.allSymbols);
    const _mcl = document.getElementById('market-count-label'); if(_mcl) _mcl.textContent = state.allSymbols.length;
    const _ccv = document.getElementById('coin-count-val'); if(_ccv) _ccv.textContent = state.allSymbols.length;
    renderMarketListRight(state.allSymbols);
    const cnt2 = document.getElementById('market-count-label'); if(cnt2) cnt2.textContent = state.allSymbols.length;
    renderModalList(state.allSymbols);
  } catch (err) {
    const fallback = [
      "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","DOGEUSDT",
      "ADAUSDT","AVAXUSDT","LINKUSDT","DOTUSDT","MATICUSDT","LTCUSDT",
      "ATOMUSDT","UNIUSDT","NEARUSDT","APTUSDT","ARBUSDT","OPUSDT",
    ];
    state.allSymbols = fallback;
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = fallback.length + " Ã§ift";
    if (el2) el2.textContent = fallback.length;
    renderMarketList(fallback);
    renderModalList(fallback);
  }
}

function renderMarketList(symbols) {
  // Center panel - coin grid
  const el = document.getElementById("market-list");
  if (el) {
    if (!symbols.length) {
      el.innerHTML = '<div class="loading-text">Sembol bulunamadÄ±</div>';
    } else {
      el.innerHTML = symbols.slice(0, 99).map(sym => {
        const base = String(sym).replace("USDT","").replace("BUSD","");
        const selected = sym === state.symbol ? "selected" : "";
        const chgData = state.marketPrices && state.marketPrices[sym];
        const chg = chgData ? chgData.chg : null;
        const price = chgData ? chgData.price : null;
        const chgClass = chg === null ? "" : (chg >= 0 ? "pos" : "neg");
        const chgStr = chg === null ? "" : (chg >= 0 ? "+" : "") + chg.toFixed(2) + "%";
        return `
          <div class="coin-cell ${selected}" onclick="selectSymbol('${sym}')">
            <div class="coin-sym">${base}</div>
            <div class="coin-price">${price ? fmtPrice(price) : ""}</div>
            <div class="coin-chg ${chgClass}">${chgStr}</div>
          </div>`;
      }).join("");
    }
  }
  // Right panel - market list
  const el2 = document.getElementById("market-list-right");
  if (el2) {
    el2.innerHTML = symbols.slice(0, 100).map(sym => {
      const base = String(sym).replace("USDT","").replace("BUSD","");
      return `
        <div class="market-item" onclick="selectSymbol('${sym}')">
          <div class="market-sym">${base}<span style="color:var(--text3)">/USDT</span></div>
          <button class="market-add-btn" onclick="event.stopPropagation();selectSymbol('${sym}')">+ Ä°ÅŸlem</button>
        </div>`;
    }).join("");
  }
}

function renderModalList(symbols) {
  const el = document.getElementById("modal-list");
  el.innerHTML = symbols.slice(0, 200).map(sym => {
    const base = String(sym).replace("USDT", "").replace("BUSD", "");
    return `
      <div class="market-item" onclick="selectSymbol('${sym}');closeMarketModal()" style="padding:10px 12px">
        <div class="market-sym">${base}<span>/USDT</span></div>
        <div style="font-size:10px;color:var(--text3)">${sym}</div>
      </div>`;
  }).join("");
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

function filterModal(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderModalList(filtered);
}

function selectSymbol(sym) {
  state.symbol = sym;
  document.getElementById("selected-symbol").textContent = sym;
  document.getElementById("current-price").textContent = "â€“";
  renderMarketList(state.allSymbols.filter(s =>
    s.toLowerCase().includes(document.getElementById("market-search-input").value.toLowerCase())
  ));
  // Fiyat gÃ¼ncelle
  fetchSymbolPrice(sym);
  addLog(`Sembol deÄŸiÅŸtirildi: ${sym}`, "info");
}

async function fetchSymbolPrice(sym) {
  try {
    const res = await fetch(`/status/price?symbol=${sym}`);
    if (!res.ok) return;
    const data = await res.json();
    const price = data.price ?? data.mark_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  P&L PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updatePnLPreview() {
  const qty = parseFloat(document.getElementById("qty-input").value) || 100;
  const tp = parseFloat(document.getElementById("tp-input").value) || 3;
  const lev = parseFloat(document.getElementById("leverage-input").value) || 3;
  const maxPnl = qty * (tp / 100);
  const el = document.getElementById("pnl-preview");
  el.textContent = "+" + "$" + maxPnl.toFixed(2) + " max TP";
}

["qty-input","tp-input","leverage-input","sl-input"].forEach(id => {
  document.getElementById(id)?.addEventListener("input", updatePnLPreview);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADE ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handleLong() {
  await submitTrade("BUY");
}
async function handleShort() {
  await submitTrade("SELL");
}

async function submitTrade(side) {
  const symbol    = state.symbol;
  const qty       = parseFloat(document.getElementById("qty-input").value) || 100;
  const leverage  = parseInt(document.getElementById("leverage-input").value) || 3;
  const orderType = document.getElementById("order-type").value;
  const slPct     = parseFloat(document.getElementById("sl-input").value) || 1.5;
  const tpPct     = parseFloat(document.getElementById("tp-input").value) || 3.0;

  const btnId = side === "BUY" ? "btn-long" : "btn-short";
  const btn = document.getElementById(btnId);
  const origHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> Ä°ÅŸleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({
      symbol,
      side,
      quantity: qty,
      leverage,
      order_type: orderType,
      sl_pct: slPct,
      tp_pct: tpPct,
      strategy_tag: "manual",
    }),
  });

  btn.disabled = false;
  btn.innerHTML = origHtml;

  if (result.ok) {
    const sideLabel = side === "BUY" ? "LONG" : "SHORT";
    showToast(`âœ… ${sideLabel} iÅŸlem aÃ§Ä±ldÄ±: ${symbol}`, "success");
    addLog(`Ä°ÅŸlem aÃ§Ä±ldÄ±: ${symbol} ${sideLabel} ${qty} USDT`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    addLog(`Ä°ÅŸlem reddedildi: ${result.reason}`, "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONTROL PANELÄ° â€” Ä°ÅŸlem Testi
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ctrlUpdateTestPreview() {
  const sym  = document.getElementById("test-symbol").value || "BTCUSDT";
  const side = document.getElementById("test-side").value;
  const qty  = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev  = parseFloat(document.getElementById("test-lev").value) || 3;
  const sl   = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const tp   = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const maxGain = (qty * tp / 100).toFixed(2);
  const maxLoss = (qty * sl / 100).toFixed(2);
  const sideLabel = side === "BUY" ? "ğŸŸ¢ LONG" : "ğŸ”´ SHORT";
  document.getElementById("test-preview").innerHTML =
    `<span style="color:#fff">${sym}</span> ${sideLabel} &nbsp;|&nbsp; ` +
    `Miktar: <span style="color:var(--cyan)">$${qty}</span> &nbsp;|&nbsp; ` +
    `KaldÄ±raÃ§: <span style="color:var(--yellow)">${lev}x</span><br>` +
    `Max KÃ¢r: <span style="color:var(--green)">+$${maxGain}</span> &nbsp;|&nbsp; ` +
    `Max KayÄ±p: <span style="color:var(--red)">-$${maxLoss}</span> &nbsp;|&nbsp; ` +
    `SL: ${sl}% / TP: ${tp}%`;
}

["test-symbol","test-side","test-qty","test-lev","test-sl","test-tp","test-order-type"].forEach(id => {
  document.getElementById(id)?.addEventListener("input",  ctrlUpdateTestPreview);
  document.getElementById(id)?.addEventListener("change", ctrlUpdateTestPreview);
});

async function ctrlOpenTrade(forceSide) {
  const side   = forceSide || document.getElementById("test-side").value;
  const symbol = document.getElementById("test-symbol").value.trim().toUpperCase() || "BTCUSDT";
  const qty    = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev    = parseInt(document.getElementById("test-lev").value) || 3;
  const tp     = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const sl     = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const otype  = document.getElementById("test-order-type").value;

  const btnId = side === "BUY" ? "ctrl-btn-long" : "ctrl-btn-short";
  const btn = document.getElementById(btnId);
  const orig = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = `<span class="spinner"></span> Ä°ÅŸleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({ symbol, side, quantity: qty, leverage: lev,
      order_type: otype, sl_pct: sl, tp_pct: tp, strategy_tag: "manual_test" }),
  });

  btn.disabled = false; btn.innerHTML = orig;

  const el = document.getElementById("test-result");
  el.style.display = "block";
  if (result.ok) {
    el.style.cssText = "display:block;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--green);margin-top:10px";
    el.innerHTML = `âœ… Ä°ÅŸlem aÃ§Ä±ldÄ±: <strong>${symbol}</strong> ${side === "BUY" ? "LONG" : "SHORT"} $${qty} â€” ${new Date().toLocaleTimeString("tr-TR")}`;
    showToast(`âœ… ${symbol} ${side === "BUY" ? "LONG" : "SHORT"} aÃ§Ä±ldÄ±`, "success");
    addLog(`TEST iÅŸlemi aÃ§Ä±ldÄ±: ${symbol} ${side} $${qty} ${lev}x`, "ok");
    await loadPositions(); await refreshStatus();
  } else {
    el.style.cssText = "display:block;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--red);margin-top:10px";
    el.innerHTML = `âŒ Hata: ${result.reason || "Bilinmeyen hata"}`;
    addLog(`TEST iÅŸlemi reddedildi: ${result.reason}`, "error");
  }
}

async function ctrlCloseAll() {
  if (!confirm("TÃ¼m aÃ§Ä±k pozisyonlarÄ± kapatmak istediÄŸinize emin misiniz?")) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol: "ALL" }),
  });
  if (result.ok) {
    showToast("âœ… TÃ¼m pozisyonlar kapatÄ±ldÄ±", "success");
    addLog("TÃ¼m pozisyonlar manuel kapatÄ±ldÄ±", "warn");
    await loadPositions(); await refreshStatus();
  } else {
    showToast("âŒ Kapatma hatasÄ±: " + (result.reason || "?"), "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONTROL PANELÄ° â€” Ajan AyarlarÄ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ctrlUpdateAgentPreview() {
  const scan    = document.getElementById("ctrl-scan-interval").value;
  const eps     = document.getElementById("ctrl-epsilon").value;
  const minScore= document.getElementById("ctrl-min-score").value;
  const maxPos  = document.getElementById("ctrl-max-pos").value;
  const dayLoss = document.getElementById("ctrl-daily-loss").value;
  const drawdown= document.getElementById("ctrl-max-drawdown").value;
  const rpt     = document.getElementById("ctrl-risk-per-trade").value;
  const conLoss = document.getElementById("ctrl-consec-loss").value;
  document.getElementById("ctrl-agent-preview").innerHTML =
    `Tarama: <span style="color:var(--cyan)">${scan} dk</span> &nbsp;|&nbsp; ` +
    `Epsilon: <span style="color:var(--yellow)">${eps}</span> &nbsp;|&nbsp; ` +
    `Min Skor: <span style="color:var(--cyan)">${minScore}</span><br>` +
    `Max Poz: <span style="color:var(--cyan)">${maxPos}</span> &nbsp;|&nbsp; ` +
    `GÃ¼nlÃ¼k KayÄ±p: <span style="color:var(--red)">${dayLoss}%</span> &nbsp;|&nbsp; ` +
    `Drawdown: <span style="color:var(--red)">${drawdown}%</span><br>` +
    `Risk/Ä°ÅŸlem: <span style="color:var(--green)">${rpt}%</span> &nbsp;|&nbsp; ` +
    `Ard. KayÄ±p: <span style="color:var(--yellow)">${conLoss}</span>`;
}

async function ctrlToggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const statusEl = document.getElementById("ctrl-agent-status-text");
  if (result.ok !== false) {
    state.agentRunning = enabled;
    statusEl.textContent = enabled ? "âœ… Ajan Ã§alÄ±ÅŸÄ±yor" : "â¹ Ajan durduruldu";
    statusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    // Ana panel toggle da gÃ¼ncelle
    const mainToggle = document.getElementById("agent-toggle");
    if (mainToggle) mainToggle.checked = enabled;
    showToast(enabled ? "ğŸ¤– Ajan aktifleÅŸtirildi" : "â¹ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Ajan baÅŸlatÄ±ldÄ± (kontrol panelinden)" : "Ajan durduruldu (kontrol panelinden)", enabled ? "ok" : "warn");
  }
}

async function ctrlApplyAgentSettings() {
  const settings = {
    scan_interval_min: parseInt(document.getElementById("ctrl-scan-interval").value),
    rl_epsilon:        parseFloat(document.getElementById("ctrl-epsilon").value),
    min_signal_score:  parseFloat(document.getElementById("ctrl-min-score").value),
    max_positions:     parseInt(document.getElementById("ctrl-max-pos").value),
    daily_max_loss_pct:parseFloat(document.getElementById("ctrl-daily-loss").value),
    max_drawdown_pct:  parseFloat(document.getElementById("ctrl-max-drawdown").value),
    risk_per_trade_pct:parseFloat(document.getElementById("ctrl-risk-per-trade").value),
    kill_switch_consecutive_loss: parseInt(document.getElementById("ctrl-consec-loss").value),
  };

  // /status/agent endpoint'ine settings gÃ¶nder
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: state.agentRunning, settings }),
  });

  if (result.ok !== false) {
    showToast("ğŸ’¾ Ajan ayarlarÄ± uygulandÄ±", "success");
    addLog(`Ajan ayarlarÄ± gÃ¼ncellendi: scan=${settings.scan_interval_min}dk eps=${settings.rl_epsilon}`, "ok");
  } else {
    showToast("âš  Ayarlar uygulanamadÄ±: " + (result.reason || "?"), "warn");
  }
}

async function ctrlKillSwitch(activate) {
  const action = activate ? "aktifleÅŸtir" : "devre dÄ±ÅŸÄ± bÄ±rak";
  if (!confirm(`Kill switch'i ${action}mak istediÄŸinize emin misiniz?`)) return;

  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: !activate, kill_switch: activate }),
  });

  const el = document.getElementById("kill-switch-status");
  if (activate) {
    el.style.color = "var(--red)";
    el.textContent = "ğŸ”´ Kill Switch AKTÄ°F â€” Bot tÃ¼m iÅŸlemleri durdurdu";
    showToast("ğŸ”´ Kill Switch aktifleÅŸtirildi!", "error");
    addLog("KILL SWITCH AKTÄ°F â€” tÃ¼m iÅŸlemler durduruldu", "error");
    // Ajan toggle'Ä± kapat
    document.getElementById("ctrl-agent-toggle").checked = false;
    document.getElementById("ctrl-agent-status-text").textContent = "ğŸ”´ Kill switch aktif";
    document.getElementById("ctrl-agent-status-text").style.color = "var(--red)";
  } else {
    el.style.color = "var(--green)";
    el.textContent = "ğŸŸ¢ Kill Switch devre dÄ±ÅŸÄ± â€” Bot normal Ã§alÄ±ÅŸmaya devam edebilir";
    showToast("ğŸŸ¢ Kill Switch devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±", "success");
    addLog("Kill switch devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ± (manuel)", "warn");
  }
}

// Kontrol sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda preview gÃ¼ncelle
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.dataset.tab === "control") {
      ctrlUpdateTestPreview();
      ctrlUpdateAgentPreview();
    }
  });
});

function copyWebhookUrl() {
  const url = document.getElementById("webhook-url").textContent;
  navigator.clipboard.writeText(url).then(() => showToast("ğŸ“‹ URL kopyalandÄ±", "success"));
}

function copyWebhookJson() {
  const json = `{\n  "symbol": "BTCUSDT",\n  "side": "BUY",\n  "timeframe": "1h",\n  "strategy_tag": "ema_cross",\n  "secret": "tv-secret"\n}`;
  navigator.clipboard.writeText(json).then(() => showToast("ğŸ“‹ JSON kopyalandÄ±", "success"));
}

// AGENT TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function toggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const agentStatusEl = document.getElementById("agent-status-val");
  if (result.ok || true) { // optimistic
    state.agentRunning = enabled;
    agentStatusEl.textContent = enabled ? "Aktif" : "Pasif";
    agentStatusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    showToast(enabled ? "ğŸ¤– Otomatik ajan aktifleÅŸtirildi" : "â¹ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Otomatik ajan baÅŸlatÄ±ldÄ±" : "Otomatik ajan durduruldu", enabled ? "ok" : "warn");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMarketModal() {
  document.getElementById("market-modal").classList.add("open");
  document.getElementById("modal-search").focus();
}
function closeMarketModal() {
  document.getElementById("market-modal").classList.remove("open");
}
document.getElementById("market-modal").addEventListener("click", e => {
  if (e.target === document.getElementById("market-modal")) closeMarketModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _logKeys = new Set();  // dedup: "time|msg"

function addLog(message, type = "info", time = null) {
  const el = document.getElementById("log-area");
  if (!el) return;
  const ts = time || new Date().toTimeString().slice(0, 8);
  const key = ts + "|" + message;
  if (_logKeys.has(key)) return;  // duplicate Ã¶nle
  _logKeys.add(key);
  if (_logKeys.size > 500) {
    const oldest = _logKeys.values().next().value;
    _logKeys.delete(oldest);
  }
  const line = document.createElement("div");
  line.className = `log-line ${type}`;
  line.innerHTML = `<span class="log-time">${ts}</span>${escHtml(message)}`;
  // En yeni Ã¼stte gÃ¶ster
  if (el.firstChild) {
    el.insertBefore(line, el.firstChild);
  } else {
    el.appendChild(line);
  }
  while (el.children.length > 300) el.removeChild(el.lastChild);
  // Scroll sadece kullanÄ±cÄ± zaten en Ã¼stteyse
  if (el.scrollTop < 30) el.scrollTop = 0;
}

function escHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

let _logFilter = "all";

function setLogFilter(level, btn) {
  _logFilter = level;
  document.querySelectorAll(".log-filter-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  applyLogFilter();
}

function applyLogFilter() {
  const el = document.getElementById("log-area");
  if (!el) return;
  el.querySelectorAll(".log-line").forEach(line => {
    if (_logFilter === "all") {
      line.style.display = "";
    } else if (_logFilter === "agent") {
      line.style.display = (line.textContent.includes("ğŸ¤–") || line.textContent.includes("RL") || line.textContent.includes("Sinyal") || line.textContent.includes("Ä°ÅŸlem aÃ§")) ? "" : "none";
    } else {
      line.style.display = line.classList.contains(_logFilter) ? "" : "none";
    }
  });
}

let _lastLogTotal = -1;

async function fetchLogs() {
  try {
    const res = await fetch("/status/logs?limit=200");
    if (!res.ok) return;
    const data = await res.json();
    const logs = (data.logs || data || []);
    
    // EÄŸer yeni log yoksa hiÃ§bir ÅŸey yapma (flicker Ã¶nle)
    if (data.total !== undefined && data.total === _lastLogTotal && logs.length > 0) return;
    _lastLogTotal = data.total || logs.length;

    // Yeni loglarÄ± ekle (en yeni Ã¶nce geliyor, dedup ile Ã§ift ekleme olmaz)
    logs.forEach(entry => {
      let msg, lvl, time;
      if (typeof entry === "string") {
        msg = entry; lvl = "info"; time = null;
      } else {
        msg = entry.message || entry.msg || JSON.stringify(entry);
        time = entry.time || null;
        const lv = (entry.level || "").toUpperCase();
        lvl = lv === "ERROR" ? "error" 
            : lv === "WARNING" ? "warn"
            : (msg.includes("âœ…") || msg.includes("aÃ§Ä±ldÄ±") || msg.includes("hazÄ±r") || msg.includes("Emir:")) ? "ok" 
            : "info";
      }
      addLog(msg, lvl, time);
    });
    applyLogFilter();
  } catch(e) {
    // sessiz hata
  }
}

function clearLogs() {
  const el = document.getElementById("log-area");
  if (el) el.innerHTML = "";
  _logKeys.clear();
  _lastLogTotal = -1;
  addLog("Loglar temizlendi", "info");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT & POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchFarTab(tab, el) {
  document.querySelectorAll(".far-tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".far-panel").forEach(p => p.classList.remove("active"));
  el.classList.add("active");
  const panel = document.getElementById("far-panel-" + tab);
  if (panel) panel.classList.add("active");
}

let _sortMode = "pct";
function sortMarket(mode) {
  _sortMode = mode;
  document.querySelectorAll(".sort-btn").forEach(b => {
    b.classList.toggle("active", b.getAttribute("onclick").includes(mode));
  });
  // Re-render with current list
  renderMarketList(state.allSymbols);
    renderMarketListRight(state.allSymbols);
    const _mcl = document.getElementById('market-count-label'); if(_mcl) _mcl.textContent = state.allSymbols.length;
    const _ccv = document.getElementById('coin-count-val'); if(_ccv) _ccv.textContent = state.allSymbols.length;
    renderMarketListRight(state.allSymbols);
    const cnt2 = document.getElementById('market-count-label'); if(cnt2) cnt2.textContent = state.allSymbols.length;
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

// Update header stats from overview data

function filterMarketList(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketListRight(filtered);
}

function renderMarketListRight(symbols) {
  const el = document.getElementById("market-list-right");
  if (!el) return;
  const list = (symbols || state.allSymbols).slice(0, 200);
  el.innerHTML = list.map(sym => {
    const selected = sym === state.symbol ? "selected" : "";
    return `<div class="market-item ${selected}" onclick="selectSymbol('${sym}')">
      <span class="market-item-sym">${sym.replace('USDT','')}</span>
      <span class="market-item-quote">/USDT</span>
    </div>`;
  }).join("");
}

function updateHeaderStats(data) {
  const bal = parseFloat(data.balance || data.wallet_balance || 0);
  const pnl = parseFloat(data.unrealized_pnl || 0);
  const se = data.signal_engine || {};
  const hb = document.getElementById("header-balance");
  const hp = document.getElementById("header-pnl");
  if (hb) hb.textContent = "$" + bal.toFixed(2);
  if (hp) {
    hp.textContent = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
    hp.style.color = pnl >= 0 ? "var(--green)" : "var(--red)";
  }
  // Update balance-val in stats bar
  const bv = document.getElementById("balance-val");
  if (bv) bv.textContent = "$" + bal.toFixed(2);
  // Update agent header btn
  const aBtn = document.getElementById("header-agent-btn");
  if (aBtn && se.running !== undefined) {
    aBtn.textContent = se.running ? "â–  DURDUR AJAN" : "â–¶ BAÅLAT";
    aBtn.className = se.running ? "btn-stop" : "btn-start";
    aBtn.onclick = se.running ? () => toggleAgent(false) : () => toggleAgent(true);
  }
}

async function init() {
  addLog("Dashboard baÅŸlatÄ±lÄ±yor...", "info");
  await Promise.all([
    refreshStatus(),
    loadPositions(),
    loadMarketList(),
    refreshOverviewPositions(),
    fetchLogs(),
  ]);
  addLog("Dashboard hazÄ±r âœ“", "ok");
  updatePnLPreview();
  ctrlUpdateTestPreview();
  ctrlUpdateAgentPreview();
}

// Poll every 10s
// â”€â”€â”€ Anti-flicker: sadece bir poll aynÄ± anda Ã§alÄ±ÅŸsÄ±n â”€â”€â”€â”€â”€â”€â”€
let _polling = false;
setInterval(async () => {
  if (_polling) return;
  _polling = true;
  try {
    await refreshStatus();
    await refreshOverviewPositions();
    if (document.querySelector(".tab[data-tab='positions'].active")) {
      await loadPositions();
    }
  } finally {
    _polling = false;
  }
}, 8000);

// Loglar ayrÄ± interval (daha sÄ±k ama hafif)
setInterval(async () => {
  const autoRefresh = document.getElementById("log-auto-refresh");
  if (!autoRefresh || autoRefresh.checked) await fetchLogs();
}, 4000);

// Price poll for selected symbol every 6s
setInterval(() => fetchSymbolPrice(state.symbol), 6000);

init();

// Alias for settings button
async function ctrlApplySettings() {
  return await ctrlApplyAgentSettings();
}

// â”€â”€ Extra helper functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setInterval2(iv, btn) {
  document.querySelectorAll('.ivbtn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function selectLev(val, btn) {
  document.querySelectorAll('.csect-body button[onclick^="selectLev"]').forEach(b => {
    b.style.background='var(--bg4)'; b.style.borderColor='var(--b2)'; b.style.color='var(--t3)';
  });
  if (btn) { btn.style.background='var(--cg)'; btn.style.borderColor='var(--cyan2)'; btn.style.color='var(--cyan)'; }
  const levEl = document.getElementById('leverage-input');
  if (levEl && val > 0) { levEl.value = val; document.getElementById('lev-display').textContent = val + 'x'; updatePnLPreview(); }
}

function filterMarketList(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketListRight(filtered);
}

function renderMarketListRight(symbols) {
  const el = document.getElementById("market-list-right");
  if (!el) return;
  const list = (symbols || state.allSymbols).slice(0, 300);
  el.innerHTML = list.map(sym => {
    const sel = sym === state.symbol ? "sel" : "";
    return `<div class="mi ${sel}" onclick="selectSymbol('${sym}')">
      <span class="mi-sym">${sym.replace('USDT','').replace(':USDT','')}</span>
      <span class="mi-q">/USDT</span>
    </div>`;
  }).join("");
}

function switchFarTab(name, btn) {
  document.querySelectorAll('.ftab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.fcontent').forEach(c => c.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const el = document.getElementById('far-' + name);
  if (el) el.classList.add('active');
}

function ctrlApplySettings() {
  return ctrlApplyAgentSettings();
}

function updateHeaderStats(data) {}

</script>




</body>
</html>