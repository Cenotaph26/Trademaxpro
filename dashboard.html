<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trademaxpro ‚Äî Futures Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #0a0c0f;
    --bg2:       #0f1318;
    --bg3:       #141920;
    --bg4:       #1a2030;
    --border:    #1e2a38;
    --border2:   #253040;
    --text:      #c8d8e8;
    --text2:     #6a8aaa;
    --text3:     #3a5070;
    --green:     #00e676;
    --green2:    #00c853;
    --red:       #ff3d57;
    --red2:      #c62828;
    --cyan:      #00bcd4;
    --yellow:    #ffd740;
    --orange:    #ff6d00;
    --accent:    #0d47a1;
    --radius:    8px;
    --mono:      'JetBrains Mono', monospace;
    --sans:      'Syne', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg2); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--sans);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .logo span { color: var(--green); }

  .header-status {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .status-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text2);
  }
  .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
    animation: pulse 2s infinite;
  }
  .dot.online { background: var(--green); }
  .dot.offline { background: var(--red); animation: none; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .header-balance {
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 600;
    color: var(--green);
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  .layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 49px);
  }

  /* ‚îÄ‚îÄ Left Panel ‚îÄ‚îÄ */
  .left-panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
    padding: 0 16px;
  }
  .tab {
    padding: 10px 14px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }

  /* ‚îÄ‚îÄ Panel Content ‚îÄ‚îÄ */
  .panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: none;
  }
  .panel-content.active { display: block; }

  /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
  .card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-bottom: 10px;
  }
  .card-title {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 10px;
  }
  .stat-box {
    background: var(--bg4);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 12px;
  }
  .stat-label {
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 4px;
  }
  .stat-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    font-family: var(--sans);
  }
  .stat-value.green { color: var(--green); }
  .stat-value.red   { color: var(--red); }
  .stat-value.cyan  { color: var(--cyan); }
  .stat-sub {
    font-size: 10px;
    color: var(--text3);
    margin-top: 2px;
  }

  /* ‚îÄ‚îÄ Signal Card ‚îÄ‚îÄ */
  .signal-card {
    background: var(--bg4);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .signal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .signal-symbol {
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 600;
    color: #fff;
  }
  .signal-side {
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    letter-spacing: 0.05em;
  }
  .signal-side.buy  { background: rgba(0,230,118,0.15); color: var(--green); }
  .signal-side.sell { background: rgba(255,61,87,0.15);  color: var(--red); }
  .signal-side.none { background: rgba(106,138,170,0.15); color: var(--text2); }

  .signal-score-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
  }
  .signal-score-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }
  .signal-score-fill.positive { background: var(--green); }
  .signal-score-fill.negative { background: var(--red); }

  .signal-details {
    display: none;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .signal-details.open { display: block; }
  .signal-detail-row {
    font-size: 10px;
    color: var(--text2);
    padding: 2px 0;
    display: flex;
    justify-content: space-between;
  }

  /* ‚îÄ‚îÄ Positions Table ‚îÄ‚îÄ */
  .pos-table { width: 100%; border-collapse: collapse; }
  .pos-table th {
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    text-align: left;
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
  }
  .pos-table td {
    padding: 8px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--text2);
  }
  .pos-table tr:last-child td { border-bottom: none; }
  .pos-table tr:hover td { background: var(--bg4); }
  .pos-symbol-td { color: #fff !important; font-weight: 500; }
  .pnl-pos { color: var(--green) !important; }
  .pnl-neg { color: var(--red)   !important; }

  .close-pos-btn {
    background: rgba(255,61,87,0.1);
    border: 1px solid rgba(255,61,87,0.3);
    color: var(--red);
    font-size: 10px;
    font-family: var(--mono);
    padding: 3px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .close-pos-btn:hover {
    background: rgba(255,61,87,0.25);
  }

  .empty-state {
    text-align: center;
    padding: 32px 16px;
    color: var(--text3);
    font-size: 12px;
  }
  .empty-state div { margin-bottom: 6px; font-size: 24px; }

  /* ‚îÄ‚îÄ Log Panel ‚îÄ‚îÄ */
  .log-area {
    background: #080a0d;
    border-radius: 6px;
    padding: 10px 12px;
    height: 320px;
    overflow-y: auto;
    font-size: 11px;
    line-height: 1.6;
  }
  .log-line { padding: 1px 0; }
  .log-line.info  { color: var(--text2); }
  .log-line.ok    { color: var(--green); }
  .log-line.warn  { color: var(--yellow); }
  .log-line.error { color: var(--red); }
  .log-time { color: var(--text3); margin-right: 8px; }

  /* ‚îÄ‚îÄ Right Panel ‚îÄ‚îÄ */
  .right-panel {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    background: var(--bg2);
  }

  /* ‚îÄ‚îÄ Trade Form ‚îÄ‚îÄ */
  .trade-form {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
  }

  .form-title {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 12px;
  }

  .symbol-display {
    background: var(--bg4);
    border: 1px solid var(--border2);
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.15s;
  }
  .symbol-display:hover { border-color: var(--cyan); }
  .symbol-name {
    font-family: var(--sans);
    font-size: 16px;
    font-weight: 700;
    color: #fff;
  }
  .symbol-price {
    font-size: 14px;
    font-weight: 500;
    color: var(--green);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
  }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-label {
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
  }

  input, select {
    background: var(--bg4);
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    padding: 8px 10px;
    width: 100%;
    outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  input:focus, select:focus { border-color: var(--cyan); }
  input[type=number]::-webkit-inner-spin-button { opacity: 0.3; }

  .qty-input-wrap {
    position: relative;
    margin-bottom: 8px;
  }
  .qty-label-abs {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: var(--text3);
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn-long {
    width: 100%;
    padding: 13px;
    background: var(--green);
    color: #000;
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 800;
    letter-spacing: 0.05em;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    margin-bottom: 8px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .btn-long:hover { background: #00ff88; transform: translateY(-1px); }
  .btn-long:active { transform: translateY(0); }
  .btn-long:disabled { background: var(--border); color: var(--text3); cursor: not-allowed; transform: none; }

  .btn-short {
    width: 100%;
    padding: 13px;
    background: var(--red);
    color: #fff;
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 800;
    letter-spacing: 0.05em;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .btn-short:hover { background: #ff5555; transform: translateY(-1px); }
  .btn-short:active { transform: translateY(0); }
  .btn-short:disabled { background: var(--border); color: var(--text3); cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: var(--bg4);
    border: 1px solid var(--border2);
    color: var(--text2);
    font-family: var(--mono);
    font-size: 11px;
    padding: 7px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn-secondary:hover { border-color: var(--cyan); color: var(--cyan); }

  /* ‚îÄ‚îÄ Futures Market ‚îÄ‚îÄ */
  .market-section {
    flex: 1;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .market-header {
    padding: 12px 16px 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .market-title {
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
  }
  .market-count {
    background: var(--bg4);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2px 10px;
    font-size: 10px;
    color: var(--text2);
  }
  .market-search {
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
  }
  .market-search input {
    background: var(--bg4);
    border-color: var(--border);
    font-size: 12px;
    padding: 7px 10px;
  }
  .market-list {
    flex: 1;
    overflow-y: auto;
    max-height: 280px;
  }
  .market-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }
  .market-item:hover { background: var(--bg3); }
  .market-item.selected { background: rgba(0,188,212,0.08); border-right: 2px solid var(--cyan); }
  .market-sym {
    font-weight: 500;
    color: #fff;
    font-size: 12px;
  }
  .market-sym span { color: var(--text3); font-weight: 400; font-size: 11px; }
  .market-add-btn {
    background: rgba(0,188,212,0.1);
    border: 1px solid rgba(0,188,212,0.25);
    color: var(--cyan);
    font-size: 10px;
    font-family: var(--mono);
    padding: 3px 9px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .market-add-btn:hover { background: rgba(0,188,212,0.2); }

  /* ‚îÄ‚îÄ Agent Status Panel ‚îÄ‚îÄ */
  .agent-section {
    border-top: 1px solid var(--border);
    padding: 12px 16px;
  }

  .agent-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .toggle-switch {
    position: relative;
    width: 36px; height: 20px;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--bg4);
    border: 1px solid var(--border2);
    border-radius: 20px;
    cursor: pointer;
    transition: 0.2s;
  }
  .toggle-slider:before {
    content: '';
    position: absolute;
    width: 14px; height: 14px;
    left: 2px; top: 2px;
    background: var(--text3);
    border-radius: 50%;
    transition: 0.2s;
  }
  input:checked + .toggle-slider { background: rgba(0,230,118,0.2); border-color: var(--green); }
  input:checked + .toggle-slider:before { transform: translateX(16px); background: var(--green); }

  .agent-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  .agent-info-item {
    background: var(--bg4);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
  }
  .agent-info-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text3);
    margin-bottom: 3px;
  }
  .agent-info-value {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ */
  #toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
  }
  .toast {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-family: var(--mono);
    pointer-events: auto;
    animation: slideIn 0.25s ease, fadeOut 0.4s ease 3.6s forwards;
    min-width: 240px;
    max-width: 360px;
    border: 1px solid;
    backdrop-filter: blur(8px);
  }
  .toast.error   { background: rgba(255,61,87,0.12);  border-color: rgba(255,61,87,0.4);  color: #ff7070; }
  .toast.success { background: rgba(0,230,118,0.12); border-color: rgba(0,230,118,0.4); color: #00e676; }
  .toast.info    { background: rgba(0,188,212,0.12);  border-color: rgba(0,188,212,0.4);  color: #00bcd4; }
  .toast.warn    { background: rgba(255,215,64,0.12); border-color: rgba(255,215,64,0.4); color: #ffd740; }
  .toast-icon { font-size: 14px; flex-shrink: 0; }
  .toast-msg { flex: 1; word-break: break-word; }

  @keyframes slideIn {
    from { transform: translateX(20px); opacity: 0; }
    to   { transform: translateX(0);    opacity: 1; }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to   { opacity: 0; transform: translateX(10px); }
  }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 500;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 20px;
    width: 360px;
    max-width: 90vw;
  }
  .modal-title {
    font-family: var(--sans);
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 14px;
    color: #fff;
  }
  .modal-close {
    float: right;
    background: none;
    border: none;
    color: var(--text2);
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
  }

  /* ‚îÄ‚îÄ Loader ‚îÄ‚îÄ */
  .spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.15);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { color: var(--text3); font-size: 12px; padding: 20px; text-align: center; }

  /* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
  .badge {
    display: inline-block;
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    letter-spacing: 0.05em;
  }
  .badge.trend  { background: rgba(0,230,118,0.15); color: var(--green); }
  .badge.range  { background: rgba(255,215,64,0.15); color: var(--yellow); }
  .badge.volatile { background: rgba(255,61,87,0.15); color: var(--red); }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .layout { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
    .left-panel { border-right: none; border-bottom: 1px solid var(--border); }
    .right-panel { max-height: 60vh; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<header>
  <div class="logo">TRADEMAX<span>PRO</span></div>
  <div class="header-status">
    <div class="status-dot">
      <div class="dot offline" id="conn-dot"></div>
      <span id="conn-label">Baƒülanƒ±yor...</span>
    </div>
    <div class="header-balance" id="header-balance">$0.00</div>
  </div>
</header>

<div class="layout">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê -->
  <div class="left-panel">
    <div class="tabs">
      <div class="tab active" data-tab="overview">Genel Bakƒ±≈ü</div>
      <div class="tab" data-tab="positions">Pozisyonlar</div>
      <div class="tab" data-tab="signals">Sinyaller</div>
      <div class="tab" data-tab="control">‚öô Kontrol</div>
      <div class="tab" data-tab="logs">Loglar</div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="panel-content active" id="tab-overview">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Bakiye</div>
          <div class="stat-value cyan" id="balance-val">‚Äì</div>
          <div class="stat-sub">USDT</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Toplam PNL</div>
          <div class="stat-value" id="pnl-val">‚Äì</div>
          <div class="stat-sub" id="pnl-pct">0.00%</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">A√ßƒ±k Poz.</div>
          <div class="stat-value cyan" id="open-pos-val">0</div>
          <div class="stat-sub">pozisyon</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">G√ºnl√ºk ƒ∞≈ülem</div>
          <div class="stat-value" id="daily-trades-val">0</div>
          <div class="stat-sub" id="daily-pnl-sub">+$0.00</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Bot Sinyali</div>
          <div class="stat-value" id="signal-count-val">0</div>
          <div class="stat-sub">toplam sinyal</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Piyasa Rejimi</div>
          <div class="stat-value" id="regime-val" style="font-size:12px">‚Äì</div>
          <div class="stat-sub" id="atr-sub">ATR: ‚Äì</div>
        </div>
      </div>

      <!-- Canlƒ± Pozisyon √ñzeti -->
      <div id="overview-positions-wrap" style="display:none">
        <div class="card" style="border-color:rgba(0,188,212,0.3)">
          <div class="card-title">
            üìä A√ßƒ±k Pozisyonlar
            <button onclick="document.querySelector('.tab[data-tab=positions]').click()" style="background:none;border:none;color:var(--cyan);font-size:10px;cursor:pointer;font-family:var(--mono)">T√ºm√ºn√º g√∂r ‚Üí</button>
          </div>
          <div id="overview-positions-list"></div>
        </div>
      </div>

      <!-- Son Sinyal -->
      <div class="card">
        <div class="card-title">
          Son Otomatik Sinyal
          <span id="last-signal-time" style="color:var(--text3);font-size:10px">‚Äì</span>
        </div>
        <div id="last-signal-content">
          <div class="empty-state"><div>üì°</div>Sinyal bekleniyor...</div>
        </div>
      </div>

      <!-- Risk Bilgisi -->
      <div class="card">
        <div class="card-title">Risk Durumu</div>
        <div id="risk-content">
          <div class="loading-text"><span class="spinner"></span></div>
        </div>
      </div>
    </div>

    <!-- POSITIONS TAB -->
    <div class="panel-content" id="tab-positions">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span style="color:var(--text3);font-size:10px;letter-spacing:0.1em;text-transform:uppercase">A√ßƒ±k Pozisyonlar</span>
        <div style="display:flex;gap:6px;align-items:center">
          <span id="pos-total-pnl" style="font-size:12px;font-weight:600;color:var(--text3)">PNL: ‚Äì</span>
          <button class="btn-secondary" onclick="loadPositions()">‚Üª Yenile</button>
        </div>
      </div>
      <div id="positions-content">
        <div class="loading-text"><span class="spinner"></span></div>
      </div>
    </div>

    <!-- SIGNALS TAB -->
    <div class="panel-content" id="tab-signals">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span style="color:var(--text3);font-size:10px;letter-spacing:0.1em;text-transform:uppercase">Sinyal Ge√ßmi≈üi</span>
        <button class="btn-secondary" onclick="refreshStatus()">‚Üª Yenile</button>
      </div>
      <div id="signals-content">
        <div class="empty-state"><div>üìä</div>Sinyal bekleniyor...</div>
      </div>
    </div>

    <!-- CONTROL TAB -->
    <div class="panel-content" id="tab-control">

      <!-- ƒ∞≈ülem Testi -->
      <div class="card">
        <div class="card-title">üß™ ƒ∞≈ülem Testi
          <span style="color:var(--yellow);font-size:9px">TESTNET</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
          <div class="form-group">
            <div class="form-label">Sembol</div>
            <input type="text" id="test-symbol" value="BTCUSDT" placeholder="BTCUSDT" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()" />
          </div>
          <div class="form-group">
            <div class="form-label">Y√∂n</div>
            <select id="test-side">
              <option value="BUY">LONG ‚ñ≤</option>
              <option value="SELL">SHORT ‚ñº</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
          <div class="form-group">
            <div class="form-label">Miktar (USDT)</div>
            <input type="number" id="test-qty" value="100" min="5" step="10" />
          </div>
          <div class="form-group">
            <div class="form-label">Kaldƒ±ra√ß</div>
            <input type="number" id="test-lev" value="3" min="1" max="20" />
          </div>
          <div class="form-group">
            <div class="form-label">Emir Tipi</div>
            <select id="test-order-type">
              <option value="MARKET">Market</option>
              <option value="LIMIT">Limit</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
          <div class="form-group">
            <div class="form-label">Stop Loss %</div>
            <input type="number" id="test-sl" value="1.5" min="0.1" max="10" step="0.1" />
          </div>
          <div class="form-group">
            <div class="form-label">Take Profit %</div>
            <input type="number" id="test-tp" value="3.0" min="0.1" max="20" step="0.1" />
          </div>
        </div>
        <div id="test-preview" style="background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--text2);margin-bottom:10px;line-height:1.8">
          Parametreleri doldurun...
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="btn-long" id="ctrl-btn-long" onclick="ctrlOpenTrade('BUY')" style="font-size:12px;padding:11px">
            ‚ñ≤ LONG A√á
          </button>
          <button class="btn-short" id="ctrl-btn-short" onclick="ctrlOpenTrade('SELL')" style="font-size:12px;padding:11px">
            ‚ñº SHORT A√á
          </button>
        </div>
        <button onclick="ctrlCloseAll()" style="width:100%;margin-top:8px;padding:10px;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.25);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.background='rgba(255,61,87,0.18)'" onmouseout="this.style.background='rgba(255,61,87,0.08)'">
          üõë T√ºm Pozisyonlarƒ± Kapat
        </button>
        <div id="test-result" style="margin-top:10px;display:none"></div>
      </div>

      <!-- Ajan Kontrol Merkezi -->
      <div class="card">
        <div class="card-title">ü§ñ Otomatik Ajan Kontrol Merkezi</div>

        <!-- Ajan ON/OFF + Durum -->
        <div style="display:flex;align-items:center;justify-content:space-between;background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:12px;margin-bottom:10px">
          <div>
            <div style="font-size:12px;color:#fff;font-weight:600">Ajan Durumu</div>
            <div id="ctrl-agent-status-text" style="font-size:11px;color:var(--text3);margin-top:2px">Kontrol ediliyor...</div>
          </div>
          <label class="toggle-switch" style="width:46px;height:26px">
            <input type="checkbox" id="ctrl-agent-toggle" onchange="ctrlToggleAgent(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <!-- Ajan Parametreleri -->
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:8px">Ajan Parametreleri</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
          <div class="form-group">
            <div class="form-label">Tarama Aralƒ±ƒüƒ± (dk)</div>
            <input type="number" id="ctrl-scan-interval" value="15" min="1" max="60" step="1" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">RL Epsilon (0-1)</div>
            <input type="number" id="ctrl-epsilon" value="0.15" min="0.01" max="1" step="0.01" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">Min Sinyal Skoru</div>
            <input type="number" id="ctrl-min-score" value="0.3" min="0.1" max="1" step="0.05" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">Max Pozisyon</div>
            <input type="number" id="ctrl-max-pos" value="3" min="1" max="10" step="1" oninput="ctrlUpdateAgentPreview()" />
          </div>
        </div>

        <!-- Risk Parametreleri -->
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text3);margin-bottom:8px">Risk Parametreleri</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
          <div class="form-group">
            <div class="form-label">G√ºnl√ºk Max Kayƒ±p %</div>
            <input type="number" id="ctrl-daily-loss" value="2.0" min="0.5" max="20" step="0.5" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">Max Drawdown %</div>
            <input type="number" id="ctrl-max-drawdown" value="5.0" min="1" max="30" step="0.5" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">Risk/ƒ∞≈ülem %</div>
            <input type="number" id="ctrl-risk-per-trade" value="1.0" min="0.1" max="10" step="0.1" oninput="ctrlUpdateAgentPreview()" />
          </div>
          <div class="form-group">
            <div class="form-label">Ard. Max Kayƒ±p</div>
            <input type="number" id="ctrl-consec-loss" value="5" min="1" max="20" step="1" oninput="ctrlUpdateAgentPreview()" />
          </div>
        </div>

        <!-- √ñnizleme -->
        <div id="ctrl-agent-preview" style="background:var(--bg4);border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--text2);margin-bottom:10px;line-height:1.8">
          ‚Äì
        </div>

        <button onclick="ctrlApplyAgentSettings()" style="width:100%;padding:11px;background:rgba(0,188,212,0.12);border:1px solid rgba(0,188,212,0.3);color:var(--cyan);font-family:var(--sans);font-size:13px;font-weight:700;border-radius:6px;cursor:pointer;letter-spacing:0.05em;transition:all 0.15s" onmouseover="this.style.background='rgba(0,188,212,0.22)'" onmouseout="this.style.background='rgba(0,188,212,0.12)'">
          üíæ Ayarlarƒ± Uygula
        </button>
      </div>

      <!-- Kill Switch -->
      <div class="card" style="border-color:rgba(255,61,87,0.3)">
        <div class="card-title" style="color:var(--red)">‚õî Kill Switch</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:12px;line-height:1.6">
          Kill switch aktifle≈üince bot t√ºm i≈ülemleri durdurur ve yeni pozisyon a√ßmaz. Manuel olarak devre dƒ±≈üƒ± bƒ±rakƒ±labilir.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button onclick="ctrlKillSwitch(true)" style="padding:10px;background:rgba(255,61,87,0.12);border:1px solid rgba(255,61,87,0.35);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.15s" onmouseover="this.style.background='rgba(255,61,87,0.25)'" onmouseout="this.style.background='rgba(255,61,87,0.12)'">
            üî¥ Aktifle≈ütir
          </button>
          <button onclick="ctrlKillSwitch(false)" style="padding:10px;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.25);color:var(--green);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.15s" onmouseover="this.style.background='rgba(0,230,118,0.18)'" onmouseout="this.style.background='rgba(0,230,118,0.08)'">
            üü¢ Devre Dƒ±≈üƒ±
          </button>
        </div>
        <div id="kill-switch-status" style="margin-top:10px;text-align:center;font-size:11px;color:var(--text3)">‚Äì</div>
      </div>

      <!-- TradingView Webhook -->
      <div class="card" style="border-color:rgba(0,188,212,0.2)">
        <div class="card-title" style="color:var(--cyan)">üì° TradingView Webhook</div>
        <div style="font-size:11px;color:var(--text2);margin-bottom:10px;line-height:1.7">
          TradingView alert'lerini bota baƒülamak i√ßin a≈üaƒüƒ±daki URL'yi kullanƒ±n:
        </div>
        <div style="background:#080a0d;border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-size:11px;margin-bottom:10px;word-break:break-all">
          <span style="color:var(--text3)">POST </span>
          <span id="webhook-url" style="color:var(--cyan)">https://trademaxpro-production.up.railway.app/webhook/tradingview</span>
          <button onclick="copyWebhookUrl()" style="float:right;background:none;border:none;color:var(--text3);cursor:pointer;font-size:11px" title="Kopyala">üìã</button>
        </div>
        <div style="font-size:10px;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.08em">Alert Mesaj Formatƒ± (JSON):</div>
        <div style="background:#080a0d;border:1px solid var(--border);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--green);line-height:1.8;position:relative">
<pre style="margin:0;font-family:var(--mono);font-size:10px;color:var(--text2)">{
  <span style="color:var(--cyan)">"symbol"</span>: <span style="color:var(--yellow)">"BTCUSDT"</span>,
  <span style="color:var(--cyan)">"side"</span>: <span style="color:var(--yellow)">"BUY"</span>,
  <span style="color:var(--cyan)">"timeframe"</span>: <span style="color:var(--yellow)">"1h"</span>,
  <span style="color:var(--cyan)">"strategy_tag"</span>: <span style="color:var(--yellow)">"ema_cross"</span>,
  <span style="color:var(--cyan)">"secret"</span>: <span style="color:var(--red)">"tv-secret"</span>
}</pre>
          <button onclick="copyWebhookJson()" style="position:absolute;top:8px;right:8px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:11px" title="Kopyala">üìã</button>
        </div>
        <div style="margin-top:10px;font-size:10px;color:var(--text3);line-height:1.8">
          ‚öôÔ∏è <code style="color:var(--yellow)">WEBHOOK_SECRET</code> deƒüi≈ükenini Railway Variables'dan deƒüi≈ütirin<br>
          üìå <code style="color:var(--cyan)">"side"</code>: <code>"BUY"</code> (long) veya <code>"SELL"</code> (short)
        </div>
      </div>

    </div>

    <!-- LOGS TAB -->
    <div class="panel-content" id="tab-logs">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span style="color:var(--text3);font-size:10px;letter-spacing:0.1em;text-transform:uppercase">Sistem Loglarƒ±</span>
        <div style="display:flex;gap:6px">
          <button class="btn-secondary" onclick="fetchLogs()">‚Üª Yenile</button>
          <button class="btn-secondary" onclick="clearLogs()">Temizle</button>
        </div>
      </div>
      <div class="log-area" id="log-area">
        <div class="log-line info"><span class="log-time">--:--:--</span>Sistem ba≈ülatƒ±lƒ±yor...</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê -->
  <div class="right-panel">

    <!-- Trade Form -->
    <div class="trade-form">
      <div class="form-title">ƒ∞≈ülem A√ß</div>

      <div class="symbol-display" onclick="openMarketModal()">
        <div>
          <div class="symbol-name" id="selected-symbol">BTCUSDT</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">Sembol se√ß ‚Üí</div>
        </div>
        <div class="symbol-price" id="current-price">‚Äì</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">Miktar (USDT)</div>
          <input type="number" id="qty-input" value="100" min="5" step="10" />
        </div>
        <div class="form-group">
          <div class="form-label">Emir Tipi</div>
          <select id="order-type">
            <option value="MARKET">Market</option>
            <option value="LIMIT">Limit</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">Kaldƒ±ra√ß</div>
          <input type="number" id="leverage-input" value="3" min="1" max="20" step="1" />
        </div>
        <div style="display:flex;align-items:flex-end;padding-bottom:1px;">
          <span style="font-size:10px;color:var(--text3)">Max: <span id="max-lev-label" style="color:var(--yellow)">20x</span></span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">SL %</div>
          <input type="number" id="sl-input" value="1.5" min="0.1" max="10" step="0.1" />
        </div>
        <div class="form-group">
          <div class="form-label">TP %</div>
          <input type="number" id="tp-input" value="3.0" min="0.1" max="20" step="0.1" />
        </div>
      </div>

      <!-- P&L preview -->
      <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
        <span id="pnl-preview" style="color:var(--green);font-size:13px;font-weight:600">+$0.00</span>
      </div>

      <button class="btn-long" id="btn-long" onclick="handleLong()">
        ‚ñ≤ LONG ƒ∞≈ûLEM A√á
      </button>
      <button class="btn-short" id="btn-short" onclick="handleShort()">
        ‚ñº SHORT ƒ∞≈ûLEM A√á
      </button>
    </div>

    <!-- Agent Toggle -->
    <div class="agent-section">
      <div class="agent-toggle">
        <span style="font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3)">Otomatik Ajan</span>
        <label class="toggle-switch">
          <input type="checkbox" id="agent-toggle" onchange="toggleAgent(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="agent-info">
        <div class="agent-info-item">
          <div class="agent-info-label">Durum</div>
          <div class="agent-info-value" id="agent-status-val" style="color:var(--text3)">Pasif</div>
        </div>
        <div class="agent-info-item">
          <div class="agent-info-label">ƒ∞≈ülem Sayƒ±sƒ±</div>
          <div class="agent-info-value" id="agent-trade-count">0</div>
        </div>
        <div class="agent-info-item">
          <div class="agent-info-label">Tarama</div>
          <div class="agent-info-value" id="agent-scan-interval">15 dk</div>
        </div>
        <div class="agent-info-item">
          <div class="agent-info-label">RL Epsilon</div>
          <div class="agent-info-value" id="agent-epsilon">‚Äì</div>
        </div>
      </div>
    </div>

    <!-- Futures Market List -->
    <div class="market-section">
      <div class="market-header">
        <span class="market-title">Futures Piyasalarƒ±</span>
        <span class="market-count" id="market-count">‚Äì √ßift</span>
      </div>
      <div class="market-search">
        <input type="text" id="market-search-input" placeholder="Sembol ara... (BTC, ETH...)" oninput="filterMarket(this.value)" />
      </div>
      <div class="market-list" id="market-list">
        <div class="loading-text"><span class="spinner"></span></div>
      </div>
    </div>

  </div>
</div>

<!-- ‚îÄ‚îÄ Market Select Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="market-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeMarketModal()">‚úï</button>
    <div class="modal-title">Sembol Se√ß</div>
    <input type="text" id="modal-search" placeholder="BTC, ETH, SOL..." oninput="filterModal(this.value)" style="margin-bottom:10px" />
    <div id="modal-list" style="max-height:300px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Toast Container ‚îÄ‚îÄ -->
<div id="toast-container"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function extractErrorMessage(response) {
  if (!response) return "Bilinmeyen hata";
  if (typeof response === "string") return response;
  if (response.reason)  return String(response.reason);
  if (response.message) return String(response.message);
  if (response.detail) {
    if (Array.isArray(response.detail))
      return response.detail.map(e => e.msg || JSON.stringify(e)).join(", ");
    return String(response.detail);
  }
  try { return JSON.stringify(response); } catch { return "Hata"; }
}

function showToast(message, type = "error") {
  const icons = { error: "‚úï", success: "‚úì", info: "‚Ñπ", warn: "‚ö†" };
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]||"‚Ä¢"}</span><span class="toast-msg">${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.animation = 'fadeOut 0.4s ease forwards'; setTimeout(() => toast.remove(), 400); }, 3600);
}

async function apiFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...options,
    });
    let data;
    try { data = await res.json(); }
    catch { data = { ok: false, reason: await res.text().catch(() => "Parse error") }; }

    if (!res.ok || data?.ok === false) {
      const msg = extractErrorMessage(data);
      showToast(msg, "error");
      return { ok: false, reason: msg, _raw: data };
    }
    return { ok: true, ...data };
  } catch (err) {
    const msg = err?.message || "Aƒü baƒülantƒ± hatasƒ±";
    showToast(msg, "error");
    return { ok: false, reason: msg };
  }
}

function fmt(val, decimals = 2) {
  if (val === null || val === undefined || val === "‚Äì") return "‚Äì";
  const n = parseFloat(val);
  if (isNaN(n)) return String(val);
  return n.toFixed(decimals);
}

function fmtUSD(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "‚Äì";
  const sign = n >= 0 ? "+" : "";
  return sign + "$" + Math.abs(n).toFixed(2);
}

function fmtPrice(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "‚Äì";
  if (n >= 1000) return n.toFixed(2);
  if (n >= 1)    return n.toFixed(4);
  return n.toFixed(6);
}

function colorClass(val) {
  const n = parseFloat(val);
  if (isNaN(n) || n === 0) return "";
  return n > 0 ? "green" : "red";
}

function timeAgo(isoStr) {
  if (!isoStr) return "‚Äì";
  try {
    const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
    if (diff < 60)   return Math.round(diff) + "s √∂nce";
    if (diff < 3600) return Math.round(diff/60) + "dk √∂nce";
    return Math.round(diff/3600) + "sa √∂nce";
  } catch { return "‚Äì"; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let state = {
  symbol: "BTCUSDT",
  price: 0,
  allSymbols: [],
  filteredSymbols: [],
  positions: [],
  signalHistory: [],
  agentRunning: false,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".panel-content").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
    if (tab.dataset.tab === "positions") loadPositions();
    if (tab.dataset.tab === "logs") fetchLogs();
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS / OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function refreshStatus() {
  try {
    const res = await fetch("/status/overview");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // Connection
    document.getElementById("conn-dot").className = "dot online";
    document.getElementById("conn-label").textContent = "Online";

    // Header
    const bal = data.balance ?? data.wallet_balance ?? 0;
    document.getElementById("header-balance").textContent = "$" + parseFloat(bal).toFixed(2);

    // Stats
    document.getElementById("balance-val").textContent = fmt(bal);
    const pnl = data.unrealized_pnl ?? data.total_pnl ?? 0;
    const pnlEl = document.getElementById("pnl-val");
    pnlEl.textContent = fmtUSD(pnl);
    pnlEl.className = "stat-value " + colorClass(pnl);

    const pnlPct = bal > 0 ? (pnl / bal * 100) : 0;
    document.getElementById("pnl-pct").textContent = (pnlPct >= 0 ? "+" : "") + pnlPct.toFixed(2) + "%";

    document.getElementById("open-pos-val").textContent = data.open_positions ?? 0;
    document.getElementById("daily-trades-val").textContent = data.daily_trades ?? 0;

    const dailyPnl = data.daily_pnl ?? 0;
    const dailySub = document.getElementById("daily-pnl-sub");
    dailySub.textContent = fmtUSD(dailyPnl);
    dailySub.style.color = dailyPnl >= 0 ? "var(--green)" : "var(--red)";

    // Signal engine
    const se = data.signal_engine ?? {};
    document.getElementById("signal-count-val").textContent = se.signal_count ?? 0;
    document.getElementById("agent-trade-count").textContent = se.signal_count ?? 0;
    document.getElementById("agent-scan-interval").textContent = (se.scan_interval_min ?? 15) + " dk";

    if (se.running !== undefined) {
      state.agentRunning = se.running;
      document.getElementById("agent-toggle").checked = se.running;
      const agentStatusEl = document.getElementById("agent-status-val");
      agentStatusEl.textContent = se.running ? "Aktif" : "Pasif";
      agentStatusEl.style.color = se.running ? "var(--green)" : "var(--text3)";
      // Kontrol paneli g√ºncelle
      const ctrlToggle = document.getElementById("ctrl-agent-toggle");
      if (ctrlToggle) ctrlToggle.checked = se.running;
      const ctrlStatusText = document.getElementById("ctrl-agent-status-text");
      if (ctrlStatusText) {
        ctrlStatusText.textContent = se.running ? "‚úÖ Ajan √ßalƒ±≈üƒ±yor" : "‚èπ Ajan durduruldu";
        ctrlStatusText.style.color = se.running ? "var(--green)" : "var(--text3)";
      }
    }

    // RL agent
    const rl = data.rl_agent ?? {};
    document.getElementById("agent-epsilon").textContent = rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "‚Äì";

    // Regime
    const regime = data.regime ?? data.market_regime ?? "‚Äì";
    const regimeEl = document.getElementById("regime-val");
    regimeEl.textContent = regime;
    regimeEl.className = "stat-value";
    if (regime === "trend")    regimeEl.style.color = "var(--green)";
    else if (regime === "range") regimeEl.style.color = "var(--yellow)";
    else regimeEl.style.color = "var(--text)";

    const atrVal = data.atr_14 ?? data.atr ?? 0;
    document.getElementById("atr-sub").textContent = "ATR: " + fmtPrice(atrVal);

    // Price
    const price = data.mark_price ?? data.last_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }

    // Last signal
    renderLastSignal(se.last_signal);

    // Risk
    renderRisk(data);

  } catch (err) {
    document.getElementById("conn-dot").className = "dot offline";
    document.getElementById("conn-label").textContent = "Baƒülantƒ± yok";
    addLog("Durum g√ºncellenemedi: " + (err?.message || err), "warn");
  }
}

function renderLastSignal(sig) {
  const el = document.getElementById("last-signal-content");
  const timeEl = document.getElementById("last-signal-time");
  if (!sig || !sig.time) {
    el.innerHTML = '<div class="empty-state"><div>üì°</div>Sinyal bekleniyor...</div>';
    return;
  }
  timeEl.textContent = timeAgo(sig.time);
  const side = sig.side;
  const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
  const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
  const score = parseFloat(sig.score || 0);
  const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
  const fillClass = score > 0 ? "positive" : score < 0 ? "negative" : "positive";

  // Push to history
  if (sig.time && !state.signalHistory.find(s => s.time === sig.time)) {
    state.signalHistory.unshift(sig);
    if (state.signalHistory.length > 50) state.signalHistory.pop();
    renderSignalsTab();
  }

  const detailsHtml = (sig.details || []).slice(0, 5).map(d =>
    `<div class="signal-detail-row"><span>${d}</span></div>`
  ).join("");

  el.innerHTML = `
    <div class="signal-card" style="margin-bottom:0">
      <div class="signal-header">
        <div class="signal-symbol">${sig.symbol || state.symbol}</div>
        <div class="signal-side ${sideClass}">${sideLabel}</div>
      </div>
      <div class="signal-score-bar">
        <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px">
        <span>Skor: <strong style="color:var(--text)">${score >= 0 ? "+" : ""}${score.toFixed(3)}</strong></span>
        <span>G√º√ß: <strong style="color:var(--text)">${sig.strength || "‚Äì"}</strong></span>
      </div>
      ${detailsHtml ? `<div class="signal-details open">${detailsHtml}</div>` : ""}
    </div>`;
}

function renderSignalsTab() {
  const el = document.getElementById("signals-content");
  if (!state.signalHistory.length) {
    el.innerHTML = '<div class="empty-state"><div>üìä</div>Sinyal bekleniyor...</div>';
    return;
  }
  el.innerHTML = state.signalHistory.map(sig => {
    const side = sig.side;
    const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
    const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
    const score = parseFloat(sig.score || 0);
    const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
    const fillClass = score > 0 ? "positive" : "negative";
    return `
      <div class="signal-card">
        <div class="signal-header">
          <div class="signal-symbol" style="font-size:13px">${sig.symbol || "‚Äì"}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
            <div class="signal-side ${sideClass}">${sideLabel}</div>
          </div>
        </div>
        <div class="signal-score-bar">
          <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:10px;color:var(--text3)">Skor: ${score >= 0 ? "+" : ""}${score.toFixed(3)} ¬∑ ${sig.strength || ""}</div>
      </div>`;
  }).join("");
}

function renderRisk(data) {
  const el = document.getElementById("risk-content");
  const risk = data.risk ?? {};
  const maxPos = risk.max_positions ?? data.max_positions ?? 5;
  const openPos = data.open_positions ?? 0;
  const margin = risk.margin_usage_pct ?? data.margin_usage_pct ?? 0;
  const marginPct = parseFloat(margin).toFixed(1);
  const marginColor = marginPct > 70 ? "var(--red)" : marginPct > 40 ? "var(--yellow)" : "var(--green)";

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="agent-info-item">
        <div class="agent-info-label">Pozisyon Kullanƒ±mƒ±</div>
        <div class="agent-info-value">${openPos} / ${maxPos}</div>
      </div>
      <div class="agent-info-item">
        <div class="agent-info-label">Margin Kullanƒ±mƒ±</div>
        <div class="agent-info-value" style="color:${marginColor}">${marginPct}%</div>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OVERVIEW POZƒ∞SYON √ñZETƒ∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function refreshOverviewPositions() {
  try {
    const result = await apiFetch("/execution/positions/live");
    const positions = (result.ok ? result.positions : null) || [];
    state.positions = positions;

    const wrap = document.getElementById("overview-positions-wrap");
    const list = document.getElementById("overview-positions-list");
    document.getElementById("open-pos-val").textContent = positions.length;

    if (!positions.length) {
      wrap.style.display = "none";
      return;
    }
    wrap.style.display = "block";

    list.innerHTML = positions.map(pos => {
      const pnl    = parseFloat(pos.unrealized_pnl ?? 0);
      const pnlPct = parseFloat(pos.pnl_pct ?? 0);
      const isLong = (pos.side || "").toUpperCase() === "LONG";
      const sideColor = isLong ? "var(--green)" : "var(--red)";
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="color:#fff;font-weight:600">${pos.symbol}</span>
            <span style="color:${sideColor};font-size:10px;font-weight:700">${pos.side}</span>
            <span style="color:var(--yellow);font-size:10px">${pos.leverage}x</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div style="font-size:11px;color:var(--text2)">Giri≈ü: ${fmtPrice(pos.entry_price)}</div>
              <div style="font-size:10px;color:var(--text3)">Mark: ${fmtPrice(pos.mark_price)}</div>
            </div>
            <div style="text-align:right;min-width:70px">
              <div style="font-size:13px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
              <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
            </div>
            <button onclick="closePosition('${pos.symbol}','${pos.side}')"
              style="padding:4px 8px;background:rgba(255,61,87,0.1);border:1px solid rgba(255,61,87,0.3);color:var(--red);font-family:var(--mono);font-size:10px;border-radius:4px;cursor:pointer">
              Kapat
            </button>
          </div>
        </div>`;
    }).join("");
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  POSITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadPositions() {
  const el = document.getElementById("positions-content");
  el.innerHTML = '<div class="loading-text"><span class="spinner"></span> Binance\'den y√ºkleniyor...</div>';

  // √ñnce canlƒ± endpoint'i dene, olmazsa eski endpoint
  let result = await apiFetch("/execution/positions/live");
  if (!result.ok) result = await apiFetch("/execution/positions");

  if (!result.ok) {
    el.innerHTML = `<div class="empty-state"><div>‚ö†</div>${result.reason || "Baƒülantƒ± hatasƒ±"}</div>`;
    return;
  }

  const positions = result.positions || [];
  state.positions = positions;
  document.getElementById("open-pos-val").textContent = positions.length;

  // Toplam PNL hesapla
  const totalPnl = positions.reduce((s, p) => s + parseFloat(p.unrealized_pnl ?? 0), 0);
  const pnlEl = document.getElementById("pos-total-pnl");
  if (pnlEl) {
    pnlEl.textContent = `PNL: ${totalPnl >= 0 ? "+" : ""}$${Math.abs(totalPnl).toFixed(2)}`;
    pnlEl.style.color = totalPnl >= 0 ? "var(--green)" : "var(--red)";
  }

  if (!positions.length) {
    el.innerHTML = '<div class="empty-state"><div>üîç</div>A√ßƒ±k pozisyon yok</div>';
    return;
  }

  el.innerHTML = positions.map(pos => {
    const pnl     = parseFloat(pos.unrealized_pnl ?? 0);
    const pnlPct  = parseFloat(pos.pnl_pct ?? 0);
    const side    = (pos.side || "‚Äì").toUpperCase();
    const isLong  = side === "LONG" || side === "BUY";
    const sideColor = isLong ? "var(--green)" : "var(--red)";
    const sideBg    = isLong ? "rgba(0,230,118,0.1)" : "rgba(255,61,87,0.1)";
    const liq     = parseFloat(pos.liquidation_price ?? 0);
    const margin  = parseFloat(pos.margin ?? 0);
    const notional= parseFloat(pos.notional ?? 0);

    return `
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;">
      <!-- Ba≈ülƒ±k satƒ±rƒ± -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:var(--sans);font-size:15px;font-weight:700;color:#fff">${pos.symbol || "‚Äì"}</span>
          <span style="background:${sideBg};color:${sideColor};border:1px solid ${sideColor}33;border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:0.05em">${side}</span>
          <span style="background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:10px;color:var(--yellow)">${pos.leverage ?? 1}x</span>
        </div>
        <div style="text-align:right">
          <div style="font-size:15px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
          <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
        </div>
      </div>

      <!-- Detay grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Giri≈ü</div>
          <div style="font-size:12px;color:var(--text)">${fmtPrice(pos.entry_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Mark</div>
          <div style="font-size:12px;color:var(--cyan)">${fmtPrice(pos.mark_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Liq.</div>
          <div style="font-size:12px;color:${liq > 0 ? "var(--red)" : "var(--text3)"}">${liq > 0 ? fmtPrice(liq) : "‚Äì"}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Miktar</div>
          <div style="font-size:12px;color:var(--text)">${fmt(pos.contracts ?? 0, 4)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Notional</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(notional, 2)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Margin</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(margin, 2)}</div>
        </div>
      </div>

      <!-- Kapat butonu -->
      <button onclick="closePosition('${pos.symbol}','${side}')"
        style="width:100%;padding:8px;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.25);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;transition:all 0.15s;font-weight:600"
        onmouseover="this.style.background='rgba(255,61,87,0.2)'"
        onmouseout="this.style.background='rgba(255,61,87,0.08)'">
        üõë ${pos.symbol} Pozisyonunu Kapat
      </button>
    </div>`;
  }).join("");
}

async function closePosition(symbol, side) {
  if (!confirm(`${symbol} ${side} pozisyonunu kapatmak istediƒüinize emin misiniz?`)) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol, side }),
  });
  if (result.ok) {
    showToast(`‚úÖ ${symbol} pozisyonu kapatƒ±ldƒ±`, "success");
    await loadPositions();
    await refreshStatus();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKET LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadMarketList() {
  try {
    const res = await fetch("/status/symbols");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    state.allSymbols = data.symbols || data || [];
    document.getElementById("market-count").textContent = state.allSymbols.length + " √ßift";
    renderMarketList(state.allSymbols);
    renderModalList(state.allSymbols);
  } catch (err) {
    // Fallback: yaygƒ±n semboller
    const fallback = [
      "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","DOGEUSDT",
      "ADAUSDT","AVAXUSDT","LINKUSDT","DOTUSDT","MATICUSDT","LTCUSDT",
      "ATOMUSDT","UNIUSDT","NEARUSDT","APTUSDT","ARBUSDT","OPUSDT",
    ];
    state.allSymbols = fallback;
    document.getElementById("market-count").textContent = fallback.length + " √ßift";
    renderMarketList(fallback);
    renderModalList(fallback);
  }
}

function renderMarketList(symbols) {
  const el = document.getElementById("market-list");
  if (!symbols.length) {
    el.innerHTML = '<div class="loading-text">Sembol bulunamadƒ±</div>';
    return;
  }
  el.innerHTML = symbols.slice(0, 100).map(sym => {
    const base = String(sym).replace("USDT", "").replace("BUSD", "");
    const selected = sym === state.symbol ? "selected" : "";
    return `
      <div class="market-item ${selected}" onclick="selectSymbol('${sym}')">
        <div class="market-sym">${base}<span>/USDT</span></div>
        <button class="market-add-btn" onclick="event.stopPropagation();selectSymbol('${sym}')">+ ƒ∞≈ülem</button>
      </div>`;
  }).join("");
}

function renderModalList(symbols) {
  const el = document.getElementById("modal-list");
  el.innerHTML = symbols.slice(0, 200).map(sym => {
    const base = String(sym).replace("USDT", "").replace("BUSD", "");
    return `
      <div class="market-item" onclick="selectSymbol('${sym}');closeMarketModal()" style="padding:10px 12px">
        <div class="market-sym">${base}<span>/USDT</span></div>
        <div style="font-size:10px;color:var(--text3)">${sym}</div>
      </div>`;
  }).join("");
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

function filterModal(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderModalList(filtered);
}

function selectSymbol(sym) {
  state.symbol = sym;
  document.getElementById("selected-symbol").textContent = sym;
  document.getElementById("current-price").textContent = "‚Äì";
  renderMarketList(state.allSymbols.filter(s =>
    s.toLowerCase().includes(document.getElementById("market-search-input").value.toLowerCase())
  ));
  // Fiyat g√ºncelle
  fetchSymbolPrice(sym);
  addLog(`Sembol deƒüi≈ütirildi: ${sym}`, "info");
}

async function fetchSymbolPrice(sym) {
  try {
    const res = await fetch(`/status/price?symbol=${sym}`);
    if (!res.ok) return;
    const data = await res.json();
    const price = data.price ?? data.mark_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }
  } catch {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  P&L PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updatePnLPreview() {
  const qty = parseFloat(document.getElementById("qty-input").value) || 100;
  const tp = parseFloat(document.getElementById("tp-input").value) || 3;
  const lev = parseFloat(document.getElementById("leverage-input").value) || 3;
  const maxPnl = qty * (tp / 100);
  const el = document.getElementById("pnl-preview");
  el.textContent = "+" + "$" + maxPnl.toFixed(2) + " max TP";
}

["qty-input","tp-input","leverage-input","sl-input"].forEach(id => {
  document.getElementById(id)?.addEventListener("input", updatePnLPreview);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRADE ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function handleLong() {
  await submitTrade("BUY");
}
async function handleShort() {
  await submitTrade("SELL");
}

async function submitTrade(side) {
  const symbol    = state.symbol;
  const qty       = parseFloat(document.getElementById("qty-input").value) || 100;
  const leverage  = parseInt(document.getElementById("leverage-input").value) || 3;
  const orderType = document.getElementById("order-type").value;
  const slPct     = parseFloat(document.getElementById("sl-input").value) || 1.5;
  const tpPct     = parseFloat(document.getElementById("tp-input").value) || 3.0;

  const btnId = side === "BUY" ? "btn-long" : "btn-short";
  const btn = document.getElementById(btnId);
  const origHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> ƒ∞≈üleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({
      symbol,
      side,
      quantity: qty,
      leverage,
      order_type: orderType,
      sl_pct: slPct,
      tp_pct: tpPct,
      strategy_tag: "manual",
    }),
  });

  btn.disabled = false;
  btn.innerHTML = origHtml;

  if (result.ok) {
    const sideLabel = side === "BUY" ? "LONG" : "SHORT";
    showToast(`‚úÖ ${sideLabel} i≈ülem a√ßƒ±ldƒ±: ${symbol}`, "success");
    addLog(`ƒ∞≈ülem a√ßƒ±ldƒ±: ${symbol} ${sideLabel} ${qty} USDT`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    addLog(`ƒ∞≈ülem reddedildi: ${result.reason}`, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONTROL PANELƒ∞ ‚Äî ƒ∞≈ülem Testi
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ctrlUpdateTestPreview() {
  const sym  = document.getElementById("test-symbol").value || "BTCUSDT";
  const side = document.getElementById("test-side").value;
  const qty  = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev  = parseFloat(document.getElementById("test-lev").value) || 3;
  const sl   = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const tp   = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const maxGain = (qty * tp / 100).toFixed(2);
  const maxLoss = (qty * sl / 100).toFixed(2);
  const sideLabel = side === "BUY" ? "üü¢ LONG" : "üî¥ SHORT";
  document.getElementById("test-preview").innerHTML =
    `<span style="color:#fff">${sym}</span> ${sideLabel} &nbsp;|&nbsp; ` +
    `Miktar: <span style="color:var(--cyan)">$${qty}</span> &nbsp;|&nbsp; ` +
    `Kaldƒ±ra√ß: <span style="color:var(--yellow)">${lev}x</span><br>` +
    `Max K√¢r: <span style="color:var(--green)">+$${maxGain}</span> &nbsp;|&nbsp; ` +
    `Max Kayƒ±p: <span style="color:var(--red)">-$${maxLoss}</span> &nbsp;|&nbsp; ` +
    `SL: ${sl}% / TP: ${tp}%`;
}

["test-symbol","test-side","test-qty","test-lev","test-sl","test-tp","test-order-type"].forEach(id => {
  document.getElementById(id)?.addEventListener("input",  ctrlUpdateTestPreview);
  document.getElementById(id)?.addEventListener("change", ctrlUpdateTestPreview);
});

async function ctrlOpenTrade(forceSide) {
  const side   = forceSide || document.getElementById("test-side").value;
  const symbol = document.getElementById("test-symbol").value.trim().toUpperCase() || "BTCUSDT";
  const qty    = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev    = parseInt(document.getElementById("test-lev").value) || 3;
  const tp     = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const sl     = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const otype  = document.getElementById("test-order-type").value;

  const btnId = side === "BUY" ? "ctrl-btn-long" : "ctrl-btn-short";
  const btn = document.getElementById(btnId);
  const orig = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = `<span class="spinner"></span> ƒ∞≈üleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({ symbol, side, quantity: qty, leverage: lev,
      order_type: otype, sl_pct: sl, tp_pct: tp, strategy_tag: "manual_test" }),
  });

  btn.disabled = false; btn.innerHTML = orig;

  const el = document.getElementById("test-result");
  el.style.display = "block";
  if (result.ok) {
    el.style.cssText = "display:block;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--green);margin-top:10px";
    el.innerHTML = `‚úÖ ƒ∞≈ülem a√ßƒ±ldƒ±: <strong>${symbol}</strong> ${side === "BUY" ? "LONG" : "SHORT"} $${qty} ‚Äî ${new Date().toLocaleTimeString("tr-TR")}`;
    showToast(`‚úÖ ${symbol} ${side === "BUY" ? "LONG" : "SHORT"} a√ßƒ±ldƒ±`, "success");
    addLog(`TEST i≈ülemi a√ßƒ±ldƒ±: ${symbol} ${side} $${qty} ${lev}x`, "ok");
    await loadPositions(); await refreshStatus();
  } else {
    el.style.cssText = "display:block;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--red);margin-top:10px";
    el.innerHTML = `‚ùå Hata: ${result.reason || "Bilinmeyen hata"}`;
    addLog(`TEST i≈ülemi reddedildi: ${result.reason}`, "error");
  }
}

async function ctrlCloseAll() {
  if (!confirm("T√ºm a√ßƒ±k pozisyonlarƒ± kapatmak istediƒüinize emin misiniz?")) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol: "ALL" }),
  });
  if (result.ok) {
    showToast("‚úÖ T√ºm pozisyonlar kapatƒ±ldƒ±", "success");
    addLog("T√ºm pozisyonlar manuel kapatƒ±ldƒ±", "warn");
    await loadPositions(); await refreshStatus();
  } else {
    showToast("‚ùå Kapatma hatasƒ±: " + (result.reason || "?"), "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONTROL PANELƒ∞ ‚Äî Ajan Ayarlarƒ±
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ctrlUpdateAgentPreview() {
  const scan    = document.getElementById("ctrl-scan-interval").value;
  const eps     = document.getElementById("ctrl-epsilon").value;
  const minScore= document.getElementById("ctrl-min-score").value;
  const maxPos  = document.getElementById("ctrl-max-pos").value;
  const dayLoss = document.getElementById("ctrl-daily-loss").value;
  const drawdown= document.getElementById("ctrl-max-drawdown").value;
  const rpt     = document.getElementById("ctrl-risk-per-trade").value;
  const conLoss = document.getElementById("ctrl-consec-loss").value;
  document.getElementById("ctrl-agent-preview").innerHTML =
    `Tarama: <span style="color:var(--cyan)">${scan} dk</span> &nbsp;|&nbsp; ` +
    `Epsilon: <span style="color:var(--yellow)">${eps}</span> &nbsp;|&nbsp; ` +
    `Min Skor: <span style="color:var(--cyan)">${minScore}</span><br>` +
    `Max Poz: <span style="color:var(--cyan)">${maxPos}</span> &nbsp;|&nbsp; ` +
    `G√ºnl√ºk Kayƒ±p: <span style="color:var(--red)">${dayLoss}%</span> &nbsp;|&nbsp; ` +
    `Drawdown: <span style="color:var(--red)">${drawdown}%</span><br>` +
    `Risk/ƒ∞≈ülem: <span style="color:var(--green)">${rpt}%</span> &nbsp;|&nbsp; ` +
    `Ard. Kayƒ±p: <span style="color:var(--yellow)">${conLoss}</span>`;
}

async function ctrlToggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const statusEl = document.getElementById("ctrl-agent-status-text");
  if (result.ok !== false) {
    state.agentRunning = enabled;
    statusEl.textContent = enabled ? "‚úÖ Ajan √ßalƒ±≈üƒ±yor" : "‚èπ Ajan durduruldu";
    statusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    // Ana panel toggle da g√ºncelle
    const mainToggle = document.getElementById("agent-toggle");
    if (mainToggle) mainToggle.checked = enabled;
    showToast(enabled ? "ü§ñ Ajan aktifle≈ütirildi" : "‚èπ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Ajan ba≈ülatƒ±ldƒ± (kontrol panelinden)" : "Ajan durduruldu (kontrol panelinden)", enabled ? "ok" : "warn");
  }
}

async function ctrlApplyAgentSettings() {
  const settings = {
    scan_interval_min: parseInt(document.getElementById("ctrl-scan-interval").value),
    rl_epsilon:        parseFloat(document.getElementById("ctrl-epsilon").value),
    min_signal_score:  parseFloat(document.getElementById("ctrl-min-score").value),
    max_positions:     parseInt(document.getElementById("ctrl-max-pos").value),
    daily_max_loss_pct:parseFloat(document.getElementById("ctrl-daily-loss").value),
    max_drawdown_pct:  parseFloat(document.getElementById("ctrl-max-drawdown").value),
    risk_per_trade_pct:parseFloat(document.getElementById("ctrl-risk-per-trade").value),
    kill_switch_consecutive_loss: parseInt(document.getElementById("ctrl-consec-loss").value),
  };

  // /status/agent endpoint'ine settings g√∂nder
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: state.agentRunning, settings }),
  });

  if (result.ok !== false) {
    showToast("üíæ Ajan ayarlarƒ± uygulandƒ±", "success");
    addLog(`Ajan ayarlarƒ± g√ºncellendi: scan=${settings.scan_interval_min}dk eps=${settings.rl_epsilon}`, "ok");
  } else {
    showToast("‚ö† Ayarlar uygulanamadƒ±: " + (result.reason || "?"), "warn");
  }
}

async function ctrlKillSwitch(activate) {
  const action = activate ? "aktifle≈ütir" : "devre dƒ±≈üƒ± bƒ±rak";
  if (!confirm(`Kill switch'i ${action}mak istediƒüinize emin misiniz?`)) return;

  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: !activate, kill_switch: activate }),
  });

  const el = document.getElementById("kill-switch-status");
  if (activate) {
    el.style.color = "var(--red)";
    el.textContent = "üî¥ Kill Switch AKTƒ∞F ‚Äî Bot t√ºm i≈ülemleri durdurdu";
    showToast("üî¥ Kill Switch aktifle≈ütirildi!", "error");
    addLog("KILL SWITCH AKTƒ∞F ‚Äî t√ºm i≈ülemler durduruldu", "error");
    // Ajan toggle'ƒ± kapat
    document.getElementById("ctrl-agent-toggle").checked = false;
    document.getElementById("ctrl-agent-status-text").textContent = "üî¥ Kill switch aktif";
    document.getElementById("ctrl-agent-status-text").style.color = "var(--red)";
  } else {
    el.style.color = "var(--green)";
    el.textContent = "üü¢ Kill Switch devre dƒ±≈üƒ± ‚Äî Bot normal √ßalƒ±≈ümaya devam edebilir";
    showToast("üü¢ Kill Switch devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±", "success");
    addLog("Kill switch devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ± (manuel)", "warn");
  }
}

// Kontrol sekmesi a√ßƒ±ldƒ±ƒüƒ±nda preview g√ºncelle
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.dataset.tab === "control") {
      ctrlUpdateTestPreview();
      ctrlUpdateAgentPreview();
    }
  });
});

function copyWebhookUrl() {
  const url = document.getElementById("webhook-url").textContent;
  navigator.clipboard.writeText(url).then(() => showToast("üìã URL kopyalandƒ±", "success"));
}

function copyWebhookJson() {
  const json = `{\n  "symbol": "BTCUSDT",\n  "side": "BUY",\n  "timeframe": "1h",\n  "strategy_tag": "ema_cross",\n  "secret": "tv-secret"\n}`;
  navigator.clipboard.writeText(json).then(() => showToast("üìã JSON kopyalandƒ±", "success"));
}

// AGENT TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function toggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const agentStatusEl = document.getElementById("agent-status-val");
  if (result.ok || true) { // optimistic
    state.agentRunning = enabled;
    agentStatusEl.textContent = enabled ? "Aktif" : "Pasif";
    agentStatusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    showToast(enabled ? "ü§ñ Otomatik ajan aktifle≈ütirildi" : "‚èπ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Otomatik ajan ba≈ülatƒ±ldƒ±" : "Otomatik ajan durduruldu", enabled ? "ok" : "warn");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openMarketModal() {
  document.getElementById("market-modal").classList.add("open");
  document.getElementById("modal-search").focus();
}
function closeMarketModal() {
  document.getElementById("market-modal").classList.remove("open");
}
document.getElementById("market-modal").addEventListener("click", e => {
  if (e.target === document.getElementById("market-modal")) closeMarketModal();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function addLog(message, type = "info") {
  const el = document.getElementById("log-area");
  const now = new Date().toTimeString().slice(0, 8);
  const line = document.createElement("div");
  line.className = `log-line ${type}`;
  line.innerHTML = `<span class="log-time">${now}</span>${escHtml(message)}`;
  el.appendChild(line);
  // Max 200 lines
  while (el.children.length > 200) el.removeChild(el.firstChild);
  el.scrollTop = el.scrollHeight;
}

function escHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

async function fetchLogs() {
  try {
    const res = await fetch("/status/logs?limit=100");
    if (!res.ok) return;
    const data = await res.json();
    const logs = data.logs || data || [];
    const el = document.getElementById("log-area");
    el.innerHTML = "";
    logs.forEach(entry => {
      if (typeof entry === "string") {
        addLog(entry, "info");
      } else {
        addLog(entry.message || entry.msg || JSON.stringify(entry),
               entry.level === "ERROR" ? "error" : entry.level === "WARNING" ? "warn" : "info");
      }
    });
  } catch {}
}

function clearLogs() {
  document.getElementById("log-area").innerHTML = "";
  addLog("Loglar temizlendi", "info");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT & POLLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function init() {
  addLog("Dashboard ba≈ülatƒ±lƒ±yor...", "info");
  await Promise.all([
    refreshStatus(),
    loadPositions(),
    loadMarketList(),
    refreshOverviewPositions(),
  ]);
  addLog("Dashboard hazƒ±r ‚úì", "ok");
  updatePnLPreview();
  ctrlUpdateTestPreview();
  ctrlUpdateAgentPreview();
}

// Poll every 10s
setInterval(async () => {
  await refreshStatus();
  // Pozisyonlarƒ± her 15 saniyede otomatik g√ºncelle
  await refreshOverviewPositions();
  if (document.querySelector(".tab[data-tab='positions'].active")) {
    await loadPositions();
  }
}, 10_000);

// Price poll for selected symbol every 5s
setInterval(() => fetchSymbolPrice(state.symbol), 5_000);

init();
</script>
</body>
</html>
