<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Trading Bot ‚Äî Trademaxpro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:      #060810;
    --bg2:     #0b0e1a;
    --bg3:     #101422;
    --bg4:     #151928;
    --border:  #1a2035;
    --border2: #222840;
    --text:    #d0e0f0;
    --text2:   #6080a0;
    --text3:   #304060;
    --green:   #00ff88;
    --green2:  #00cc66;
    --red:     #ff3366;
    --red2:    #cc2255;
    --cyan:    #00d4ff;
    --yellow:  #ffcc00;
    --orange:  #ff8800;
    --purple:  #8844ff;
    --mono:    'Share Tech Mono', monospace;
    --sans:    'Rajdhani', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  ::-webkit-scrollbar { width: 3px; height: 3px; }
  ::-webkit-scrollbar-track { background: var(--bg2); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ‚îÄ‚îÄ Ticker Bar ‚îÄ‚îÄ */
  .ticker-bar {
    background: #000;
    border-bottom: 1px solid var(--border);
    padding: 4px 16px;
    overflow: hidden;
    white-space: nowrap;
    font-size: 11px;
    display: flex;
    gap: 24px;
    align-items: center;
  }
  .ticker-item { display: inline-flex; gap: 6px; align-items: center; }
  .ticker-sym { color: var(--text2); }
  .ticker-price { color: var(--text); font-weight: 600; }
  .ticker-chg.pos { color: var(--green); }
  .ticker-chg.neg { color: var(--red); }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 8px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--sans);
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--cyan);
    text-transform: uppercase;
  }
  .logo small { color: var(--text2); font-size: 10px; font-weight: 400; display: block; letter-spacing: 3px; margin-top: -2px; }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 12px;
  }

  .hm-stat { text-align: center; }
  .hm-label { color: var(--text3); font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; }
  .hm-value { font-family: var(--sans); font-size: 16px; font-weight: 700; }

  .header-controls { display: flex; align-items: center; gap: 12px; }
  .status-pill {
    display: flex; align-items: center; gap: 5px;
    background: rgba(0,255,136,0.08);
    border: 1px solid rgba(0,255,136,0.2);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 10px; color: var(--green);
  }
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }
  .status-dot.offline { background: var(--red); animation: none; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

  .btn-start {
    background: rgba(0,212,255,0.1);
    border: 1px solid var(--cyan);
    color: var(--cyan);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 14px;
    border-radius: 4px;
    cursor: pointer;
    letter-spacing: 0.05em;
  }
  .btn-stop {
    background: rgba(255,51,102,0.1);
    border: 1px solid var(--red);
    color: var(--red);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 14px;
    border-radius: 4px;
    cursor: pointer;
    letter-spacing: 0.05em;
  }

  /* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */
  .stats-bar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0;
  }

  .stat-item {
    padding: 10px 16px;
    border-right: 1px solid var(--border);
  }
  .stat-item:last-child { border-right: none; }
  .stat-lbl { font-size: 9px; color: var(--text3); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 3px; }
  .stat-val {
    font-family: var(--sans);
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  .stat-sub { font-size: 10px; color: var(--text3); margin-top: 2px; }
  .stat-val.cyan { color: var(--cyan); }
  .stat-val.green { color: var(--green); }
  .stat-val.red { color: var(--red); }
  .stat-val.yellow { color: var(--yellow); }
  .stat-val.purple { color: var(--purple); }

  /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
  .main-layout {
    display: grid;
    grid-template-columns: 1fr 360px 280px;
    height: calc(100vh - 112px);
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Center Panel ‚îÄ‚îÄ */
  .center-panel {
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 16px;
  }

  /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
    gap: 0;
  }
  .tab {
    padding: 8px 16px;
    font-family: var(--sans);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s;
  }
  .tab:hover { color: var(--text2); }
  .tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }

  .panel-content { display: none; }
  .panel-content.active { display: block; }

  /* ‚îÄ‚îÄ Market Grid ‚îÄ‚îÄ */
  .piyasa-header {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
  }
  .piyasa-header input {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 10px;
    border-radius: 4px;
    flex: 1;
    outline: none;
  }
  .sort-btn {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text2);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
  }
  .sort-btn.active { border-color: var(--cyan); color: var(--cyan); }

  .coin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 4px;
  }
  .coin-cell {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .coin-cell:hover { border-color: var(--border2); background: var(--bg4); }
  .coin-cell.selected { border-color: var(--cyan) !important; background: rgba(0,212,255,0.06) !important; }
  .coin-sym { font-family: var(--sans); font-size: 12px; font-weight: 600; color: var(--text); }
  .coin-price { font-size: 10px; color: var(--text2); margin-top: 1px; }
  .coin-chg { font-size: 11px; font-weight: 600; margin-top: 2px; }
  .coin-chg.pos { color: var(--green); }
  .coin-chg.neg { color: var(--red); }

  /* ‚îÄ‚îÄ Chart + Strategy Area ‚îÄ‚îÄ */
  .chart-area {
    margin-top: 12px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .chart-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .chart-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  .chart-sym { font-family: var(--sans); font-size: 14px; font-weight: 700; color: var(--text); }
  .chart-body { padding: 12px; min-height: 180px; display: flex; align-items: center; justify-content: center; color: var(--text3); font-size: 11px; }

  .period-btns { display: flex; gap: 2px; }
  .period-btn {
    background: none; border: none;
    color: var(--text3); font-family: var(--mono); font-size: 10px;
    padding: 2px 6px; cursor: pointer; border-radius: 3px;
  }
  .period-btn.active { background: var(--bg4); color: var(--cyan); }

  /* ‚îÄ‚îÄ Strategy Section ‚îÄ‚îÄ */
  .strategy-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }
  .strategy-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  .strategy-title { font-family: var(--sans); font-size: 13px; font-weight: 700; color: var(--text); letter-spacing: 0.05em; text-transform: uppercase; }
  .live-badge {
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    color: var(--green);
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 3px;
    letter-spacing: 0.1em;
  }
  .best-badge {
    background: rgba(0,212,255,0.1);
    border: 1px solid rgba(0,212,255,0.3);
    color: var(--cyan);
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 3px;
  }

  .strategy-list { padding: 10px 12px; }
  .strategy-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .strategy-row:last-child { border-bottom: none; }
  .strat-name { font-family: var(--sans); font-size: 13px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 6px; }
  .strat-trades { font-size: 10px; color: var(--text3); }
  .strat-bar-wrap { flex: 1; margin: 0 12px; }
  .strat-bar-bg { height: 3px; background: var(--border2); border-radius: 2px; overflow: hidden; }
  .strat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }
  .strat-wr { font-size: 10px; color: var(--text2); white-space: nowrap; }
  .strat-pf { font-family: var(--sans); font-size: 13px; font-weight: 700; color: var(--green); }

  /* ‚îÄ‚îÄ Right Panel (Trade + Agent) ‚îÄ‚îÄ */
  .right-panel {
    border-right: 1px solid var(--border);
    overflow-y: auto;
    background: var(--bg2);
  }

  .trade-form {
    padding: 14px;
    border-bottom: 1px solid var(--border);
  }

  .form-title {
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 10px;
  }

  .symbol-display {
    background: var(--bg3);
    border: 1px solid var(--border2);
    border-radius: 5px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    margin-bottom: 10px;
    transition: border-color 0.15s;
  }
  .symbol-display:hover { border-color: var(--cyan); }
  .symbol-name { font-family: var(--sans); font-size: 15px; font-weight: 700; color: var(--text); }
  .symbol-price { font-family: var(--sans); font-size: 15px; font-weight: 700; color: var(--cyan); }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
  }

  .form-group { display: flex; flex-direction: column; gap: 3px; }
  .form-label { font-size: 9px; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; }

  input[type="number"], input[type="text"], select {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 4px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  input:focus, select:focus { border-color: var(--cyan); }
  select option { background: var(--bg3); }

  .pnl-preview-row {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 10px;
  }
  .pnl-preview-label { font-size: 10px; color: var(--text3); margin-right: 6px; }
  #pnl-preview { font-family: var(--sans); font-size: 14px; font-weight: 700; color: var(--green); }

  .btn-long {
    width: 100%;
    padding: 11px;
    background: var(--green);
    border: none;
    color: #000;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.1em;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 6px;
    transition: opacity 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-long:hover { opacity: 0.85; }
  .btn-short {
    width: 100%;
    padding: 11px;
    background: var(--red);
    border: none;
    color: #fff;
    font-family: var(--sans);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.1em;
    border-radius: 5px;
    cursor: pointer;
    transition: opacity 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-short:hover { opacity: 0.85; }

  /* ‚îÄ‚îÄ Agent Section ‚îÄ‚îÄ */
  .agent-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
  }

  .agent-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .agent-label { font-family: var(--sans); font-size: 11px; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text3); }

  .toggle-switch { position: relative; width: 38px; height: 20px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; inset: 0;
    background: var(--bg4);
    border: 1px solid var(--border2);
    border-radius: 20px;
    cursor: pointer;
    transition: 0.2s;
  }
  .toggle-slider::before {
    content: "";
    position: absolute;
    width: 14px; height: 14px;
    left: 2px; top: 2px;
    background: var(--text3);
    border-radius: 50%;
    transition: 0.2s;
  }
  input:checked + .toggle-slider { background: rgba(0,255,136,0.15); border-color: var(--green); }
  input:checked + .toggle-slider::before { transform: translateX(18px); background: var(--green); }

  .agent-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  .agent-cell {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 7px 9px;
  }
  .agent-cell-label { font-size: 9px; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 3px; }
  .agent-cell-val { font-family: var(--sans); font-size: 14px; font-weight: 700; color: var(--text); }

  /* ‚îÄ‚îÄ Positions in right panel ‚îÄ‚îÄ */
  .pos-section {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
  }
  .section-title {
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .refresh-btn {
    background: none; border: 1px solid var(--border2);
    color: var(--text3); font-size: 10px; padding: 2px 8px;
    border-radius: 3px; cursor: pointer; font-family: var(--mono);
  }
  .refresh-btn:hover { color: var(--text2); border-color: var(--text2); }

  /* ‚îÄ‚îÄ Market List (right side) ‚îÄ‚îÄ */
  .market-section {
    padding: 12px 14px;
  }
  .market-search input {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text);
    font-family: var(--mono);
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 4px;
    width: 100%;
    outline: none;
    margin-bottom: 8px;
  }
  .market-list { max-height: 300px; overflow-y: auto; }
  .market-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 7px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s;
  }
  .market-item:hover { background: var(--bg4); }
  .market-sym { font-family: var(--sans); font-size: 12px; font-weight: 600; color: var(--text); }
  .market-add-btn {
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.2);
    color: var(--cyan);
    font-family: var(--mono);
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .market-item:hover .market-add-btn { opacity: 1; }

  /* ‚îÄ‚îÄ Far Right: Logs/Signals Panel ‚îÄ‚îÄ */
  .far-right {
    overflow-y: auto;
    background: var(--bg);
    display: flex;
    flex-direction: column;
  }

  /* positions tab in center panel */
  .pos-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 8px;
  }
  .pos-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .pos-sym { font-family: var(--sans); font-size: 15px; font-weight: 700; color: var(--text); }
  .side-badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }
  .side-badge.long { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); color: var(--green); }
  .side-badge.short { background: rgba(255,51,102,0.1); border: 1px solid rgba(255,51,102,0.3); color: var(--red); }

  /* ‚îÄ‚îÄ Log Area ‚îÄ‚îÄ */
  .log-area {
    flex: 1;
    padding: 10px 12px;
    overflow-y: auto;
    font-size: 11px;
    line-height: 1.6;
  }
  .log-line { padding: 1px 0; }
  .log-line.info { color: var(--text2); }
  .log-line.ok { color: var(--green); }
  .log-line.warn { color: var(--yellow); }
  .log-line.error { color: var(--red); }
  .log-time { color: var(--text3); margin-right: 6px; }

  .log-toolbar {
    display: flex;
    gap: 4px;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    align-items: center;
    background: var(--bg2);
  }
  .log-filter-btn {
    background: none;
    border: 1px solid var(--border2);
    color: var(--text3);
    font-family: var(--mono);
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 3px;
    cursor: pointer;
  }
  .log-filter-btn.active { border-color: var(--cyan); color: var(--cyan); }
  .log-filter-btn:hover { border-color: var(--text2); color: var(--text2); }

  /* ‚îÄ‚îÄ Signals in far-right ‚îÄ‚îÄ */
  .signal-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 10px 12px;
    margin-bottom: 6px;
  }
  .signal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .signal-symbol { font-family: var(--sans); font-size: 14px; font-weight: 700; color: var(--text); }
  .signal-side {
    padding: 2px 8px;
    border-radius: 3px;
    font-family: var(--sans);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.05em;
  }
  .signal-side.buy { background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); color: var(--green); }
  .signal-side.sell { background: rgba(255,51,102,0.1); border: 1px solid rgba(255,51,102,0.3); color: var(--red); }
  .signal-side.none { background: var(--bg4); border: 1px solid var(--border2); color: var(--text3); }
  .signal-score-bar { height: 2px; background: var(--border2); border-radius: 2px; overflow: hidden; margin-bottom: 6px; }
  .signal-score-fill { height: 100%; border-radius: 2px; }
  .signal-score-fill.positive { background: var(--green); }
  .signal-score-fill.negative { background: var(--red); }
  .signal-detail-row { font-size: 10px; color: var(--text3); padding: 1px 0; }

  /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
  #toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
  }
  .toast {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 9px 14px;
    border-radius: 5px;
    font-size: 12px;
    animation: fadeIn 0.3s ease;
    min-width: 200px;
    max-width: 320px;
    backdrop-filter: blur(8px);
  }
  .toast.error   { background: rgba(255,51,102,0.15); border: 1px solid rgba(255,51,102,0.4); color: var(--red); }
  .toast.success { background: rgba(0,255,136,0.12); border: 1px solid rgba(0,255,136,0.35); color: var(--green); }
  .toast.info    { background: rgba(0,212,255,0.12); border: 1px solid rgba(0,212,255,0.3); color: var(--cyan); }
  .toast.warn    { background: rgba(255,204,0,0.12); border: 1px solid rgba(255,204,0,0.3); color: var(--yellow); }
  .toast-icon { font-size: 14px; }
  @keyframes fadeIn { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform: translateX(0); } }
  @keyframes fadeOut { from { opacity:1; } to { opacity:0; } }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 20px;
    width: 340px;
    position: relative;
  }
  .modal-close {
    position: absolute; top: 12px; right: 12px;
    background: none; border: none;
    color: var(--text3); font-size: 16px; cursor: pointer;
  }
  .modal-title { font-family: var(--sans); font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 12px; }

  /* ‚îÄ‚îÄ Empty/Loading ‚îÄ‚îÄ */
  .empty-state { padding: 24px; text-align: center; color: var(--text3); }
  .loading-text { color: var(--text3); font-size: 11px; display: flex; align-items: center; gap: 6px; }
  .spinner {
    width: 12px; height: 12px; border: 2px solid var(--border2);
    border-top-color: var(--cyan); border-radius: 50%;
    animation: spin 0.7s linear infinite; display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Control Tab ‚îÄ‚îÄ */
  .ctrl-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 14px;
    margin-bottom: 10px;
  }
  .ctrl-title {
    font-family: var(--sans);
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text2);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ctrl-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
  .ctrl-label { font-size: 9px; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 3px; }
  .btn-primary {
    background: rgba(0,212,255,0.12);
    border: 1px solid var(--cyan);
    color: var(--cyan);
    font-family: var(--mono);
    font-size: 11px;
    padding: 7px 14px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-top: 6px;
    transition: background 0.15s;
  }
  .btn-primary:hover { background: rgba(0,212,255,0.2); }
  .btn-danger {
    background: rgba(255,51,102,0.1);
    border: 1px solid var(--red);
    color: var(--red);
    font-family: var(--mono);
    font-size: 11px;
    padding: 7px 14px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    margin-top: 6px;
  }
  .btn-secondary {
    background: var(--bg3);
    border: 1px solid var(--border2);
    color: var(--text2);
    font-family: var(--mono);
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-secondary:hover { border-color: var(--text2); }

  /* ‚îÄ‚îÄ Right most panel tabs ‚îÄ‚îÄ */
  .far-right-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg2);
  }
  .far-tab {
    padding: 8px 14px;
    font-family: var(--sans);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    flex: 1;
    text-align: center;
  }
  .far-tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }

  .far-panel { display: none; flex-direction: column; flex: 1; overflow: hidden; }
  .far-panel.active { display: flex; }

  /* ‚îÄ‚îÄ Agent info ‚îÄ‚îÄ */
  .agent-info-item { }
  .agent-info-label { font-size: 9px; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 2px; }
  .agent-info-value { font-family: var(--sans); font-size: 14px; font-weight: 700; color: var(--text); }

  @media (max-width: 1400px) {
    .main-layout { grid-template-columns: 1fr 320px 240px; }
  }
  @media (max-width: 1100px) {
    .main-layout { grid-template-columns: 1fr 280px; }
    .far-right { display: none; }
    .stats-bar { grid-template-columns: repeat(4, 1fr); }
  }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Ticker Bar ‚îÄ‚îÄ -->
<div class="ticker-bar" id="ticker-bar">
  <span class="ticker-item" id="t-btc"><span class="ticker-sym">BTC</span><span class="ticker-price">‚Äì</span><span class="ticker-chg">‚Äì</span></span>
  <span class="ticker-item" id="t-eth"><span class="ticker-sym">ETH</span><span class="ticker-price">‚Äì</span><span class="ticker-chg">‚Äì</span></span>
  <span class="ticker-item" id="t-sol"><span class="ticker-sym">SOL</span><span class="ticker-price">‚Äì</span><span class="ticker-chg">‚Äì</span></span>
  <span class="ticker-item" id="t-bnb"><span class="ticker-sym">BNB</span><span class="ticker-price">‚Äì</span><span class="ticker-chg">‚Äì</span></span>
  <span class="ticker-item" id="t-xrp"><span class="ticker-sym">XRP</span><span class="ticker-price">‚Äì</span><span class="ticker-chg">‚Äì</span></span>
</div>

<!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
<header>
  <div>
    <div class="logo">AI TRADING BOT<small>BINANCE FUTURES ¬∑ REAL DATA ¬∑ SIMULATED</small></div>
  </div>

  <div class="header-meta">
    <div class="hm-stat">
      <div class="hm-label">Bakiye</div>
      <div class="hm-value cyan" id="header-balance">$0.00</div>
    </div>
    <div class="hm-stat">
      <div class="hm-label">PNL</div>
      <div class="hm-value green" id="header-pnl">+$0.00</div>
    </div>
    <div class="hm-stat">
      <div class="hm-label">Win Rate</div>
      <div class="hm-value" id="header-wr" style="color:var(--yellow)">‚Äì</div>
    </div>
    <div class="hm-stat">
      <div class="hm-label">Drawdown</div>
      <div class="hm-value red" id="header-dd">‚Äì</div>
    </div>
    <div class="hm-stat">
      <div class="hm-label">P.Factor</div>
      <div class="hm-value" id="header-pf" style="color:var(--purple)">‚Äì</div>
    </div>
  </div>

  <div class="header-controls">
    <div class="status-pill">
      <div class="dot offline" id="conn-dot"></div>
      <span id="conn-label">Baƒülanƒ±yor...</span>
    </div>
    <button class="btn-start" id="header-agent-btn" onclick="toggleAgent(true)">‚ñ∂ BA≈ûLAT</button>
    <button class="btn-stop" onclick="ctrlCloseAll()">‚ñ† DURDUR</button>
  </div>
</header>

<!-- ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ -->
<div class="stats-bar">
  <div class="stat-item">
    <div class="stat-lbl">Portf√∂y</div>
    <div class="stat-val cyan" id="balance-val">$0.00</div>
    <div class="stat-sub" id="balance-start">Ba≈ülangƒ±√ß: ‚Äì</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">Toplam PNL</div>
    <div class="stat-val green" id="pnl-val">+$0.00</div>
    <div class="stat-sub" id="pnl-pct">+0.00%</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">Win Rate</div>
    <div class="stat-val yellow" id="winrate-val">‚Äì</div>
    <div class="stat-sub" id="winrate-sub">W: ‚Äì / L: ‚Äì</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">Profit Factor</div>
    <div class="stat-val purple" id="pf-val">‚Äì</div>
    <div class="stat-sub">Kazan√ß / Kayƒ±p</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">Drawdown</div>
    <div class="stat-val red" id="dd-val">‚Äì</div>
    <div class="stat-sub">Zirve d√º≈ü√º≈ü</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">A√ßƒ±k Poz.</div>
    <div class="stat-val" id="open-pos-val" style="color:var(--purple)">0</div>
    <div class="stat-sub" id="max-pos-sub">Maks ‚Äì pozisyon</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">ƒ∞≈ülem Sayƒ±sƒ±</div>
    <div class="stat-val cyan" id="daily-trades-val">0</div>
    <div class="stat-sub">Toplam trade</div>
  </div>
  <div class="stat-item">
    <div class="stat-lbl">Coin Sayƒ±sƒ±</div>
    <div class="stat-val" id="market-count" style="color:var(--text)">‚Äì</div>
    <div class="stat-sub">Futures √ßiftleri</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ -->
<div class="main-layout">

  <!-- ‚ïê‚ïê CENTER PANEL ‚ïê‚ïê -->
  <div class="center-panel">
    <div class="tabs">
      <div class="tab active" data-tab="overview">Piyasa</div>
      <div class="tab" data-tab="positions">Pozisyonlar</div>
      <div class="tab" data-tab="signals">Sinyaller</div>
      <div class="tab" data-tab="control">‚öô Kontrol</div>
    </div>

    <!-- OVERVIEW / PIYASA TAB -->
    <div class="panel-content active" id="tab-overview">
      <!-- Piyasa grid -->
      <div class="piyasa-header">
        <input type="text" id="market-search-input" placeholder="Coin ara..." oninput="filterMarket(this.value)" />
        <button class="sort-btn active" onclick="sortMarket('pct')">% DEƒûƒ∞≈ûƒ∞M</button>
        <button class="sort-btn" onclick="sortMarket('vol')">HACƒ∞M</button>
        <button class="sort-btn" onclick="sortMarket('name')">ƒ∞Sƒ∞M</button>
      </div>

      <div class="coin-grid" id="market-list">
        <div class="loading-text"><span class="spinner"></span> Y√ºkleniyor...</div>
      </div>

      <!-- Chart + Strategy area -->
      <div class="chart-area">
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-sym" id="chart-sym-label">AXS/USDT</span>
            <div style="display:flex;align-items:center;gap:8px">
              <span id="chart-pnl-toggle" style="font-size:10px;color:var(--text3);cursor:pointer">PNL</span>
              <span style="font-size:10px;color:var(--cyan);cursor:pointer">Fƒ∞YAT</span>
            </div>
            <div class="period-btns">
              <button class="period-btn active">1m</button>
              <button class="period-btn">3m</button>
              <button class="period-btn">5m</button>
              <button class="period-btn">15m</button>
              <button class="period-btn">1h</button>
              <button class="period-btn">4h</button>
            </div>
          </div>
          <div class="chart-body">
            <span id="chart-placeholder" style="text-align:center">
              <div style="font-size:22px;margin-bottom:6px">üìä</div>
              <div>Grafik verisi y√ºkleniyor...</div>
              <div style="margin-top:8px;font-size:10px;color:var(--text3)" id="chart-price-footer">Fiyat: ‚Äì</div>
            </span>
          </div>
        </div>

        <div class="strategy-card">
          <div class="strategy-header">
            <span class="strategy-title">Strateji √ñƒürenimi</span>
            <span class="live-badge">CANLI</span>
            <span class="best-badge" id="best-strategy-badge">EN ƒ∞Yƒ∞: ‚Äì</span>
          </div>
          <div class="strategy-list" id="strategy-list">
            <div class="strategy-row">
              <span class="strat-name">Mean Reversion <span class="live-badge" style="font-size:8px">EN ƒ∞Yƒ∞</span></span>
              <div class="strat-bar-wrap"><div class="strat-bar-bg"><div class="strat-bar-fill" id="sb-mr" style="width:38%;background:var(--cyan)"></div></div></div>
              <span class="strat-wr" id="sw-mr">38.1% WR</span>
              <span class="strat-pf" id="spf-mr">1.66</span>
            </div>
            <div class="strategy-row">
              <span class="strat-name">Breakout</span>
              <div class="strat-bar-wrap"><div class="strat-bar-bg"><div class="strat-bar-fill" id="sb-bo" style="width:33%;background:var(--green)"></div></div></div>
              <span class="strat-wr" id="sw-bo">33.3% WR</span>
              <span class="strat-pf" id="spf-bo">1.42</span>
            </div>
            <div class="strategy-row">
              <span class="strat-name">Trend Following</span>
              <div class="strat-bar-wrap"><div class="strat-bar-bg"><div class="strat-bar-fill" id="sb-tf" style="width:30%;background:var(--yellow)"></div></div></div>
              <span class="strat-wr" id="sw-tf">30.4% WR</span>
              <span class="strat-pf" id="spf-tf">1.30</span>
            </div>
            <div class="strategy-row">
              <span class="strat-name">Scalping</span>
              <div class="strat-bar-wrap"><div class="strat-bar-bg"><div class="strat-bar-fill" id="sb-sc" style="width:15%;background:var(--orange)"></div></div></div>
              <span class="strat-wr" id="sw-sc">15.4% WR</span>
              <span class="strat-pf" id="spf-sc">0.70</span>
            </div>
            <div class="strategy-row">
              <span class="strat-name">VWAP Bounce</span>
              <div class="strat-bar-wrap"><div class="strat-bar-bg"><div class="strat-bar-fill" id="sb-vw" style="width:11%;background:var(--red)"></div></div></div>
              <span class="strat-wr" id="sw-vw">11.1% WR</span>
              <span class="strat-pf" id="spf-vw">0.70</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- POSITIONS TAB -->
    <div class="panel-content" id="tab-positions">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="color:var(--text3);font-size:10px;letter-spacing:0.12em;text-transform:uppercase">A√ßƒ±k Pozisyonlar</span>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="pos-total-pnl" style="font-size:12px;font-weight:600;color:var(--text3)">PNL: ‚Äì</span>
          <button class="btn-secondary" onclick="loadPositions()">‚Üª Yenile</button>
        </div>
      </div>
      <div id="positions-content">
        <div class="loading-text"><span class="spinner"></span></div>
      </div>
    </div>

    <!-- SIGNALS TAB -->
    <div class="panel-content" id="tab-signals">
      <div class="ctrl-card" id="agent-activity-card">
        <div class="ctrl-title">ü§ñ Ajan Aktivitesi</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px">
          <div class="agent-cell">
            <div class="agent-cell-label">Durum</div>
            <div class="agent-cell-val" id="sig-agent-status" style="color:var(--text3)">‚Äì</div>
          </div>
          <div class="agent-cell">
            <div class="agent-cell-label">ƒ∞≈ülem Sayƒ±sƒ±</div>
            <div class="agent-cell-val cyan" id="sig-trade-count">0</div>
          </div>
          <div class="agent-cell">
            <div class="agent-cell-label">RL Epsilon</div>
            <div class="agent-cell-val yellow" id="sig-epsilon">‚Äì</div>
          </div>
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:8px 12px;display:flex;justify-content:space-between">
          <span style="font-size:11px;color:var(--text2)">Taranan semboller:</span>
          <span id="sig-symbols" style="font-size:11px;color:var(--cyan)">BTC, ETH, SOL, BNB, XRP</span>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span style="color:var(--text3);font-size:10px;letter-spacing:0.12em;text-transform:uppercase">Son Sinyaller</span>
        <button class="btn-secondary" onclick="refreshStatus()">‚Üª Yenile</button>
      </div>
      <div id="signals-content">
        <div class="empty-state"><div>üìä</div>Sinyal bekleniyor...</div>
      </div>
    </div>

    <!-- CONTROL TAB -->
    <div class="panel-content" id="tab-control">
      <div class="ctrl-card">
        <div class="ctrl-title">üß™ ƒ∞≈ülem Testi</div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Sembol</div>
            <input type="text" id="test-symbol" value="BTCUSDT" oninput="ctrlUpdateTestPreview()" />
          </div>
          <div>
            <div class="ctrl-label">Y√∂n</div>
            <select id="test-side" onchange="ctrlUpdateTestPreview()">
              <option value="BUY">LONG</option>
              <option value="SELL">SHORT</option>
            </select>
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Miktar (USDT)</div>
            <input type="number" id="test-qty" value="100" oninput="ctrlUpdateTestPreview()" />
          </div>
          <div>
            <div class="ctrl-label">Kaldƒ±ra√ß</div>
            <input type="number" id="test-lev" value="3" min="1" max="20" oninput="ctrlUpdateTestPreview()" />
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">SL %</div>
            <input type="number" id="test-sl" value="1.5" step="0.1" oninput="ctrlUpdateTestPreview()" />
          </div>
          <div>
            <div class="ctrl-label">TP %</div>
            <input type="number" id="test-tp" value="3.0" step="0.1" oninput="ctrlUpdateTestPreview()" />
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Emir Tipi</div>
            <select id="test-order-type" onchange="ctrlUpdateTestPreview()">
              <option value="MARKET">MARKET</option>
              <option value="LIMIT">LIMIT</option>
            </select>
          </div>
          <div style="display:flex;align-items:flex-end">
            <div id="test-preview" style="font-size:10px;color:var(--text3)">‚Äì</div>
          </div>
        </div>
        <div id="test-result" style="display:none;margin-top:8px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <button class="btn-long" id="ctrl-btn-long" onclick="ctrlOpenTrade('BUY')" style="font-size:12px;padding:9px">‚ñ≤ LONG</button>
          <button class="btn-short" id="ctrl-btn-short" onclick="ctrlOpenTrade('SELL')" style="font-size:12px;padding:9px">‚ñº SHORT</button>
        </div>
        <button class="btn-danger" onclick="ctrlCloseAll()" style="margin-top:6px">üõë T√ºm Pozisyonlarƒ± Kapat</button>
      </div>

      <div class="ctrl-card">
        <div class="ctrl-title">‚öôÔ∏è Ajan Ayarlarƒ±</div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">G√ºnl√ºk Max. Kayƒ±p %</div>
            <input type="number" id="ctrl-daily-loss" value="3" step="0.5" onchange="ctrlUpdateAgentPreview()" />
          </div>
          <div>
            <div class="ctrl-label">Max Drawdown %</div>
            <input type="number" id="ctrl-drawdown" value="15" step="1" onchange="ctrlUpdateAgentPreview()" />
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Risk per Trade %</div>
            <input type="number" id="ctrl-risk-per-trade" value="1" step="0.1" onchange="ctrlUpdateAgentPreview()" />
          </div>
          <div>
            <div class="ctrl-label">Max Pozisyon</div>
            <input type="number" id="ctrl-max-pos" value="5" min="1" max="20" onchange="ctrlUpdateAgentPreview()" />
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Tarama Aralƒ±ƒüƒ± (dk)</div>
            <input type="number" id="ctrl-scan-interval" value="15" min="1" max="60" onchange="ctrlUpdateAgentPreview()" />
          </div>
          <div>
            <div class="ctrl-label">Min. Sinyal Skoru</div>
            <input type="number" id="ctrl-min-score" value="0.15" step="0.05" onchange="ctrlUpdateAgentPreview()" />
          </div>
        </div>
        <div class="ctrl-row">
          <div>
            <div class="ctrl-label">Kill-switch (ard. kayƒ±p)</div>
            <input type="number" id="ctrl-kill-switch" value="5" min="1" onchange="ctrlUpdateAgentPreview()" />
          </div>
          <div>
            <div class="ctrl-label">RL Epsilon</div>
            <input type="number" id="ctrl-rl-eps" value="0.15" step="0.05" onchange="ctrlUpdateAgentPreview()" />
          </div>
        </div>
        <div id="ctrl-agent-preview" style="font-size:10px;color:var(--text3);margin:8px 0;padding:8px;background:var(--bg3);border-radius:4px">‚Äì</div>
        <button class="btn-primary" id="ctrl-btn-save-agent" onclick="ctrlSaveAgent()">üíæ Ayarlarƒ± Uygula</button>

        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:11px;color:var(--text2)">Otomatik Ajan</span>
            <label class="toggle-switch">
              <input type="checkbox" id="ctrl-agent-toggle" onchange="toggleAgent(this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div id="ctrl-agent-status-text" style="font-size:11px;color:var(--text3)">‚èπ Ajan durduruldu</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê RIGHT PANEL (Trade Form + Agent) ‚ïê‚ïê -->
  <div class="right-panel">
    <!-- Trade Form -->
    <div class="trade-form">
      <div class="form-title">ƒ∞≈ülem A√ß</div>

      <div class="symbol-display" onclick="openMarketModal()">
        <div>
          <div class="symbol-name" id="selected-symbol">BTCUSDT</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">Sembol se√ß ‚Üí</div>
        </div>
        <div class="symbol-price" id="current-price">‚Äì</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">Miktar (USDT)</div>
          <input type="number" id="qty-input" value="100" min="5" step="10" />
        </div>
        <div class="form-group">
          <div class="form-label">Emir Tipi</div>
          <select id="order-type">
            <option value="MARKET">Market</option>
            <option value="LIMIT">Limit</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">Kaldƒ±ra√ß</div>
          <input type="number" id="leverage-input" value="3" min="1" max="20" step="1" />
        </div>
        <div style="display:flex;align-items:flex-end;padding-bottom:1px;">
          <span style="font-size:10px;color:var(--text3)">Max: <span id="max-lev-label" style="color:var(--yellow)">20x</span></span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <div class="form-label">SL %</div>
          <input type="number" id="sl-input" value="1.5" min="0.1" max="10" step="0.1" />
        </div>
        <div class="form-group">
          <div class="form-label">TP %</div>
          <input type="number" id="tp-input" value="3.0" min="0.1" max="20" step="0.1" />
        </div>
      </div>

      <div class="pnl-preview-row">
        <span class="pnl-preview-label">max TP</span>
        <span id="pnl-preview">+$0.00</span>
      </div>

      <button class="btn-long" id="btn-long" onclick="handleLong()">‚ñ≤ LONG ƒ∞≈ûLEM A√á</button>
      <button class="btn-short" id="btn-short" onclick="handleShort()">‚ñº SHORT ƒ∞≈ûLEM A√á</button>
    </div>

    <!-- Agent Section -->
    <div class="agent-section">
      <div class="agent-toggle">
        <span class="agent-label">Otomatik Ajan</span>
        <label class="toggle-switch">
          <input type="checkbox" id="agent-toggle" onchange="toggleAgent(this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="agent-grid">
        <div class="agent-cell">
          <div class="agent-cell-label">Durum</div>
          <div class="agent-cell-val" id="agent-status-val" style="color:var(--text3)">Pasif</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">ƒ∞≈ülem Sayƒ±sƒ±</div>
          <div class="agent-cell-val cyan" id="agent-trade-count">0</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">Tarama</div>
          <div class="agent-cell-val" id="agent-scan-interval">15 dk</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">RL Epsilon</div>
          <div class="agent-cell-val yellow" id="agent-epsilon">‚Äì</div>
        </div>
      </div>
    </div>

    <!-- Futures Market List (compact) -->
    <div class="market-section">
      <div class="section-title">
        Futures Piyasalarƒ±
        <span id="market-count2" style="color:var(--cyan);font-family:var(--sans);font-size:13px;font-weight:700">‚Äì</span>
      </div>
      <div class="market-search">
        <input type="text" placeholder="Sembol ara... (BTC, ETH...)" oninput="filterMarket(this.value)" />
      </div>
      <div class="market-list" id="market-list-right">
        <div class="loading-text"><span class="spinner"></span></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê FAR RIGHT: Logs + Signals ‚ïê‚ïê -->
  <div class="far-right">
    <div class="far-right-tabs">
      <div class="far-tab active" onclick="switchFarTab('logs', this)">Loglar</div>
      <div class="far-tab" onclick="switchFarTab('overview-signals', this)">Sinyaller</div>
    </div>

    <!-- Logs Panel -->
    <div class="far-panel active" id="far-panel-logs">
      <div class="log-toolbar">
        <button class="log-filter-btn active" data-level="all" onclick="setLogFilter('all',this)">T√ºm√º</button>
        <button class="log-filter-btn" data-level="error" onclick="setLogFilter('error',this)">Hata</button>
        <button class="log-filter-btn" data-level="warn" onclick="setLogFilter('warn',this)">Uyarƒ±</button>
        <button class="log-filter-btn" data-level="ok" onclick="setLogFilter('ok',this)">Ba≈üarƒ±</button>
        <button class="log-filter-btn" data-level="agent" onclick="setLogFilter('agent',this)">ü§ñ Ajan</button>
        <button class="btn-secondary" onclick="fetchLogs()" style="margin-left:auto;font-size:10px;padding:3px 8px">‚Üª</button>
        <button class="btn-secondary" onclick="clearLogs()" style="font-size:10px;padding:3px 8px">üóë</button>
        <label style="font-size:10px;color:var(--text3);display:flex;align-items:center;gap:4px;cursor:pointer">
          <input type="checkbox" id="log-auto-refresh" checked style="width:11px;height:11px"> Otomatik
        </label>
      </div>
      <div class="log-area" id="log-area">
        <div class="log-line info"><span class="log-time">--:--:--</span>Sistem ba≈ülatƒ±lƒ±yor...</div>
      </div>
    </div>

    <!-- Signals Overview Panel -->
    <div class="far-panel" id="far-panel-overview-signals">
      <!-- Overview stats mini -->
      <div style="padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg2)">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
          <div class="agent-cell">
            <div class="agent-cell-label">Piyasa Rejimi</div>
            <div class="agent-cell-val" id="regime-val" style="color:var(--green)">‚Äì</div>
          </div>
          <div class="agent-cell">
            <div class="agent-cell-label">ATR</div>
            <div class="agent-cell-val" id="atr-sub" style="font-size:12px">‚Äì</div>
          </div>
          <div class="agent-cell">
            <div class="agent-cell-label">Margin Kull.</div>
            <div class="agent-cell-val" id="margin-val2">‚Äì</div>
          </div>
          <div class="agent-cell">
            <div class="agent-cell-label">G√ºnl√ºk ƒ∞≈ülem</div>
            <div class="agent-cell-val cyan" id="daily-trades-val2">0</div>
          </div>
        </div>
      </div>

      <div style="padding:10px 12px;overflow-y:auto;flex:1">
        <div style="font-size:10px;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;margin-bottom:8px">Son Otomatik Sinyal</div>
        <div id="last-signal-content">
          <div class="empty-state"><div>üì°</div>Sinyal bekleniyor...</div>
        </div>
        <div style="font-size:10px;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;margin:12px 0 8px">Risk Durumu</div>
        <div id="risk-content"></div>
        <div style="font-size:10px;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;margin:12px 0 8px">A√ßƒ±k Pozisyonlar (√ñzet)</div>
        <div id="overview-positions-list"></div>
      </div>
    </div>
  </div>

</div>

<!-- ‚îÄ‚îÄ Market Select Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="market-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeMarketModal()">‚úï</button>
    <div class="modal-title">Sembol Se√ß</div>
    <input type="text" id="modal-search" placeholder="BTC, ETH, SOL..." oninput="filterModal(this.value)" style="margin-bottom:10px" />
    <div id="modal-list" style="max-height:300px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Toast Container ‚îÄ‚îÄ -->
<div id="toast-container"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function extractErrorMessage(response) {
  if (!response) return "Bilinmeyen hata";
  if (typeof response === "string") return response;
  if (response.reason)  return String(response.reason);
  if (response.message) return String(response.message);
  if (response.detail) {
    if (Array.isArray(response.detail))
      return response.detail.map(e => e.msg || JSON.stringify(e)).join(", ");
    return String(response.detail);
  }
  try { return JSON.stringify(response); } catch { return "Hata"; }
}

function showToast(message, type = "error") {
  const icons = { error: "‚úï", success: "‚úì", info: "‚Ñπ", warn: "‚ö†" };
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]||"‚Ä¢"}</span><span class="toast-msg">${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.animation = 'fadeOut 0.4s ease forwards'; setTimeout(() => toast.remove(), 400); }, 3600);
}

async function apiFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...options,
    });
    let data;
    try { data = await res.json(); }
    catch { data = { ok: false, reason: await res.text().catch(() => "Parse error") }; }

    if (!res.ok || data?.ok === false) {
      const msg = extractErrorMessage(data);
      showToast(msg, "error");
      return { ok: false, reason: msg, _raw: data };
    }
    return { ok: true, ...data };
  } catch (err) {
    const msg = err?.message || "Aƒü baƒülantƒ± hatasƒ±";
    showToast(msg, "error");
    return { ok: false, reason: msg };
  }
}

function fmt(val, decimals = 2) {
  if (val === null || val === undefined || val === "‚Äì") return "‚Äì";
  const n = parseFloat(val);
  if (isNaN(n)) return String(val);
  return n.toFixed(decimals);
}

function fmtUSD(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "‚Äì";
  const sign = n >= 0 ? "+" : "";
  return sign + "$" + Math.abs(n).toFixed(2);
}

function fmtPrice(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "‚Äì";
  if (n >= 1000) return n.toFixed(2);
  if (n >= 1)    return n.toFixed(4);
  return n.toFixed(6);
}

function colorClass(val) {
  const n = parseFloat(val);
  if (isNaN(n) || n === 0) return "";
  return n > 0 ? "green" : "red";
}

function timeAgo(isoStr) {
  if (!isoStr) return "‚Äì";
  try {
    const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
    if (diff < 60)   return Math.round(diff) + "s √∂nce";
    if (diff < 3600) return Math.round(diff/60) + "dk √∂nce";
    return Math.round(diff/3600) + "sa √∂nce";
  } catch { return "‚Äì"; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let state = {
  symbol: "BTCUSDT",
  price: 0,
  allSymbols: [],
  filteredSymbols: [],
  positions: [],
  signalHistory: [],
  agentRunning: false,
  marketPrices: {},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".panel-content").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
    if (tab.dataset.tab === "positions") loadPositions();
    if (tab.dataset.tab === "logs") fetchLogs();
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS / OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function refreshStatus() {
  try {
    const res = await fetch("/status/overview");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // Connection
    document.getElementById("conn-dot").className = "dot online";
    document.getElementById("conn-label").textContent = "Online";

    // Header
    const bal = data.balance ?? data.wallet_balance ?? 0;
    document.getElementById("header-balance").textContent = "$" + parseFloat(bal).toFixed(2);

    // Stats
    document.getElementById("balance-val").textContent = "$" + parseFloat(bal).toFixed(2);
    const pnl = data.unrealized_pnl ?? data.total_pnl ?? 0;
    const pnlEl = document.getElementById("pnl-val");
    pnlEl.textContent = fmtUSD(pnl);
    pnlEl.className = "stat-val " + colorClass(pnl);

    const pnlPct = bal > 0 ? (pnl / bal * 100) : 0;
    document.getElementById("pnl-pct").textContent = (pnlPct >= 0 ? "+" : "") + pnlPct.toFixed(2) + "%";

    document.getElementById("open-pos-val").textContent = data.open_positions ?? 0;
    document.getElementById("daily-trades-val").textContent = data.daily_trades ?? 0;

    // New stats elements
    const dt2 = document.getElementById("daily-trades-val2");
    if (dt2) dt2.textContent = data.daily_trades ?? 0;
    const risk = data.risk ?? {};
    const marginEl = document.getElementById("margin-val2");
    if (marginEl) marginEl.textContent = (parseFloat(risk.margin_usage_pct || data.margin_usage_pct || 0)).toFixed(1) + "%";
    const maxPosEl = document.getElementById("max-pos-sub");
    if (maxPosEl) maxPosEl.textContent = "Maks " + (risk.max_positions || 5) + " pozisyon";

    // Update header stats
    updateHeaderStats(data);

    const dailyPnl = data.daily_pnl ?? 0;
    const dailySub = document.getElementById("daily-pnl-sub");
    dailySub.textContent = fmtUSD(dailyPnl);
    dailySub.style.color = dailyPnl >= 0 ? "var(--green)" : "var(--red)";

    // Signal engine
    const se = data.signal_engine ?? {};
    document.getElementById("signal-count-val").textContent = se.signal_count ?? 0;
    document.getElementById("agent-trade-count").textContent = se.signal_count ?? 0;
    document.getElementById("agent-scan-interval").textContent = (se.scan_interval_min ?? 15) + " dk";

    if (se.running !== undefined) {
      state.agentRunning = se.running;
      document.getElementById("agent-toggle").checked = se.running;
      const agentStatusEl = document.getElementById("agent-status-val");
      agentStatusEl.textContent = se.running ? "Aktif" : "Pasif";
      agentStatusEl.style.color = se.running ? "var(--green)" : "var(--text3)";
      // Kontrol paneli g√ºncelle
      const ctrlToggle = document.getElementById("ctrl-agent-toggle");
      if (ctrlToggle) ctrlToggle.checked = se.running;
      const ctrlStatusText = document.getElementById("ctrl-agent-status-text");
      if (ctrlStatusText) {
        ctrlStatusText.textContent = se.running ? "‚úÖ Ajan √ßalƒ±≈üƒ±yor" : "‚èπ Ajan durduruldu";
        ctrlStatusText.style.color = se.running ? "var(--green)" : "var(--text3)";
      }
    }

    // RL agent
    const rl = data.rl_agent ?? {};
    document.getElementById("agent-epsilon").textContent = rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "‚Äì";

    // Sinyaller sekmesi ajan paneli g√ºncelle
    const sigStatus = document.getElementById("sig-agent-status");
    if (sigStatus) {
      const isRunning = se.running ?? false;
      sigStatus.textContent = isRunning ? "‚úÖ √áalƒ±≈üƒ±yor" : "‚èπ Durduruldu";
      sigStatus.style.color = isRunning ? "var(--green)" : "var(--text3)";
    }
    const sigCount = document.getElementById("sig-trade-count");
    if (sigCount) sigCount.textContent = se.signal_count ?? se.trade_count ?? 0;
    const sigEps = document.getElementById("sig-epsilon");
    if (sigEps) sigEps.textContent = rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "‚Äì";

    // Regime
    const regime = data.regime ?? data.market_regime ?? "‚Äì";
    const regimeEl = document.getElementById("regime-val");
    regimeEl.textContent = regime;
    regimeEl.className = "stat-val";
    if (regime === "trend")    regimeEl.style.color = "var(--green)";
    else if (regime === "range") regimeEl.style.color = "var(--yellow)";
    else regimeEl.style.color = "var(--text)";

    const atrVal = data.atr_14 ?? data.atr ?? 0;
    document.getElementById("atr-sub").textContent = "ATR: " + fmtPrice(atrVal);

    // Price
    const price = data.mark_price ?? data.last_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }

    // Last signal
    renderLastSignal(se.last_signal);

    // Risk
    renderRisk(data);

  } catch (err) {
    document.getElementById("conn-dot").className = "dot offline";
    document.getElementById("conn-label").textContent = "Baƒülantƒ± yok";
    addLog("Durum g√ºncellenemedi: " + (err?.message || err), "warn");
  }
}

function renderLastSignal(sig) {
  const el = document.getElementById("last-signal-content");
  const timeEl = document.getElementById("last-signal-time");
  if (!sig || !sig.time) {
    el.innerHTML = '<div class="empty-state"><div>üì°</div>Sinyal bekleniyor...</div>';
    return;
  }
  timeEl.textContent = timeAgo(sig.time);
  const side = sig.side;
  const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
  const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
  const score = parseFloat(sig.score || 0);
  const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
  const fillClass = score > 0 ? "positive" : score < 0 ? "negative" : "positive";

  // Push to history
  if (sig.time && !state.signalHistory.find(s => s.time === sig.time)) {
    state.signalHistory.unshift(sig);
    if (state.signalHistory.length > 50) state.signalHistory.pop();
    renderSignalsTab();
  }

  const detailsHtml = (sig.details || []).slice(0, 5).map(d =>
    `<div class="signal-detail-row"><span>${d}</span></div>`
  ).join("");

  el.innerHTML = `
    <div class="signal-card" style="margin-bottom:0">
      <div class="signal-header">
        <div class="signal-symbol">${sig.symbol || state.symbol}</div>
        <div class="signal-side ${sideClass}">${sideLabel}</div>
      </div>
      <div class="signal-score-bar">
        <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px">
        <span>Skor: <strong style="color:var(--text)">${score >= 0 ? "+" : ""}${score.toFixed(3)}</strong></span>
        <span>G√º√ß: <strong style="color:var(--text)">${sig.strength || "‚Äì"}</strong></span>
      </div>
      ${detailsHtml ? `<div class="signal-details open">${detailsHtml}</div>` : ""}
    </div>`;
}

function renderSignalsTab() {
  const el = document.getElementById("signals-content");
  if (!state.signalHistory.length) {
    el.innerHTML = '<div class="empty-state"><div>üìä</div>Sinyal bekleniyor...</div>';
    return;
  }
  el.innerHTML = state.signalHistory.map(sig => {
    const side = sig.side;
    const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
    const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
    const score = parseFloat(sig.score || 0);
    const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
    const fillClass = score > 0 ? "positive" : "negative";
    return `
      <div class="signal-card">
        <div class="signal-header">
          <div class="signal-symbol" style="font-size:13px">${sig.symbol || "‚Äì"}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
            <div class="signal-side ${sideClass}">${sideLabel}</div>
          </div>
        </div>
        <div class="signal-score-bar">
          <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:10px;color:var(--text3)">Skor: ${score >= 0 ? "+" : ""}${score.toFixed(3)} ¬∑ ${sig.strength || ""}</div>
      </div>`;
  }).join("");
}

function renderRisk(data) {
  const el = document.getElementById("risk-content");
  const risk = data.risk ?? {};
  const maxPos = risk.max_positions ?? data.max_positions ?? 5;
  const openPos = data.open_positions ?? 0;
  const margin = risk.margin_usage_pct ?? data.margin_usage_pct ?? 0;
  const marginPct = parseFloat(margin).toFixed(1);
  const marginColor = marginPct > 70 ? "var(--red)" : marginPct > 40 ? "var(--yellow)" : "var(--green)";

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="agent-info-item">
        <div class="agent-info-label">Pozisyon Kullanƒ±mƒ±</div>
        <div class="agent-info-value">${openPos} / ${maxPos}</div>
      </div>
      <div class="agent-info-item">
        <div class="agent-info-label">Margin Kullanƒ±mƒ±</div>
        <div class="agent-info-value" style="color:${marginColor}">${marginPct}%</div>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OVERVIEW POZƒ∞SYON √ñZETƒ∞
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function refreshOverviewPositions() {
  try {
    const result = await apiFetch("/execution/positions/live");
    const positions = (result.ok ? result.positions : null) || [];
    state.positions = positions;

    const list = document.getElementById("overview-positions-list");
    const wrap = document.getElementById("overview-positions-wrap");
    document.getElementById("open-pos-val").textContent = positions.length;

    if (!positions.length) {
      if (wrap) wrap.style.display = "none";
      if (list) list.innerHTML = '<div style="color:var(--text3);font-size:11px;padding:8px 0">A√ßƒ±k pozisyon yok</div>';
      return;
    }
    if (wrap) wrap.style.display = "block";

    list.innerHTML = positions.map(pos => {
      const pnl    = parseFloat(pos.unrealized_pnl ?? 0);
      const pnlPct = parseFloat(pos.pnl_pct ?? 0);
      const isLong = (pos.side || "").toUpperCase() === "LONG";
      const sideColor = isLong ? "var(--green)" : "var(--red)";
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="color:#fff;font-weight:600">${pos.symbol}</span>
            <span style="color:${sideColor};font-size:10px;font-weight:700">${pos.side}</span>
            <span style="color:var(--yellow);font-size:10px">${pos.leverage}x</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div style="font-size:11px;color:var(--text2)">Giri≈ü: ${fmtPrice(pos.entry_price)}</div>
              <div style="font-size:10px;color:var(--text3)">Mark: ${fmtPrice(pos.mark_price)}</div>
            </div>
            <div style="text-align:right;min-width:70px">
              <div style="font-size:13px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
              <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
            </div>
            <button onclick="closePosition('${pos.symbol}','${pos.side}')"
              style="padding:4px 8px;background:rgba(255,61,87,0.1);border:1px solid rgba(255,61,87,0.3);color:var(--red);font-family:var(--mono);font-size:10px;border-radius:4px;cursor:pointer">
              Kapat
            </button>
          </div>
        </div>`;
    }).join("");
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  POSITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadPositions() {
  const el = document.getElementById("positions-content");
  el.innerHTML = '<div class="loading-text"><span class="spinner"></span> Binance\'den y√ºkleniyor...</div>';

  // √ñnce canlƒ± endpoint'i dene, olmazsa eski endpoint
  let result = await apiFetch("/execution/positions/live");
  if (!result.ok) result = await apiFetch("/execution/positions");

  if (!result.ok) {
    el.innerHTML = `<div class="empty-state"><div>‚ö†</div>${result.reason || "Baƒülantƒ± hatasƒ±"}</div>`;
    return;
  }

  const positions = result.positions || [];
  state.positions = positions;
  document.getElementById("open-pos-val").textContent = positions.length;

  // Toplam PNL hesapla
  const totalPnl = positions.reduce((s, p) => s + parseFloat(p.unrealized_pnl ?? 0), 0);
  const pnlEl = document.getElementById("pos-total-pnl");
  if (pnlEl) {
    pnlEl.textContent = `PNL: ${totalPnl >= 0 ? "+" : ""}$${Math.abs(totalPnl).toFixed(2)}`;
    pnlEl.style.color = totalPnl >= 0 ? "var(--green)" : "var(--red)";
  }

  if (!positions.length) {
    el.innerHTML = '<div class="empty-state"><div>üîç</div>A√ßƒ±k pozisyon yok</div>';
    return;
  }

  el.innerHTML = positions.map(pos => {
    const pnl     = parseFloat(pos.unrealized_pnl ?? 0);
    const pnlPct  = parseFloat(pos.pnl_pct ?? 0);
    const side    = (pos.side || "‚Äì").toUpperCase();
    const isLong  = side === "LONG" || side === "BUY";
    const sideColor = isLong ? "var(--green)" : "var(--red)";
    const sideBg    = isLong ? "rgba(0,230,118,0.1)" : "rgba(255,61,87,0.1)";
    const liq     = parseFloat(pos.liquidation_price ?? 0);
    const margin  = parseFloat(pos.margin ?? 0);
    const notional= parseFloat(pos.notional ?? 0);

    return `
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;">
      <!-- Ba≈ülƒ±k satƒ±rƒ± -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:var(--sans);font-size:15px;font-weight:700;color:#fff">${pos.symbol || "‚Äì"}</span>
          <span style="background:${sideBg};color:${sideColor};border:1px solid ${sideColor}33;border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:0.05em">${side}</span>
          <span style="background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:10px;color:var(--yellow)">${pos.leverage ?? 1}x</span>
        </div>
        <div style="text-align:right">
          <div style="font-size:15px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
          <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
        </div>
      </div>

      <!-- Detay grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Giri≈ü</div>
          <div style="font-size:12px;color:var(--text)">${fmtPrice(pos.entry_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Mark</div>
          <div style="font-size:12px;color:var(--cyan)">${fmtPrice(pos.mark_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Liq.</div>
          <div style="font-size:12px;color:${liq > 0 ? "var(--red)" : "var(--text3)"}">${liq > 0 ? fmtPrice(liq) : "‚Äì"}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Miktar</div>
          <div style="font-size:12px;color:var(--text)">${fmt(pos.contracts ?? 0, 4)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Notional</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(notional, 2)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Margin</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(margin, 2)}</div>
        </div>
      </div>

      <!-- Kapat butonu -->
      <button onclick="closePosition('${pos.symbol}','${side}')"
        style="width:100%;padding:8px;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.25);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;transition:all 0.15s;font-weight:600"
        onmouseover="this.style.background='rgba(255,61,87,0.2)'"
        onmouseout="this.style.background='rgba(255,61,87,0.08)'">
        üõë ${pos.symbol} Pozisyonunu Kapat
      </button>
    </div>`;
  }).join("");
}

async function closePosition(symbol, side) {
  if (!confirm(`${symbol} ${side} pozisyonunu kapatmak istediƒüinize emin misiniz?`)) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol, side }),
  });
  if (result.ok) {
    showToast(`‚úÖ ${symbol} pozisyonu kapatƒ±ldƒ±`, "success");
    addLog(`Pozisyon kapatƒ±ldƒ±: ${symbol} ${side}`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    const errMsg = result.reason || result.error || "Bilinmeyen hata";
    showToast(`‚ùå Kapatma hatasƒ±: ${errMsg}`, "error");
    addLog(`Kapatma hatasƒ± [${symbol}]: ${errMsg}`, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKET LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadMarketList() {
  try {
    const res = await fetch("/status/symbols");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    state.allSymbols = data.symbols || data || [];
    const cnt = state.allSymbols.length + " √ßift";
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = cnt;
    if (el2) el2.textContent = state.allSymbols.length;
    renderMarketList(state.allSymbols);
    renderModalList(state.allSymbols);
  } catch (err) {
    const fallback = [
      "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","DOGEUSDT",
      "ADAUSDT","AVAXUSDT","LINKUSDT","DOTUSDT","MATICUSDT","LTCUSDT",
      "ATOMUSDT","UNIUSDT","NEARUSDT","APTUSDT","ARBUSDT","OPUSDT",
    ];
    state.allSymbols = fallback;
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = fallback.length + " √ßift";
    if (el2) el2.textContent = fallback.length;
    renderMarketList(fallback);
    renderModalList(fallback);
  }
}

function renderMarketList(symbols) {
  // Center panel - coin grid
  const el = document.getElementById("market-list");
  if (el) {
    if (!symbols.length) {
      el.innerHTML = '<div class="loading-text">Sembol bulunamadƒ±</div>';
    } else {
      el.innerHTML = symbols.slice(0, 99).map(sym => {
        const base = String(sym).replace("USDT","").replace("BUSD","");
        const selected = sym === state.symbol ? "selected" : "";
        const chgData = state.marketPrices && state.marketPrices[sym];
        const chg = chgData ? chgData.chg : null;
        const price = chgData ? chgData.price : null;
        const chgClass = chg === null ? "" : (chg >= 0 ? "pos" : "neg");
        const chgStr = chg === null ? "" : (chg >= 0 ? "+" : "") + chg.toFixed(2) + "%";
        return `
          <div class="coin-cell ${selected}" onclick="selectSymbol('${sym}')">
            <div class="coin-sym">${base}</div>
            <div class="coin-price">${price ? fmtPrice(price) : ""}</div>
            <div class="coin-chg ${chgClass}">${chgStr}</div>
          </div>`;
      }).join("");
    }
  }
  // Right panel - market list
  const el2 = document.getElementById("market-list-right");
  if (el2) {
    el2.innerHTML = symbols.slice(0, 100).map(sym => {
      const base = String(sym).replace("USDT","").replace("BUSD","");
      return `
        <div class="market-item" onclick="selectSymbol('${sym}')">
          <div class="market-sym">${base}<span style="color:var(--text3)">/USDT</span></div>
          <button class="market-add-btn" onclick="event.stopPropagation();selectSymbol('${sym}')">+ ƒ∞≈ülem</button>
        </div>`;
    }).join("");
  }
}

function renderModalList(symbols) {
  const el = document.getElementById("modal-list");
  el.innerHTML = symbols.slice(0, 200).map(sym => {
    const base = String(sym).replace("USDT", "").replace("BUSD", "");
    return `
      <div class="market-item" onclick="selectSymbol('${sym}');closeMarketModal()" style="padding:10px 12px">
        <div class="market-sym">${base}<span>/USDT</span></div>
        <div style="font-size:10px;color:var(--text3)">${sym}</div>
      </div>`;
  }).join("");
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

function filterModal(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderModalList(filtered);
}

function selectSymbol(sym) {
  state.symbol = sym;
  document.getElementById("selected-symbol").textContent = sym;
  document.getElementById("current-price").textContent = "‚Äì";
  renderMarketList(state.allSymbols.filter(s =>
    s.toLowerCase().includes(document.getElementById("market-search-input").value.toLowerCase())
  ));
  // Fiyat g√ºncelle
  fetchSymbolPrice(sym);
  addLog(`Sembol deƒüi≈ütirildi: ${sym}`, "info");
}

async function fetchSymbolPrice(sym) {
  try {
    const res = await fetch(`/status/price?symbol=${sym}`);
    if (!res.ok) return;
    const data = await res.json();
    const price = data.price ?? data.mark_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }
  } catch {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  P&L PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updatePnLPreview() {
  const qty = parseFloat(document.getElementById("qty-input").value) || 100;
  const tp = parseFloat(document.getElementById("tp-input").value) || 3;
  const lev = parseFloat(document.getElementById("leverage-input").value) || 3;
  const maxPnl = qty * (tp / 100);
  const el = document.getElementById("pnl-preview");
  el.textContent = "+" + "$" + maxPnl.toFixed(2) + " max TP";
}

["qty-input","tp-input","leverage-input","sl-input"].forEach(id => {
  document.getElementById(id)?.addEventListener("input", updatePnLPreview);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRADE ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function handleLong() {
  await submitTrade("BUY");
}
async function handleShort() {
  await submitTrade("SELL");
}

async function submitTrade(side) {
  const symbol    = state.symbol;
  const qty       = parseFloat(document.getElementById("qty-input").value) || 100;
  const leverage  = parseInt(document.getElementById("leverage-input").value) || 3;
  const orderType = document.getElementById("order-type").value;
  const slPct     = parseFloat(document.getElementById("sl-input").value) || 1.5;
  const tpPct     = parseFloat(document.getElementById("tp-input").value) || 3.0;

  const btnId = side === "BUY" ? "btn-long" : "btn-short";
  const btn = document.getElementById(btnId);
  const origHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> ƒ∞≈üleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({
      symbol,
      side,
      quantity: qty,
      leverage,
      order_type: orderType,
      sl_pct: slPct,
      tp_pct: tpPct,
      strategy_tag: "manual",
    }),
  });

  btn.disabled = false;
  btn.innerHTML = origHtml;

  if (result.ok) {
    const sideLabel = side === "BUY" ? "LONG" : "SHORT";
    showToast(`‚úÖ ${sideLabel} i≈ülem a√ßƒ±ldƒ±: ${symbol}`, "success");
    addLog(`ƒ∞≈ülem a√ßƒ±ldƒ±: ${symbol} ${sideLabel} ${qty} USDT`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    addLog(`ƒ∞≈ülem reddedildi: ${result.reason}`, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONTROL PANELƒ∞ ‚Äî ƒ∞≈ülem Testi
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ctrlUpdateTestPreview() {
  const sym  = document.getElementById("test-symbol").value || "BTCUSDT";
  const side = document.getElementById("test-side").value;
  const qty  = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev  = parseFloat(document.getElementById("test-lev").value) || 3;
  const sl   = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const tp   = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const maxGain = (qty * tp / 100).toFixed(2);
  const maxLoss = (qty * sl / 100).toFixed(2);
  const sideLabel = side === "BUY" ? "üü¢ LONG" : "üî¥ SHORT";
  document.getElementById("test-preview").innerHTML =
    `<span style="color:#fff">${sym}</span> ${sideLabel} &nbsp;|&nbsp; ` +
    `Miktar: <span style="color:var(--cyan)">$${qty}</span> &nbsp;|&nbsp; ` +
    `Kaldƒ±ra√ß: <span style="color:var(--yellow)">${lev}x</span><br>` +
    `Max K√¢r: <span style="color:var(--green)">+$${maxGain}</span> &nbsp;|&nbsp; ` +
    `Max Kayƒ±p: <span style="color:var(--red)">-$${maxLoss}</span> &nbsp;|&nbsp; ` +
    `SL: ${sl}% / TP: ${tp}%`;
}

["test-symbol","test-side","test-qty","test-lev","test-sl","test-tp","test-order-type"].forEach(id => {
  document.getElementById(id)?.addEventListener("input",  ctrlUpdateTestPreview);
  document.getElementById(id)?.addEventListener("change", ctrlUpdateTestPreview);
});

async function ctrlOpenTrade(forceSide) {
  const side   = forceSide || document.getElementById("test-side").value;
  const symbol = document.getElementById("test-symbol").value.trim().toUpperCase() || "BTCUSDT";
  const qty    = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev    = parseInt(document.getElementById("test-lev").value) || 3;
  const tp     = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const sl     = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const otype  = document.getElementById("test-order-type").value;

  const btnId = side === "BUY" ? "ctrl-btn-long" : "ctrl-btn-short";
  const btn = document.getElementById(btnId);
  const orig = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = `<span class="spinner"></span> ƒ∞≈üleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({ symbol, side, quantity: qty, leverage: lev,
      order_type: otype, sl_pct: sl, tp_pct: tp, strategy_tag: "manual_test" }),
  });

  btn.disabled = false; btn.innerHTML = orig;

  const el = document.getElementById("test-result");
  el.style.display = "block";
  if (result.ok) {
    el.style.cssText = "display:block;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--green);margin-top:10px";
    el.innerHTML = `‚úÖ ƒ∞≈ülem a√ßƒ±ldƒ±: <strong>${symbol}</strong> ${side === "BUY" ? "LONG" : "SHORT"} $${qty} ‚Äî ${new Date().toLocaleTimeString("tr-TR")}`;
    showToast(`‚úÖ ${symbol} ${side === "BUY" ? "LONG" : "SHORT"} a√ßƒ±ldƒ±`, "success");
    addLog(`TEST i≈ülemi a√ßƒ±ldƒ±: ${symbol} ${side} $${qty} ${lev}x`, "ok");
    await loadPositions(); await refreshStatus();
  } else {
    el.style.cssText = "display:block;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--red);margin-top:10px";
    el.innerHTML = `‚ùå Hata: ${result.reason || "Bilinmeyen hata"}`;
    addLog(`TEST i≈ülemi reddedildi: ${result.reason}`, "error");
  }
}

async function ctrlCloseAll() {
  if (!confirm("T√ºm a√ßƒ±k pozisyonlarƒ± kapatmak istediƒüinize emin misiniz?")) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol: "ALL" }),
  });
  if (result.ok) {
    showToast("‚úÖ T√ºm pozisyonlar kapatƒ±ldƒ±", "success");
    addLog("T√ºm pozisyonlar manuel kapatƒ±ldƒ±", "warn");
    await loadPositions(); await refreshStatus();
  } else {
    showToast("‚ùå Kapatma hatasƒ±: " + (result.reason || "?"), "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONTROL PANELƒ∞ ‚Äî Ajan Ayarlarƒ±
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function ctrlUpdateAgentPreview() {
  const scan    = document.getElementById("ctrl-scan-interval").value;
  const eps     = document.getElementById("ctrl-epsilon").value;
  const minScore= document.getElementById("ctrl-min-score").value;
  const maxPos  = document.getElementById("ctrl-max-pos").value;
  const dayLoss = document.getElementById("ctrl-daily-loss").value;
  const drawdown= document.getElementById("ctrl-max-drawdown").value;
  const rpt     = document.getElementById("ctrl-risk-per-trade").value;
  const conLoss = document.getElementById("ctrl-consec-loss").value;
  document.getElementById("ctrl-agent-preview").innerHTML =
    `Tarama: <span style="color:var(--cyan)">${scan} dk</span> &nbsp;|&nbsp; ` +
    `Epsilon: <span style="color:var(--yellow)">${eps}</span> &nbsp;|&nbsp; ` +
    `Min Skor: <span style="color:var(--cyan)">${minScore}</span><br>` +
    `Max Poz: <span style="color:var(--cyan)">${maxPos}</span> &nbsp;|&nbsp; ` +
    `G√ºnl√ºk Kayƒ±p: <span style="color:var(--red)">${dayLoss}%</span> &nbsp;|&nbsp; ` +
    `Drawdown: <span style="color:var(--red)">${drawdown}%</span><br>` +
    `Risk/ƒ∞≈ülem: <span style="color:var(--green)">${rpt}%</span> &nbsp;|&nbsp; ` +
    `Ard. Kayƒ±p: <span style="color:var(--yellow)">${conLoss}</span>`;
}

async function ctrlToggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const statusEl = document.getElementById("ctrl-agent-status-text");
  if (result.ok !== false) {
    state.agentRunning = enabled;
    statusEl.textContent = enabled ? "‚úÖ Ajan √ßalƒ±≈üƒ±yor" : "‚èπ Ajan durduruldu";
    statusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    // Ana panel toggle da g√ºncelle
    const mainToggle = document.getElementById("agent-toggle");
    if (mainToggle) mainToggle.checked = enabled;
    showToast(enabled ? "ü§ñ Ajan aktifle≈ütirildi" : "‚èπ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Ajan ba≈ülatƒ±ldƒ± (kontrol panelinden)" : "Ajan durduruldu (kontrol panelinden)", enabled ? "ok" : "warn");
  }
}

async function ctrlApplyAgentSettings() {
  const settings = {
    scan_interval_min: parseInt(document.getElementById("ctrl-scan-interval").value),
    rl_epsilon:        parseFloat(document.getElementById("ctrl-epsilon").value),
    min_signal_score:  parseFloat(document.getElementById("ctrl-min-score").value),
    max_positions:     parseInt(document.getElementById("ctrl-max-pos").value),
    daily_max_loss_pct:parseFloat(document.getElementById("ctrl-daily-loss").value),
    max_drawdown_pct:  parseFloat(document.getElementById("ctrl-max-drawdown").value),
    risk_per_trade_pct:parseFloat(document.getElementById("ctrl-risk-per-trade").value),
    kill_switch_consecutive_loss: parseInt(document.getElementById("ctrl-consec-loss").value),
  };

  // /status/agent endpoint'ine settings g√∂nder
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: state.agentRunning, settings }),
  });

  if (result.ok !== false) {
    showToast("üíæ Ajan ayarlarƒ± uygulandƒ±", "success");
    addLog(`Ajan ayarlarƒ± g√ºncellendi: scan=${settings.scan_interval_min}dk eps=${settings.rl_epsilon}`, "ok");
  } else {
    showToast("‚ö† Ayarlar uygulanamadƒ±: " + (result.reason || "?"), "warn");
  }
}

async function ctrlKillSwitch(activate) {
  const action = activate ? "aktifle≈ütir" : "devre dƒ±≈üƒ± bƒ±rak";
  if (!confirm(`Kill switch'i ${action}mak istediƒüinize emin misiniz?`)) return;

  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: !activate, kill_switch: activate }),
  });

  const el = document.getElementById("kill-switch-status");
  if (activate) {
    el.style.color = "var(--red)";
    el.textContent = "üî¥ Kill Switch AKTƒ∞F ‚Äî Bot t√ºm i≈ülemleri durdurdu";
    showToast("üî¥ Kill Switch aktifle≈ütirildi!", "error");
    addLog("KILL SWITCH AKTƒ∞F ‚Äî t√ºm i≈ülemler durduruldu", "error");
    // Ajan toggle'ƒ± kapat
    document.getElementById("ctrl-agent-toggle").checked = false;
    document.getElementById("ctrl-agent-status-text").textContent = "üî¥ Kill switch aktif";
    document.getElementById("ctrl-agent-status-text").style.color = "var(--red)";
  } else {
    el.style.color = "var(--green)";
    el.textContent = "üü¢ Kill Switch devre dƒ±≈üƒ± ‚Äî Bot normal √ßalƒ±≈ümaya devam edebilir";
    showToast("üü¢ Kill Switch devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±", "success");
    addLog("Kill switch devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ± (manuel)", "warn");
  }
}

// Kontrol sekmesi a√ßƒ±ldƒ±ƒüƒ±nda preview g√ºncelle
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.dataset.tab === "control") {
      ctrlUpdateTestPreview();
      ctrlUpdateAgentPreview();
    }
  });
});

function copyWebhookUrl() {
  const url = document.getElementById("webhook-url").textContent;
  navigator.clipboard.writeText(url).then(() => showToast("üìã URL kopyalandƒ±", "success"));
}

function copyWebhookJson() {
  const json = `{\n  "symbol": "BTCUSDT",\n  "side": "BUY",\n  "timeframe": "1h",\n  "strategy_tag": "ema_cross",\n  "secret": "tv-secret"\n}`;
  navigator.clipboard.writeText(json).then(() => showToast("üìã JSON kopyalandƒ±", "success"));
}

// AGENT TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function toggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const agentStatusEl = document.getElementById("agent-status-val");
  if (result.ok || true) { // optimistic
    state.agentRunning = enabled;
    agentStatusEl.textContent = enabled ? "Aktif" : "Pasif";
    agentStatusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    showToast(enabled ? "ü§ñ Otomatik ajan aktifle≈ütirildi" : "‚èπ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Otomatik ajan ba≈ülatƒ±ldƒ±" : "Otomatik ajan durduruldu", enabled ? "ok" : "warn");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openMarketModal() {
  document.getElementById("market-modal").classList.add("open");
  document.getElementById("modal-search").focus();
}
function closeMarketModal() {
  document.getElementById("market-modal").classList.remove("open");
}
document.getElementById("market-modal").addEventListener("click", e => {
  if (e.target === document.getElementById("market-modal")) closeMarketModal();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function addLog(message, type = "info") {
  const el = document.getElementById("log-area");
  const now = new Date().toTimeString().slice(0, 8);
  const line = document.createElement("div");
  line.className = `log-line ${type}`;
  line.innerHTML = `<span class="log-time">${now}</span>${escHtml(message)}`;
  el.appendChild(line);
  // Max 200 lines
  while (el.children.length > 200) el.removeChild(el.firstChild);
  el.scrollTop = el.scrollHeight;
}

function escHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

let _logFilter = "all";

function setLogFilter(level, btn) {
  _logFilter = level;
  document.querySelectorAll(".log-filter-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  applyLogFilter();
}

function applyLogFilter() {
  const el = document.getElementById("log-area");
  el.querySelectorAll(".log-line").forEach(line => {
    if (_logFilter === "all") {
      line.style.display = "";
    } else if (_logFilter === "agent") {
      line.style.display = (line.textContent.includes("ü§ñ") || line.textContent.includes("RL") || line.textContent.includes("Sinyal") || line.textContent.includes("ƒ∞≈ülem a√ß")) ? "" : "none";
    } else {
      line.style.display = line.classList.contains(_logFilter) ? "" : "none";
    }
  });
}

async function fetchLogs() {
  try {
    const res = await fetch("/status/logs?limit=200");
    if (!res.ok) return;
    const data = await res.json();
    const logs = data.logs || data || [];
    const el = document.getElementById("log-area");
    el.innerHTML = "";
    logs.forEach(entry => {
      let msg, lvl;
      if (typeof entry === "string") {
        msg = entry; lvl = "info";
      } else {
        msg = entry.message || entry.msg || JSON.stringify(entry);
        lvl = entry.level === "ERROR" ? "error" : entry.level === "WARNING" ? "warn" : 
              (msg.includes("‚úÖ") || msg.includes("a√ßƒ±ldƒ±") || msg.includes("hazƒ±r")) ? "ok" : "info";
      }
      addLog(msg, lvl);
    });
    applyLogFilter();
  } catch(e) {
    addLog("Log y√ºkleme hatasƒ±: " + e, "error");
  }
}

function clearLogs() {
  document.getElementById("log-area").innerHTML = "";
  addLog("Loglar temizlendi", "info");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT & POLLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchFarTab(tab, el) {
  document.querySelectorAll(".far-tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".far-panel").forEach(p => p.classList.remove("active"));
  el.classList.add("active");
  const panel = document.getElementById("far-panel-" + tab);
  if (panel) panel.classList.add("active");
}

let _sortMode = "pct";
function sortMarket(mode) {
  _sortMode = mode;
  document.querySelectorAll(".sort-btn").forEach(b => {
    b.classList.toggle("active", b.getAttribute("onclick").includes(mode));
  });
  // Re-render with current list
  renderMarketList(state.allSymbols);
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

// Update header stats from overview data
function updateHeaderStats(data) {
  const bal = parseFloat(data.balance || data.wallet_balance || 0);
  const pnl = parseFloat(data.unrealized_pnl || 0);
  const se = data.signal_engine || {};
  const hb = document.getElementById("header-balance");
  const hp = document.getElementById("header-pnl");
  if (hb) hb.textContent = "$" + bal.toFixed(2);
  if (hp) {
    hp.textContent = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
    hp.style.color = pnl >= 0 ? "var(--green)" : "var(--red)";
  }
  // Update balance-val in stats bar
  const bv = document.getElementById("balance-val");
  if (bv) bv.textContent = "$" + bal.toFixed(2);
  // Update agent header btn
  const aBtn = document.getElementById("header-agent-btn");
  if (aBtn && se.running !== undefined) {
    aBtn.textContent = se.running ? "‚ñ† DURDUR AJAN" : "‚ñ∂ BA≈ûLAT";
    aBtn.className = se.running ? "btn-stop" : "btn-start";
    aBtn.onclick = se.running ? () => toggleAgent(false) : () => toggleAgent(true);
  }
}

async function init() {
  addLog("Dashboard ba≈ülatƒ±lƒ±yor...", "info");
  await Promise.all([
    refreshStatus(),
    loadPositions(),
    loadMarketList(),
    refreshOverviewPositions(),
    fetchLogs(),
  ]);
  addLog("Dashboard hazƒ±r ‚úì", "ok");
  updatePnLPreview();
  ctrlUpdateTestPreview();
  ctrlUpdateAgentPreview();
}

// Poll every 10s
setInterval(async () => {
  await refreshStatus();
  await refreshOverviewPositions();
  if (document.querySelector(".tab[data-tab='positions'].active")) {
    await loadPositions();
  }
  // Loglarƒ± her zaman arka planda g√ºncelle
  const autoRefresh = document.getElementById("log-auto-refresh");
  if (!autoRefresh || autoRefresh.checked) await fetchLogs();
}, 10_000);

// Price poll for selected symbol every 5s
setInterval(() => fetchSymbolPrice(state.symbol), 5_000);

init();
</script>
</body>
</html>
