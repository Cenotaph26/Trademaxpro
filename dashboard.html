<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TRADEMAXPRO â€” AI Futures Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=Orbitron:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” TRADEMAXPRO v10
   Aesthetic: Bloomberg Terminal Ã— Cyberpunk Precision
   Dark obsidian base, electric teal accents, 
   surgical typography, glowing data surfaces
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg0:     #020408;
  --bg1:     #060a12;
  --bg2:     #090e1a;
  --bg3:     #0d1422;
  --bg4:     #111828;
  --bg5:     #161e2e;

  --border:  rgba(0,200,255,0.08);
  --border2: rgba(0,200,255,0.16);
  --border3: rgba(0,200,255,0.28);

  --text:    #c8dff2;
  --text2:   #5a7a9a;
  --text3:   #2a4060;

  --teal:    #00c8ff;
  --teal2:   #00a0d0;
  --teal-glow: rgba(0,200,255,0.12);
  --teal-glow2: rgba(0,200,255,0.06);

  --green:   #00e87a;
  --green2:  #00b85f;
  --green-glow: rgba(0,232,122,0.1);

  --red:     #ff2d5b;
  --red2:    #cc1f45;
  --red-glow: rgba(255,45,91,0.1);

  --yellow:  #ffc820;
  --orange:  #ff6820;
  --purple:  #9d50ff;

  --mono:    'Space Mono', monospace;
  --sans:    'DM Sans', sans-serif;
  --display: 'Orbitron', sans-serif;

  --radius:  4px;
  --radius2: 8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { height: 100%; }

body {
  background: var(--bg0);
  color: var(--text);
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.5;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* â”€â”€ Scrollbars â”€â”€ */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--border3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TICKER STRIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ticker-strip {
  height: 28px;
  background: var(--bg0);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 0;
  overflow: hidden;
  flex-shrink: 0;
}

.ticker-divider {
  width: 1px;
  height: 14px;
  background: var(--border2);
  margin: 0 16px;
}

.ticker-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 10px;
  letter-spacing: 0.04em;
}

.ticker-sym {
  color: var(--text3);
  font-weight: 700;
  letter-spacing: 0.08em;
}

.ticker-price {
  color: var(--text);
  font-weight: 400;
}

.ticker-chg {
  font-size: 9px;
  padding: 1px 5px;
  border-radius: 2px;
  font-weight: 700;
}
.ticker-chg.pos { color: var(--green); background: var(--green-glow); }
.ticker-chg.neg { color: var(--red); background: var(--red-glow); }
.ticker-chg.neu { color: var(--text3); }

/* Live dot */
.ticker-live {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 9px;
  color: var(--text3);
  letter-spacing: 0.1em;
}
.live-dot {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: livepulse 2s infinite;
}
.live-dot.offline { background: var(--red); box-shadow: 0 0 6px var(--red); animation: none; }
@keyframes livepulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  height: 56px;
  background: linear-gradient(180deg, var(--bg2) 0%, var(--bg1) 100%);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 0;
  flex-shrink: 0;
  position: relative;
}

/* Subtle scan line on header */
header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--teal), transparent);
  opacity: 0.4;
}

.logo-block {
  display: flex;
  flex-direction: column;
  gap: 1px;
  margin-right: 32px;
}

.logo-primary {
  font-family: var(--display);
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--teal);
  line-height: 1;
  text-shadow: 0 0 20px rgba(0,200,255,0.4);
}

.logo-sub {
  font-size: 8px;
  letter-spacing: 0.2em;
  color: var(--text3);
  font-family: var(--mono);
  text-transform: uppercase;
}

/* Vertical separator */
.vsep {
  width: 1px;
  height: 32px;
  background: var(--border2);
  margin: 0 24px;
  flex-shrink: 0;
}

/* Header KPI row */
.header-kpis {
  display: flex;
  align-items: center;
  gap: 0;
  flex: 1;
}

.hkpi {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding: 0 20px;
  border-right: 1px solid var(--border);
}
.hkpi:first-child { padding-left: 0; }

.hkpi-label {
  font-size: 8px;
  letter-spacing: 0.15em;
  color: var(--text3);
  text-transform: uppercase;
  font-family: var(--sans);
}

.hkpi-val {
  font-family: var(--display);
  font-size: 16px;
  font-weight: 600;
  letter-spacing: 0.02em;
  line-height: 1;
  color: var(--text);
}
.hkpi-val.teal  { color: var(--teal); }
.hkpi-val.green { color: var(--green); }
.hkpi-val.red   { color: var(--red); }
.hkpi-val.yellow{ color: var(--yellow); }
.hkpi-val.purple{ color: var(--purple); }

/* Header right controls */
.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: auto;
}

.conn-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border: 1px solid var(--border2);
  border-radius: 3px;
  font-size: 9px;
  letter-spacing: 0.1em;
  color: var(--text2);
  background: var(--bg3);
}

.btn-hdr {
  height: 30px;
  padding: 0 14px;
  border: none;
  border-radius: 3px;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-hdr-start {
  background: var(--teal-glow);
  border: 1px solid var(--teal2);
  color: var(--teal);
}
.btn-hdr-start:hover { background: rgba(0,200,255,0.2); box-shadow: 0 0 12px rgba(0,200,255,0.2); }

.btn-hdr-stop {
  background: rgba(255,45,91,0.08);
  border: 1px solid rgba(255,45,91,0.3);
  color: var(--red);
}
.btn-hdr-stop:hover { background: rgba(255,45,91,0.16); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-bar {
  height: 52px;
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  flex-shrink: 0;
}

.stat-cell {
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 0 16px;
  border-right: 1px solid var(--border);
  gap: 2px;
  transition: background 0.15s;
}
.stat-cell:hover { background: var(--teal-glow2); }
.stat-cell:last-child { border-right: none; }

.stat-cell-label {
  font-size: 8px;
  letter-spacing: 0.12em;
  color: var(--text3);
  text-transform: uppercase;
  font-family: var(--sans);
}

.stat-cell-val {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  line-height: 1;
}
.stat-cell-val.green  { color: var(--green); }
.stat-cell-val.red    { color: var(--red); }
.stat-cell-val.yellow { color: var(--yellow); }
.stat-cell-val.purple { color: var(--purple); }
.stat-cell-val.teal   { color: var(--teal); }

.stat-cell-sub {
  font-size: 9px;
  color: var(--text3);
  margin-top: 1px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-layout {
  display: grid;
  grid-template-columns: 1fr 300px 260px;
  flex: 1;
  overflow: hidden;
  min-height: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT PANEL â€” MARKET + TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.left-panel {
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  overflow: hidden;
  min-height: 0;
}

/* Tab bar */
.tab-bar {
  display: flex;
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  flex-shrink: 0;
}

.tab {
  position: relative;
  padding: 12px 18px;
  font-size: 10px;
  letter-spacing: 0.12em;
  color: var(--text3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: color 0.15s;
  font-family: var(--sans);
  font-weight: 500;
  text-transform: uppercase;
  white-space: nowrap;
  border: none;
  background: none;
}
.tab:hover { color: var(--text2); }
.tab.active {
  color: var(--teal);
  border-bottom: 2px solid var(--teal);
}

.tab-controls {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 0;
}

/* â”€â”€ Market search â”€â”€ */
.market-search-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.market-search {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 6px 10px 6px 28px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
  transition: border-color 0.15s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%235a7a9a' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 8px center;
}
.market-search:focus { border-color: var(--teal2); box-shadow: 0 0 0 2px var(--teal-glow); }
.market-search::placeholder { color: var(--text3); }

.sort-btn-group { display: flex; gap: 4px; }
.sort-btn {
  height: 28px;
  padding: 0 10px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text3);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: all 0.12s;
  font-weight: 700;
}
.sort-btn:hover, .sort-btn.active { border-color: var(--teal2); color: var(--teal); background: var(--teal-glow2); }

/* â”€â”€ Coin grid â”€â”€ */
.coin-grid-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  min-height: 0;
}

.coin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(82px, 1fr));
  gap: 1px;
  padding: 1px;
  background: var(--border);
}

.coin-cell {
  background: var(--bg2);
  padding: 7px 8px;
  cursor: pointer;
  transition: all 0.1s;
  display: flex;
  flex-direction: column;
  gap: 2px;
  position: relative;
  min-height: 50px;
}

.coin-cell:hover { background: var(--bg3); z-index: 1; }

.coin-cell.selected {
  background: var(--teal-glow);
  outline: 1px solid var(--teal2);
  z-index: 2;
}
.coin-cell.selected::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--teal);
}

.coin-sym {
  font-size: 10px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.coin-price {
  font-size: 9px;
  color: var(--text2);
}

.coin-chg {
  font-size: 9px;
  font-weight: 700;
}
.coin-chg.pos { color: var(--green); }
.coin-chg.neg { color: var(--red); }

/* â”€â”€ Panel content areas â”€â”€ */
.panel-content { display: none; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
.panel-content.active { display: flex; }

/* â”€â”€ Chart + Strategy area (PIYASA tab bottom) â”€â”€ */
.market-bottom {
  display: grid;
  grid-template-columns: 1fr 1fr;
  border-top: 1px solid var(--border);
  height: 200px;
  flex-shrink: 0;
}

.chart-pane {
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.pane-header {
  height: 30px;
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 8px;
  flex-shrink: 0;
}
.pane-title {
  font-size: 9px;
  letter-spacing: 0.12em;
  color: var(--text3);
  text-transform: uppercase;
  font-family: var(--sans);
  font-weight: 600;
}
.pane-badge {
  font-size: 8px;
  padding: 1px 6px;
  border-radius: 2px;
  font-weight: 700;
  letter-spacing: 0.06em;
}
.pane-badge.live { background: var(--green-glow); color: var(--green); border: 1px solid rgba(0,232,122,0.3); }

.chart-body {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 6px;
  color: var(--text3);
  font-size: 10px;
}
.chart-icon { font-size: 24px; opacity: 0.3; }

/* Chart interval buttons */
.chart-intervals {
  display: flex;
  gap: 1px;
  margin-left: auto;
}
.interval-btn {
  height: 18px;
  padding: 0 6px;
  background: transparent;
  border: none;
  color: var(--text3);
  font-family: var(--mono);
  font-size: 9px;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.1s;
}
.interval-btn:hover, .interval-btn.active { color: var(--teal); background: var(--teal-glow2); }

/* â”€â”€ Strategy learning panel â”€â”€ */
.strategy-pane {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.strat-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.strat-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 8px;
  background: var(--bg3);
  border-radius: var(--radius);
  border: 1px solid transparent;
  transition: border-color 0.15s;
}
.strat-row:hover { border-color: var(--border2); }

.strat-tag {
  font-size: 8px;
  padding: 2px 5px;
  border-radius: 2px;
  font-weight: 700;
  flex-shrink: 0;
}
.strat-tag.best { background: var(--green-glow); color: var(--green); border: 1px solid rgba(0,232,122,0.2); }
.strat-tag.good { background: var(--teal-glow2); color: var(--teal2); border: 1px solid var(--border2); }

.strat-name {
  font-size: 10px;
  color: var(--text);
  flex: 1;
  font-family: var(--sans);
}

.strat-bar-bg {
  width: 80px;
  height: 3px;
  background: var(--bg5);
  border-radius: 2px;
  overflow: hidden;
  flex-shrink: 0;
}
.strat-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--teal), rgba(0,200,255,0.3));
  transition: width 0.8s ease;
}

.strat-wr {
  font-size: 9px;
  color: var(--text2);
  width: 28px;
  text-align: right;
  flex-shrink: 0;
}
.strat-pf {
  font-size: 9px;
  color: var(--green);
  width: 28px;
  text-align: right;
  font-weight: 700;
  flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POSITIONS TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.positions-pane {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0;
}

.pos-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 12px 14px;
  transition: border-color 0.15s;
  position: relative;
  overflow: hidden;
}
.pos-card:hover { border-color: var(--border2); }
.pos-card.long-card { border-left: 3px solid var(--green); }
.pos-card.short-card { border-left: 3px solid var(--red); }

.pos-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.pos-sym {
  font-size: 13px;
  font-weight: 700;
  font-family: var(--mono);
  color: var(--text);
}

.pos-side-badge {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.1em;
  padding: 3px 10px;
  border-radius: 2px;
}
.pos-side-badge.long { background: var(--green-glow); color: var(--green); border: 1px solid rgba(0,232,122,0.25); }
.pos-side-badge.short { background: var(--red-glow); color: var(--red); border: 1px solid rgba(255,45,91,0.25); }

.pos-metrics {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-bottom: 10px;
}

.pos-metric { display: flex; flex-direction: column; gap: 1px; }
.pos-metric-label {
  font-size: 8px;
  color: var(--text3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-family: var(--sans);
}
.pos-metric-val {
  font-size: 11px;
  font-weight: 700;
  color: var(--text);
}
.pos-metric-val.green { color: var(--green); }
.pos-metric-val.red { color: var(--red); }

.pos-pnl-bar {
  height: 2px;
  background: var(--bg5);
  border-radius: 1px;
  overflow: hidden;
  margin-bottom: 10px;
}
.pos-pnl-fill {
  height: 100%;
  border-radius: 1px;
  transition: width 0.5s;
}
.pos-pnl-fill.pos { background: var(--green); }
.pos-pnl-fill.neg { background: var(--red); }

.btn-close-pos {
  width: 100%;
  height: 28px;
  background: rgba(255,45,91,0.08);
  border: 1px solid rgba(255,45,91,0.25);
  border-radius: var(--radius);
  color: var(--red);
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.15s;
}
.btn-close-pos:hover { background: rgba(255,45,91,0.18); border-color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNALS TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.signals-pane {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-height: 0;
}

.signal-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 10px 12px;
}

.signal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.signal-symbol { font-size: 12px; font-weight: 700; color: var(--text); }

.signal-side {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.1em;
  padding: 2px 8px;
  border-radius: 2px;
}
.signal-side.buy  { background: var(--green-glow); color: var(--green); }
.signal-side.sell { background: var(--red-glow); color: var(--red); }
.signal-side.none { background: var(--bg4); color: var(--text3); }

.signal-score-bar {
  height: 2px;
  background: var(--bg5);
  border-radius: 1px;
  overflow: hidden;
  margin-bottom: 6px;
}
.signal-score-fill {
  height: 100%;
  border-radius: 1px;
  transition: width 0.5s;
}
.signal-score-fill.positive { background: var(--green); }
.signal-score-fill.negative { background: var(--red); }

.signal-details { display: flex; flex-direction: column; gap: 2px; }
.signal-detail-row {
  font-size: 9px;
  color: var(--text2);
  padding: 1px 0;
  border-top: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KONTROL TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ctrl-pane {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

.ctrl-section {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  overflow: hidden;
}

.ctrl-section-header {
  height: 34px;
  background: var(--bg3);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 14px;
  gap: 8px;
  font-size: 9px;
  letter-spacing: 0.12em;
  color: var(--text2);
  text-transform: uppercase;
  font-family: var(--sans);
  font-weight: 600;
}
.ctrl-section-icon { font-size: 12px; }

.ctrl-section-body {
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.ctrl-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.ctrl-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

.field-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.field-label {
  font-size: 8px;
  color: var(--text3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-family: var(--sans);
}

input, select {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 7px 10px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
  width: 100%;
}
input:focus, select:focus {
  border-color: var(--teal2);
  box-shadow: 0 0 0 2px var(--teal-glow);
}
select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235a7a9a'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; }

/* Preview row */
.preview-row {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 12px;
  font-size: 10px;
  color: var(--text2);
  line-height: 1.6;
}

/* Long/Short buttons */
.trade-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.btn-long {
  height: 40px;
  background: var(--green-glow);
  border: 1px solid rgba(0,232,122,0.4);
  border-radius: var(--radius);
  color: var(--green);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.btn-long:hover { background: rgba(0,232,122,0.2); box-shadow: 0 0 16px rgba(0,232,122,0.2); }
.btn-long:disabled { opacity: 0.3; cursor: not-allowed; }

.btn-short {
  height: 40px;
  background: var(--red-glow);
  border: 1px solid rgba(255,45,91,0.35);
  border-radius: var(--radius);
  color: var(--red);
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.btn-short:hover { background: rgba(255,45,91,0.2); box-shadow: 0 0 16px rgba(255,45,91,0.15); }
.btn-short:disabled { opacity: 0.3; cursor: not-allowed; }

.btn-close-all {
  height: 36px;
  background: rgba(255,104,32,0.08);
  border: 1px solid rgba(255,104,32,0.3);
  border-radius: var(--radius);
  color: var(--orange);
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: all 0.15s;
  width: 100%;
}
.btn-close-all:hover { background: rgba(255,104,32,0.16); }

.btn-apply {
  height: 36px;
  background: var(--teal-glow);
  border: 1px solid var(--teal2);
  border-radius: var(--radius);
  color: var(--teal);
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  transition: all 0.15s;
  width: 100%;
}
.btn-apply:hover { background: rgba(0,200,255,0.2); box-shadow: 0 0 12px var(--teal-glow); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIDDLE PANEL â€” TRADE FORM + AGENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.middle-panel {
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  overflow: hidden;
  background: var(--bg1);
}

/* Trade form header */
.trade-header {
  padding: 14px 16px 10px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 2px;
  background: var(--bg2);
  flex-shrink: 0;
}

.trade-symbol-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 8px;
}

.trade-symbol-name {
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
}

.trade-price {
  font-family: var(--display);
  font-size: 20px;
  font-weight: 700;
  color: var(--teal);
  letter-spacing: 0.04em;
  text-shadow: 0 0 16px rgba(0,200,255,0.3);
}

.trade-symbol-link {
  font-size: 9px;
  color: var(--teal2);
  cursor: pointer;
  text-decoration: none;
  letter-spacing: 0.05em;
}
.trade-symbol-link:hover { color: var(--teal); }

/* Trade form body */
.trade-form-body {
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

/* Leverage display */
.lev-display {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 5px 10px;
}
.lev-display-val {
  font-family: var(--display);
  font-size: 16px;
  color: var(--yellow);
  font-weight: 600;
}
.lev-display-label { font-size: 9px; color: var(--text3); }

/* Max TP preview */
.max-tp-row {
  display: flex;
  justify-content: flex-end;
  gap: 6px;
  font-size: 9px;
}
.max-tp-label { color: var(--text3); }
.max-tp-val { color: var(--green); font-weight: 700; }

/* PnL preview mini */
.pnl-preview {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 12px;
  font-size: 10px;
  color: var(--text2);
  line-height: 1.7;
}
.pnl-preview span { color: var(--text); font-weight: 700; }

/* â”€â”€ Trade action buttons in middle â”€â”€ */
.trade-actions {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.trade-btn-long {
  height: 44px;
  background: linear-gradient(135deg, rgba(0,232,122,0.12), rgba(0,232,122,0.06));
  border: 1px solid rgba(0,232,122,0.4);
  border-radius: var(--radius);
  color: var(--green);
  font-family: var(--display);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.trade-btn-long:hover {
  background: linear-gradient(135deg, rgba(0,232,122,0.22), rgba(0,232,122,0.12));
  box-shadow: 0 0 20px rgba(0,232,122,0.2), inset 0 1px 0 rgba(255,255,255,0.05);
}
.trade-btn-long:disabled { opacity: 0.25; cursor: not-allowed; }

.trade-btn-short {
  height: 44px;
  background: linear-gradient(135deg, rgba(255,45,91,0.12), rgba(255,45,91,0.06));
  border: 1px solid rgba(255,45,91,0.35);
  border-radius: var(--radius);
  color: var(--red);
  font-family: var(--display);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.trade-btn-short:hover {
  background: linear-gradient(135deg, rgba(255,45,91,0.22), rgba(255,45,91,0.12));
  box-shadow: 0 0 20px rgba(255,45,91,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
}
.trade-btn-short:disabled { opacity: 0.25; cursor: not-allowed; }

/* â”€â”€ Agent section â”€â”€ */
.agent-section {
  flex: 1;
  overflow-y: auto;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

.agent-header-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.agent-title {
  font-size: 9px;
  letter-spacing: 0.15em;
  color: var(--text3);
  text-transform: uppercase;
  font-family: var(--sans);
  font-weight: 600;
}

/* Toggle switch */
.toggle-wrap { display: flex; align-items: center; gap: 8px; }
.toggle-label { font-size: 9px; color: var(--text3); }

.toggle-switch {
  width: 38px;
  height: 20px;
  background: var(--bg5);
  border: 1px solid var(--border2);
  border-radius: 10px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-appearance: none;
  outline: none;
}
.toggle-switch:checked {
  background: rgba(0,232,122,0.2);
  border-color: rgba(0,232,122,0.5);
}
.toggle-switch::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 14px;
  height: 14px;
  background: var(--text3);
  border-radius: 50%;
  transition: all 0.2s;
}
.toggle-switch:checked::after {
  left: 20px;
  background: var(--green);
  box-shadow: 0 0 8px rgba(0,232,122,0.5);
}

/* Agent stat cells */
.agent-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.agent-cell {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 10px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  transition: border-color 0.15s;
}
.agent-cell:hover { border-color: var(--border2); }

.agent-cell-label {
  font-size: 8px;
  color: var(--text3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-family: var(--sans);
}
.agent-cell-val {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  font-family: var(--mono);
}
.agent-cell-val.active { color: var(--green); }
.agent-cell-val.passive { color: var(--text3); }
.agent-cell-val.yellow { color: var(--yellow); }

/* â”€â”€ Futures market list â”€â”€ */
.market-list-section {
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  max-height: 200px;
  display: flex;
  flex-direction: column;
}

.market-list-header {
  height: 32px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 12px;
  gap: 8px;
  flex-shrink: 0;
}
.market-list-count {
  margin-left: auto;
  font-size: 10px;
  font-weight: 700;
  color: var(--teal);
}

.market-list-search {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 4px 8px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 10px;
  outline: none;
}
.market-list-search:focus { border-color: var(--teal2); }
.market-list-search::placeholder { color: var(--text3); }

.market-list-scroll {
  flex: 1;
  overflow-y: auto;
}

.market-item {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.1s;
  gap: 8px;
}
.market-item:hover { background: var(--bg3); }
.market-item.selected { background: var(--teal-glow2); }

.market-item-sym {
  font-size: 10px;
  font-weight: 700;
  color: var(--text);
  flex: 1;
}
.market-item-quote { font-size: 9px; color: var(--text3); }
.market-item-price { font-size: 10px; color: var(--text2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT PANEL â€” LOGS + SIGNALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.right-panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg0);
}

/* Far tab bar */
.far-tab-bar {
  display: flex;
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.far-tab {
  flex: 1;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 9px;
  letter-spacing: 0.12em;
  color: var(--text3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  font-family: var(--sans);
  font-weight: 600;
  text-transform: uppercase;
  background: none;
  border-top: none;
  border-left: none;
  border-right: 1px solid var(--border);
}
.far-tab:last-child { border-right: none; }
.far-tab:hover { color: var(--text2); background: var(--teal-glow2); }
.far-tab.active { color: var(--teal); border-bottom-color: var(--teal); background: var(--teal-glow2); }

/* Log filter row */
.log-filter-row {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  flex-shrink: 0;
}

.log-filter-btn {
  height: 20px;
  padding: 0 8px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text3);
  font-family: var(--mono);
  font-size: 8px;
  font-weight: 700;
  letter-spacing: 0.06em;
  cursor: pointer;
  transition: all 0.12s;
}
.log-filter-btn:hover, .log-filter-btn.active {
  border-color: var(--teal2);
  color: var(--teal);
  background: var(--teal-glow2);
}

.log-actions {
  margin-left: auto;
  display: flex;
  gap: 4px;
  align-items: center;
}

.log-icon-btn {
  width: 22px; height: 20px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 2px;
  color: var(--text3);
  font-size: 10px;
  cursor: pointer;
  transition: all 0.12s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.log-icon-btn:hover { border-color: var(--border2); color: var(--text2); }

.log-auto-label {
  font-size: 8px;
  color: var(--text3);
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}
.log-auto-label input { width: 12px; height: 12px; accent-color: var(--teal); }

/* Log area */
.log-area {
  flex: 1;
  overflow-y: auto;
  padding: 4px 0;
  font-family: var(--mono);
  font-size: 10px;
  background: #000;
  min-height: 0;
}

.log-line {
  display: flex;
  gap: 6px;
  padding: 2px 10px;
  border-bottom: 1px solid rgba(0,200,255,0.03);
  line-height: 1.5;
  transition: background 0.1s;
}
.log-line:hover { background: rgba(255,255,255,0.02); }

.log-time {
  color: var(--text3);
  flex-shrink: 0;
  letter-spacing: 0.02em;
  font-size: 9px;
  padding-top: 1px;
}

.log-line .log-msg { color: var(--text2); flex: 1; word-break: break-all; }
.log-line.ok { border-left: 2px solid rgba(0,232,122,0.5); }
.log-line.ok .log-msg { color: rgba(0,232,122,0.9); }
.log-line.error { border-left: 2px solid rgba(255,45,91,0.6); }
.log-line.error .log-msg { color: rgba(255,45,91,0.9); }
.log-line.warn { border-left: 2px solid rgba(255,200,32,0.5); }
.log-line.warn .log-msg { color: rgba(255,200,32,0.9); }
.log-line.info { border-left: 2px solid transparent; }

/* Far content panels */
.far-content { display: none; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
.far-content.active { display: flex; }

/* Signals side panel */
.sig-panel {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

.sig-mini-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--border);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.sig-mini-cell {
  background: var(--bg1);
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.sig-mini-label { font-size: 8px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.1em; font-family: var(--sans); }
.sig-mini-val { font-size: 12px; font-weight: 700; color: var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,4,12,0.85);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border3);
  border-radius: var(--radius2);
  padding: 20px;
  width: 360px;
  max-height: 70vh;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 0 1px var(--border2);
}

.modal-title {
  font-family: var(--display);
  font-size: 13px;
  font-weight: 700;
  color: var(--teal);
  letter-spacing: 0.08em;
}

.modal-close {
  position: absolute;
  top: 16px; right: 16px;
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: 3px;
  color: var(--text3);
  width: 24px; height: 24px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-close:hover { color: var(--text); border-color: var(--border3); }

.modal { position: relative; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast-container {
  position: fixed;
  top: 80px;
  right: 16px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border-radius: var(--radius);
  font-size: 11px;
  font-family: var(--mono);
  min-width: 240px;
  max-width: 320px;
  animation: slideIn 0.3s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.error { background: rgba(255,45,91,0.15); border: 1px solid rgba(255,45,91,0.4); color: var(--red); }
.toast.success { background: rgba(0,232,122,0.1); border: 1px solid rgba(0,232,122,0.35); color: var(--green); }
.toast.info { background: rgba(0,200,255,0.1); border: 1px solid var(--border2); color: var(--teal); }
.toast.warn { background: rgba(255,200,32,0.1); border: 1px solid rgba(255,200,32,0.35); color: var(--yellow); }

.toast-icon { font-size: 14px; flex-shrink: 0; }
.toast-msg { flex: 1; }

@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translateX(20px); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 10px;
  color: var(--text3);
  font-size: 11px;
  min-height: 80px;
  padding: 20px;
  text-align: center;
}
.empty-state-icon { font-size: 28px; opacity: 0.3; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1200px) {
  .main-layout { grid-template-columns: 1fr 300px; }
  .right-panel { display: none; }
  .stats-bar { grid-template-columns: repeat(4, 1fr); }
}
@media (max-width: 900px) {
  .main-layout { grid-template-columns: 1fr; }
  .middle-panel { display: none; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TICKER STRIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="ticker-strip">
  <div class="ticker-item" id="t-btc">
    <span class="ticker-sym">BTC</span>
    <span class="ticker-price">â€“</span>
    <span class="ticker-chg neu">â€“</span>
  </div>
  <div class="ticker-divider"></div>
  <div class="ticker-item" id="t-eth">
    <span class="ticker-sym">ETH</span>
    <span class="ticker-price">â€“</span>
    <span class="ticker-chg neu">â€“</span>
  </div>
  <div class="ticker-divider"></div>
  <div class="ticker-item" id="t-sol">
    <span class="ticker-sym">SOL</span>
    <span class="ticker-price">â€“</span>
    <span class="ticker-chg neu">â€“</span>
  </div>
  <div class="ticker-divider"></div>
  <div class="ticker-item" id="t-bnb">
    <span class="ticker-sym">BNB</span>
    <span class="ticker-price">â€“</span>
    <span class="ticker-chg neu">â€“</span>
  </div>
  <div class="ticker-divider"></div>
  <div class="ticker-item" id="t-xrp">
    <span class="ticker-sym">XRP</span>
    <span class="ticker-price">â€“</span>
    <span class="ticker-chg neu">â€“</span>
  </div>
  <div class="ticker-live">
    <div class="live-dot offline" id="conn-dot"></div>
    <span id="conn-label">BAÄLANIYOR</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo-block">
    <div class="logo-primary">TRADEMAXPRO</div>
    <div class="logo-sub">BINANCE FUTURES Â· AI ENGINE Â· TESTNET</div>
  </div>

  <div class="vsep"></div>

  <div class="header-kpis">
    <div class="hkpi">
      <div class="hkpi-label">Bakiye</div>
      <div class="hkpi-val teal" id="header-balance">$0.00</div>
    </div>
    <div class="hkpi">
      <div class="hkpi-label">PNL</div>
      <div class="hkpi-val green" id="header-pnl">+$0.00</div>
    </div>
    <div class="hkpi">
      <div class="hkpi-label">Win Rate</div>
      <div class="hkpi-val yellow" id="header-wr">â€“</div>
    </div>
    <div class="hkpi">
      <div class="hkpi-label">Drawdown</div>
      <div class="hkpi-val red" id="header-dd">â€“</div>
    </div>
    <div class="hkpi">
      <div class="hkpi-label">P.Factor</div>
      <div class="hkpi-val purple" id="header-pf">â€“</div>
    </div>
  </div>

  <div class="header-right">
    <button class="btn-hdr btn-hdr-start" id="header-agent-btn" onclick="toggleAgent(true)">â–¶ BAÅLAT AJAN</button>
    <button class="btn-hdr btn-hdr-stop" onclick="ctrlCloseAll()">â–  DURDUR</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stats-bar">
  <div class="stat-cell">
    <div class="stat-cell-label">PortfÃ¶y</div>
    <div class="stat-cell-val teal" id="balance-val">$0.00</div>
    <div class="stat-cell-sub" id="balance-start">BaÅŸlangÄ±Ã§: â€“</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Toplam PNL</div>
    <div class="stat-cell-val green" id="pnl-val">+$0.00</div>
    <div class="stat-cell-sub" id="pnl-pct">+0.00%</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Win Rate</div>
    <div class="stat-cell-val yellow" id="winrate-val">â€“</div>
    <div class="stat-cell-sub" id="winrate-sub">W: â€“ / L: â€“</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Profit Factor</div>
    <div class="stat-cell-val purple" id="pf-val">â€“</div>
    <div class="stat-cell-sub">KazanÃ§ / KayÄ±p</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Drawdown</div>
    <div class="stat-cell-val red" id="dd-val">â€“</div>
    <div class="stat-cell-sub">Zirve dÃ¼ÅŸÃ¼ÅŸ</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">AÃ§Ä±k Poz</div>
    <div class="stat-cell-val" id="open-pos-val" style="color:var(--purple)">0</div>
    <div class="stat-cell-sub" id="max-pos-sub">Maks 10 pozisyon</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Ä°ÅŸlem SayÄ±sÄ±</div>
    <div class="stat-cell-val" id="daily-trades-val">0</div>
    <div class="stat-cell-sub">Toplam trade</div>
  </div>
  <div class="stat-cell">
    <div class="stat-cell-label">Coin SayÄ±sÄ±</div>
    <div class="stat-cell-val teal" id="coin-count-val">â€“</div>
    <div class="stat-cell-sub">Futures Ã§iftleri</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-layout">

  <!-- LEFT PANEL -->
  <div class="left-panel">

    <!-- Tab bar -->
    <div class="tab-bar">
      <button class="tab active" data-tab="market">Piyasa</button>
      <button class="tab" data-tab="positions">Pozisyonlar</button>
      <button class="tab" data-tab="signals">Sinyaller</button>
      <button class="tab" data-tab="control">âš™ Kontrol</button>
    </div>

    <!-- PIYASA TAB -->
    <div class="panel-content active" id="tab-market">
      <!-- Search bar -->
      <div class="market-search-row">
        <input type="text" class="market-search" id="market-search" placeholder="Coin ara... (BTC, ETH, SOL)" oninput="filterMarket(this.value)" />
        <div class="sort-btn-group">
          <button class="sort-btn active" onclick="sortMarket('chg', this)">% DEÄÄ°ÅÄ°M</button>
          <button class="sort-btn" onclick="sortMarket('vol', this)">HACÄ°M</button>
          <button class="sort-btn" onclick="sortMarket('name', this)">Ä°SÄ°M</button>
        </div>
      </div>

      <!-- Coin grid -->
      <div class="coin-grid-scroll">
        <div class="coin-grid" id="market-list">
          <div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">âŸ³</div>YÃ¼kleniyor...</div>
        </div>
      </div>

      <!-- Bottom: chart + strategy -->
      <div class="market-bottom">
        <div class="chart-pane">
          <div class="pane-header">
            <span class="pane-title" id="chart-sym-label">AXS/USDT</span>
            <span style="font-size:9px;color:var(--text3)">PNL</span>
            <span class="pane-badge live">CANLI</span>
            <div class="chart-intervals">
              <button class="interval-btn active" onclick="setInterval2('1m',this)">1m</button>
              <button class="interval-btn" onclick="setInterval2('3m',this)">3m</button>
              <button class="interval-btn" onclick="setInterval2('5m',this)">5m</button>
              <button class="interval-btn" onclick="setInterval2('15m',this)">15m</button>
              <button class="interval-btn" onclick="setInterval2('1h',this)">1h</button>
              <button class="interval-btn" onclick="setInterval2('4h',this)">4h</button>
            </div>
          </div>
          <div class="chart-body">
            <div class="chart-icon">ğŸ“Š</div>
            <div>Grafik verisi yÃ¼kleniyor...</div>
            <div style="font-size:9px;color:var(--text3)">Fiyat: <span id="current-price">â€“</span></div>
          </div>
        </div>
        <div class="strategy-pane">
          <div class="pane-header">
            <span class="pane-title">Strateji Ã–ÄŸrenimi</span>
            <span class="pane-badge live">CANLI</span>
            <span style="margin-left:auto;font-size:9px;color:var(--text3)">EN Ä°YÄ° â–¼</span>
          </div>
          <div class="strat-list">
            <div class="strat-row">
              <span class="strat-tag best">EN Ä°YÄ°</span>
              <span class="strat-name">Mean Reversion</span>
              <div class="strat-bar-bg"><div class="strat-bar-fill" style="width:76%"></div></div>
              <span class="strat-wr">38.1% WR</span>
              <span class="strat-pf">1.66</span>
            </div>
            <div class="strat-row">
              <span class="strat-tag good">Ä°YÄ°</span>
              <span class="strat-name">Breakout</span>
              <div class="strat-bar-bg"><div class="strat-bar-fill" style="width:62%"></div></div>
              <span class="strat-wr">33.3% WR</span>
              <span class="strat-pf">1.42</span>
            </div>
            <div class="strat-row">
              <span class="strat-tag good">Ä°YÄ°</span>
              <span class="strat-name">Trend Following</span>
              <div class="strat-bar-bg"><div class="strat-bar-fill" style="width:58%"></div></div>
              <span class="strat-wr">30.4% WR</span>
              <span class="strat-pf">1.30</span>
            </div>
            <div class="strat-row">
              <span class="strat-tag" style="background:rgba(255,104,32,0.1);color:var(--orange);border:1px solid rgba(255,104,32,0.2)">ORTA</span>
              <span class="strat-name">Scalping</span>
              <div class="strat-bar-bg"><div class="strat-bar-fill" style="width:28%;background:linear-gradient(90deg,var(--orange),rgba(255,104,32,0.3))"></div></div>
              <span class="strat-wr">15.4% WR</span>
              <span class="strat-pf" style="color:var(--orange)">0.70</span>
            </div>
            <div class="strat-row">
              <span class="strat-tag" style="background:rgba(255,45,91,0.08);color:var(--red);border:1px solid rgba(255,45,91,0.2)">DÃœÅÃœK</span>
              <span class="strat-name">VWAP Bounce</span>
              <div class="strat-bar-bg"><div class="strat-bar-fill" style="width:22%;background:linear-gradient(90deg,var(--red),rgba(255,45,91,0.3))"></div></div>
              <span class="strat-wr">11.1% WR</span>
              <span class="strat-pf" style="color:var(--red)">0.70</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- POZISYONLAR TAB -->
    <div class="panel-content" id="tab-positions">
      <div class="positions-pane" id="positions-content">
        <div class="empty-state"><div class="empty-state-icon">ğŸ“‚</div>AÃ§Ä±k pozisyon yok</div>
      </div>
    </div>

    <!-- SÄ°NYALLER TAB -->
    <div class="panel-content" id="tab-signals">
      <div class="signals-pane" id="signals-content">
        <div class="empty-state"><div class="empty-state-icon">ğŸ“¡</div>Sinyal bekleniyor...</div>
      </div>
    </div>

    <!-- KONTROL TAB -->
    <div class="panel-content" id="tab-control">
      <div class="ctrl-pane">

        <!-- Ä°ÅŸlem Testi -->
        <div class="ctrl-section">
          <div class="ctrl-section-header">
            <span class="ctrl-section-icon">âœ</span> Ä°ÅŸlem Testi
          </div>
          <div class="ctrl-section-body">
            <div class="ctrl-grid-2">
              <div class="field-group">
                <div class="field-label">Sembol</div>
                <input type="text" id="ctrl-symbol" value="BTCUSDT" oninput="ctrlUpdateTestPreview()" />
              </div>
              <div class="field-group">
                <div class="field-label">YÃ¶n</div>
                <select id="ctrl-direction" onchange="ctrlUpdateTestPreview()">
                  <option value="LONG">LONG</option>
                  <option value="SHORT">SHORT</option>
                </select>
              </div>
            </div>
            <div class="ctrl-grid-2">
              <div class="field-group">
                <div class="field-label">Miktar (USDT)</div>
                <input type="number" id="ctrl-amount" value="100" oninput="ctrlUpdateTestPreview()" />
              </div>
              <div class="field-group">
                <div class="field-label">KaldÄ±raÃ§</div>
                <input type="number" id="ctrl-leverage" value="3" oninput="ctrlUpdateTestPreview()" />
              </div>
            </div>
            <div class="ctrl-grid-2">
              <div class="field-group">
                <div class="field-label">SL %</div>
                <input type="number" id="ctrl-sl" value="1.5" step="0.1" oninput="ctrlUpdateTestPreview()" />
              </div>
              <div class="field-group">
                <div class="field-label">TP %</div>
                <input type="number" id="ctrl-tp" value="3.0" step="0.1" oninput="ctrlUpdateTestPreview()" />
              </div>
            </div>
            <div class="field-group">
              <div class="field-label">Emir Tipi</div>
              <select id="ctrl-order-type">
                <option value="MARKET">MARKET</option>
                <option value="LIMIT">LIMIT</option>
              </select>
            </div>
            <div class="preview-row" id="test-preview">â€“</div>
            <div class="trade-buttons">
              <button class="btn-long" onclick="ctrlOpenTrade('BUY')">â–² LONG</button>
              <button class="btn-short" onclick="ctrlOpenTrade('SELL')">â–¼ SHORT</button>
            </div>
            <button class="btn-close-all" onclick="ctrlCloseAll()">ğŸ”´ TÃ¼m PozisyonlarÄ± Kapat</button>
          </div>
        </div>

        <!-- Ajan AyarlarÄ± -->
        <div class="ctrl-section">
          <div class="ctrl-section-header">
            <span class="ctrl-section-icon">ğŸ¤–</span> Ajan AyarlarÄ±
          </div>
          <div class="ctrl-section-body">
            <div class="ctrl-grid-2">
              <div class="field-group">
                <div class="field-label">GÃ¼nlÃ¼k Max KayÄ±p %</div>
                <input type="number" id="ctrl-daily-loss" value="3" />
              </div>
              <div class="field-group">
                <div class="field-label">Max Drawdown %</div>
                <input type="number" id="ctrl-max-dd" value="15" />
              </div>
            </div>
            <div class="ctrl-grid-2">
              <div class="field-group">
                <div class="field-label">Risk Per Trade %</div>
                <input type="number" id="ctrl-risk-pt" value="1" />
              </div>
              <div class="field-group">
                <div class="field-label">Max Pozisyon</div>
                <input type="number" id="ctrl-max-pos" value="10" />
              </div>
            </div>
            <div class="ctrl-grid-3">
              <div class="field-group">
                <div class="field-label">Tarama (dk)</div>
                <input type="number" id="ctrl-scan" value="15" />
              </div>
              <div class="field-group">
                <div class="field-label">Min. Sinyal Skoru</div>
                <input type="number" id="ctrl-min-score" value="0.15" step="0.01" />
              </div>
              <div class="field-group">
                <div class="field-label">RL Epsilon</div>
                <input type="number" id="ctrl-epsilon" value="0.15" step="0.01" />
              </div>
            </div>
            <div class="field-group">
              <div class="field-label">Kill-Switch (Ard. KayÄ±p)</div>
              <input type="number" id="ctrl-kill-switch" value="5" />
            </div>
            <div class="preview-row" id="ctrl-agent-preview">â€“</div>
            <div id="ctrl-agent-status-text" style="font-size:10px;color:var(--text3)">â¹ Ajan durduruldu</div>
            <div class="ctrl-grid-2">
              <div class="toggle-wrap" style="padding:4px 0">
                <span class="agent-title" style="font-size:9px">Otomatik Ajan</span>
                <input type="checkbox" class="toggle-switch" id="ctrl-agent-toggle" onchange="ctrlToggleAgent(this.checked)" />
              </div>
              <button class="btn-apply" onclick="ctrlApplySettings()">ğŸ’¾ AyarlarÄ± Uygula</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div><!-- /left-panel -->

  <!-- MIDDLE PANEL -->
  <div class="middle-panel">

    <!-- Trade header -->
    <div class="trade-header">
      <div class="trade-symbol-row">
        <div>
          <div class="trade-symbol-name" id="selected-symbol">BTCUSDT</div>
          <a class="trade-symbol-link" onclick="openMarketModal()">Sembol seÃ§ â†’</a>
        </div>
        <div class="trade-price" id="current-price">â€“</div>
      </div>
    </div>

    <!-- Trade form -->
    <div class="trade-form-body">
      <div class="field-group">
        <div class="field-label">Miktar (USDT)</div>
        <input type="number" id="trade-amount" value="100" oninput="updatePnLPreview()" />
      </div>
      <div class="form-row">
        <div class="field-group">
          <div class="field-label">Emir Tipi</div>
          <select id="trade-order-type">
            <option>Market</option>
            <option>Limit</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">KaldÄ±raÃ§</div>
          <div class="lev-display">
            <div class="lev-display-label">MAX <span style="color:var(--text2)" id="max-lev-label">20x</span></div>
            <div class="lev-display-val" id="lev-display">3x</div>
          </div>
          <input type="range" id="trade-leverage" min="1" max="20" value="3"
            style="width:100%;margin-top:4px;accent-color:var(--teal)"
            oninput="document.getElementById('lev-display').textContent=this.value+'x'; updatePnLPreview()" />
        </div>
      </div>
      <div class="form-row">
        <div class="field-group">
          <div class="field-label">SL %</div>
          <input type="number" id="trade-sl" value="1.5" step="0.1" oninput="updatePnLPreview()" />
        </div>
        <div class="field-group">
          <div class="field-label">TP %</div>
          <input type="number" id="trade-tp" value="3.0" step="0.1" oninput="updatePnLPreview()" />
        </div>
      </div>
      <div class="max-tp-row">
        <span class="max-tp-label">max TP</span>
        <span class="max-tp-val" id="max-tp-preview">+$0.00 max TP</span>
      </div>
      <div class="pnl-preview" id="pnl-preview">â€“</div>
    </div>

    <!-- Trade action buttons -->
    <div class="trade-actions">
      <button class="trade-btn-long" onclick="handleLong()">â–² LONG Ä°ÅLEM AÃ‡</button>
      <button class="trade-btn-short" onclick="handleShort()">â–¼ SHORT Ä°ÅLEM AÃ‡</button>
    </div>

    <!-- Agent section -->
    <div class="agent-section">
      <div class="agent-header-row">
        <span class="agent-title">Otomatik Ajan</span>
        <div class="toggle-wrap">
          <input type="checkbox" class="toggle-switch" id="agent-toggle" onchange="ctrlToggleAgent(this.checked)" />
        </div>
      </div>

      <div class="agent-grid">
        <div class="agent-cell">
          <div class="agent-cell-label">Durum</div>
          <div class="agent-cell-val passive" id="agent-status-val">Pasif</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">Ä°ÅŸlem SayÄ±sÄ±</div>
          <div class="agent-cell-val" id="agent-trade-count">0</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">Tarama</div>
          <div class="agent-cell-val" id="agent-scan-interval">15 dk</div>
        </div>
        <div class="agent-cell">
          <div class="agent-cell-label">RL Epsilon</div>
          <div class="agent-cell-val yellow" id="agent-epsilon">â€“</div>
        </div>
      </div>
    </div>

    <!-- Market list -->
    <div class="market-list-section">
      <div class="market-list-header">
        <span class="pane-title">Futures PiyasalarÄ±</span>
        <span class="market-list-count" id="market-count-label">â€“</span>
        <input type="text" class="market-list-search" id="market-list-search"
          placeholder="Sembol ara... (BTC, ETH...)"
          oninput="filterMarketList(this.value)" style="flex:1;margin-left:8px" />
      </div>
      <div class="market-list-scroll">
        <div id="market-list-right"></div>
      </div>
    </div>

  </div><!-- /middle-panel -->

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <div class="far-tab-bar">
      <button class="far-tab active" onclick="switchFarTab('logs', this)">Loglar</button>
      <button class="far-tab" onclick="switchFarTab('signals', this)">Sinyaller</button>
    </div>

    <!-- LOGS -->
    <div class="far-content active" id="far-logs">
      <div class="log-filter-row">
        <button class="log-filter-btn active" onclick="setLogFilter('all', this)">TÃ¼mÃ¼</button>
        <button class="log-filter-btn" onclick="setLogFilter('error', this)">Hata</button>
        <button class="log-filter-btn" onclick="setLogFilter('warn', this)">UyarÄ±</button>
        <button class="log-filter-btn" onclick="setLogFilter('ok', this)">BaÅŸarÄ±</button>
        <button class="log-filter-btn" onclick="setLogFilter('agent', this)">Ajan</button>
        <div class="log-actions">
          <button class="log-icon-btn" onclick="fetchLogs()" title="Yenile">â†»</button>
          <button class="log-icon-btn" onclick="clearLogs()" title="Temizle">âœ•</button>
          <label class="log-auto-label">
            <input type="checkbox" id="log-auto-refresh" checked />
            Otomatik
          </label>
        </div>
      </div>
      <div class="log-area" id="log-area"></div>
    </div>

    <!-- SIGNALS PANEL -->
    <div class="far-content" id="far-signals">
      <div class="sig-mini-stats">
        <div class="sig-mini-cell">
          <div class="sig-mini-label">Piyasa Rejimi</div>
          <div class="sig-mini-val" id="regime-val">â€“</div>
        </div>
        <div class="sig-mini-cell">
          <div class="sig-mini-label">ATR</div>
          <div class="sig-mini-val" id="atr-sub">â€“</div>
        </div>
        <div class="sig-mini-cell">
          <div class="sig-mini-label">Margin Kull.</div>
          <div class="sig-mini-val" id="margin-val2">0.0%</div>
        </div>
        <div class="sig-mini-cell">
          <div class="sig-mini-label">GÃ¼nlÃ¼k Ä°ÅŸlem</div>
          <div class="sig-mini-val" id="daily-trades-val2">0</div>
        </div>
      </div>
      <div class="sig-panel">
        <div style="padding:10px 12px;border-bottom:1px solid var(--border)">
          <div class="pane-title" style="margin-bottom:8px">Son Otomatik Sinyal</div>
          <div id="last-signal-content">
            <div class="empty-state"><div class="empty-state-icon">ğŸ“¡</div>Sinyal bekleniyor...</div>
          </div>
        </div>
        <div style="padding:10px 12px">
          <div class="pane-title" style="margin-bottom:6px">Risk Durumu</div>
          <div id="risk-status" style="font-size:10px;color:var(--text2)">â€“</div>
        </div>
        <div style="padding:10px 12px;border-top:1px solid var(--border)">
          <div class="pane-title" style="margin-bottom:6px">AÃ§Ä±k Pozisyonlar (Ã–zet)</div>
          <div id="overview-positions" style="font-size:10px;color:var(--text3)">AÃ§Ä±k pozisyon yok</div>
        </div>
      </div>
    </div>

  </div><!-- /right-panel -->

</div><!-- /main-layout -->

<!-- MODAL -->
<div class="modal-overlay" id="market-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeMarketModal()">âœ•</button>
    <div class="modal-title">Sembol SeÃ§</div>
    <input type="text" id="modal-search" placeholder="BTC, ETH, SOL..." oninput="filterModal(this.value)" style="margin-bottom:10px" />
    <div id="modal-list" style="max-height:320px;overflow-y:auto;"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast-container"></div>


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function extractErrorMessage(response) {
  if (!response) return "Bilinmeyen hata";
  if (typeof response === "string") return response;
  if (response.reason)  return String(response.reason);
  if (response.message) return String(response.message);
  if (response.detail) {
    if (Array.isArray(response.detail))
      return response.detail.map(e => e.msg || JSON.stringify(e)).join(", ");
    return String(response.detail);
  }
  try { return JSON.stringify(response); } catch { return "Hata"; }
}

function showToast(message, type = "error") {
  const icons = { error: "âœ•", success: "âœ“", info: "â„¹", warn: "âš " };
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]||"â€¢"}</span><span class="toast-msg">${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => { toast.style.animation = 'fadeOut 0.4s ease forwards'; setTimeout(() => toast.remove(), 400); }, 3600);
}

async function apiFetch(url, options = {}) {
  try {
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...options,
    });
    let data;
    try { data = await res.json(); }
    catch { data = { ok: false, reason: await res.text().catch(() => "Parse error") }; }

    if (!res.ok || data?.ok === false) {
      const msg = extractErrorMessage(data);
      showToast(msg, "error");
      return { ok: false, reason: msg, _raw: data };
    }
    return { ok: true, ...data };
  } catch (err) {
    const msg = err?.message || "AÄŸ baÄŸlantÄ± hatasÄ±";
    showToast(msg, "error");
    return { ok: false, reason: msg };
  }
}

function fmt(val, decimals = 2) {
  if (val === null || val === undefined || val === "â€“") return "â€“";
  const n = parseFloat(val);
  if (isNaN(n)) return String(val);
  return n.toFixed(decimals);
}

function fmtUSD(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "â€“";
  const sign = n >= 0 ? "+" : "";
  return sign + "$" + Math.abs(n).toFixed(2);
}

function fmtPrice(val) {
  const n = parseFloat(val);
  if (isNaN(n)) return "â€“";
  if (n >= 1000) return n.toFixed(2);
  if (n >= 1)    return n.toFixed(4);
  return n.toFixed(6);
}

function colorClass(val) {
  const n = parseFloat(val);
  if (isNaN(n) || n === 0) return "";
  return n > 0 ? "green" : "red";
}

function timeAgo(isoStr) {
  if (!isoStr) return "â€“";
  try {
    const diff = (Date.now() - new Date(isoStr).getTime()) / 1000;
    if (diff < 60)   return Math.round(diff) + "s Ã¶nce";
    if (diff < 3600) return Math.round(diff/60) + "dk Ã¶nce";
    return Math.round(diff/3600) + "sa Ã¶nce";
  } catch { return "â€“"; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let state = {
  symbol: "BTCUSDT",
  price: 0,
  allSymbols: [],
  filteredSymbols: [],
  positions: [],
  signalHistory: [],
  agentRunning: false,
  marketPrices: {},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".panel-content").forEach(p => p.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("tab-" + tab.dataset.tab).classList.add("active");
    if (tab.dataset.tab === "positions") loadPositions();
    if (tab.dataset.tab === "logs") fetchLogs();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS / OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshStatus() {
  try {
    const res = await fetch("/status/overview");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    // Connection
    document.getElementById("conn-dot").className = "dot online";
    document.getElementById("conn-label").textContent = "Online";

    // Helper fonksiyonlar â€” null-safe DOM gÃ¼ncelleme
    const _s = (id) => document.getElementById(id);
    const _set = (id, val) => { const el = _s(id); if (el) el.textContent = val; };

    // Header
    const bal = data.balance ?? data.wallet_balance ?? 0;
    _set("header-balance", "$" + parseFloat(bal).toFixed(2));

    // Stats â€” null-safe
    _set("balance-val", "$" + parseFloat(bal).toFixed(2));
    const pnl = data.unrealized_pnl ?? data.total_pnl ?? 0;
    const pnlEl = _s("pnl-val");
    if (pnlEl) {
      pnlEl.textContent = fmtUSD(pnl);
      pnlEl.className = "stat-val " + colorClass(pnl);
    }

    const pnlPct = bal > 0 ? (pnl / bal * 100) : 0;
    _set("pnl-pct", (pnlPct >= 0 ? "+" : "") + pnlPct.toFixed(2) + "%");

    _set("open-pos-val", data.open_positions ?? 0);
    _set("daily-trades-val", data.daily_trades ?? 0);

    const dt2 = _s("daily-trades-val2");
    if (dt2) dt2.textContent = data.daily_trades ?? 0;
    const risk = data.risk ?? {};
    const marginEl = _s("margin-val2");
    if (marginEl) marginEl.textContent = (parseFloat(risk.margin_usage_pct || data.margin_usage_pct || 0)).toFixed(1) + "%";
    const maxPosEl = _s("max-pos-sub");
    if (maxPosEl) maxPosEl.textContent = "Maks " + (risk.max_positions || 5) + " pozisyon";

    // Update header stats
    updateHeaderStats(data);

    const dailyPnl = data.daily_pnl ?? 0;
    const dailySub = _s("daily-pnl-sub");
    if (dailySub) {
      dailySub.textContent = fmtUSD(dailyPnl);
      dailySub.style.color = dailyPnl >= 0 ? "var(--green)" : "var(--red)";
    }

    // Signal engine
    const se = data.signal_engine ?? {};
    _set("signal-count-val", se.signal_count ?? 0);
    _set("agent-trade-count", se.signal_count ?? 0);
    _set("agent-scan-interval", (se.scan_interval_min ?? 15) + " dk");

    if (se.running !== undefined) {
      state.agentRunning = se.running;
      const agentToggle = _s("agent-toggle");
      if (agentToggle) agentToggle.checked = se.running;
      const agentStatusEl = _s("agent-status-val");
      if (agentStatusEl) {
        agentStatusEl.textContent = se.running ? "Aktif" : "Pasif";
        agentStatusEl.style.color = se.running ? "var(--green)" : "var(--text3)";
      }
      const ctrlToggle = _s("ctrl-agent-toggle");
      if (ctrlToggle) ctrlToggle.checked = se.running;
      const ctrlStatusText = _s("ctrl-agent-status-text");
      if (ctrlStatusText) {
        ctrlStatusText.textContent = se.running ? "âœ… Ajan Ã§alÄ±ÅŸÄ±yor" : "â¹ Ajan durduruldu";
        ctrlStatusText.style.color = se.running ? "var(--green)" : "var(--text3)";
      }
    }

    // RL agent
    const rl = data.rl_agent ?? {};
    _set("agent-epsilon", rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "â€“");

    // Sinyaller sekmesi ajan paneli gÃ¼ncelle
    const sigStatus = document.getElementById("sig-agent-status");
    if (sigStatus) {
      const isRunning = se.running ?? false;
      sigStatus.textContent = isRunning ? "âœ… Ã‡alÄ±ÅŸÄ±yor" : "â¹ Durduruldu";
      sigStatus.style.color = isRunning ? "var(--green)" : "var(--text3)";
    }
    const sigCount = document.getElementById("sig-trade-count");
    if (sigCount) sigCount.textContent = se.signal_count ?? se.trade_count ?? 0;
    const sigEps = document.getElementById("sig-epsilon");
    if (sigEps) sigEps.textContent = rl.epsilon !== undefined ? fmt(rl.epsilon, 3) : "â€“";

    // Regime
    const regime = data.regime ?? data.market_regime ?? "â€“";
    const regimeEl = _s("regime-val");
    if (regimeEl) {
      regimeEl.textContent = regime;
      regimeEl.style.color = regime === "trend" ? "var(--green)"
                           : regime === "range" ? "var(--yellow)"
                           : "var(--text)";
    }

    const atrVal = data.atr_14 ?? data.atr ?? 0;
    _set("atr-sub", "ATR: " + fmtPrice(atrVal));

    // Price
    const price = data.mark_price ?? data.last_price ?? 0;
    if (price) {
      state.price = price;
      _set("current-price", fmtPrice(price));
      updatePnLPreview();
    }

    // Last signal
    renderLastSignal(se.last_signal);

    // Risk
    renderRisk(data);

  } catch (err) {
    document.getElementById("conn-dot").className = "dot offline";
    document.getElementById("conn-label").textContent = "BaÄŸlantÄ± yok";
    addLog("Durum gÃ¼ncellenemedi: " + (err?.message || err), "warn");
  }
}

function renderLastSignal(sig) {
  const el = document.getElementById("last-signal-content");
  if (!el) return;
  if (!sig || !sig.time) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ“¡</div>Sinyal bekleniyor...</div>';
    return;
  }
  // last-signal-time opsiyonel (eski layout'ta vardÄ±)
  const timeEl = document.getElementById("last-signal-time");
  if (timeEl) timeEl.textContent = timeAgo(sig.time);

  const side = sig.side;
  const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
  const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
  const score = parseFloat(sig.score || 0);
  const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
  const fillClass = score > 0 ? "positive" : score < 0 ? "negative" : "positive";

  // Push to history
  if (sig.time && !state.signalHistory.find(s => s.time === sig.time)) {
    state.signalHistory.unshift(sig);
    if (state.signalHistory.length > 50) state.signalHistory.pop();
    renderSignalsTab();
  }

  const detailsHtml = (sig.details || []).slice(0, 5).map(d =>
    `<div class="signal-detail-row"><span>${d}</span></div>`
  ).join("");

  el.innerHTML = `
    <div class="signal-card" style="margin-bottom:0">
      <div class="signal-header">
        <div class="signal-symbol">${sig.symbol || state.symbol}</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
          <div class="signal-side ${sideClass}">${sideLabel}</div>
        </div>
      </div>
      <div class="signal-score-bar">
        <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px">
        <span>Skor: <strong style="color:var(--text)">${score >= 0 ? "+" : ""}${score.toFixed(3)}</strong></span>
        <span>GÃ¼Ã§: <strong style="color:var(--text)">${sig.strength || "â€“"}</strong></span>
      </div>
      ${detailsHtml ? `<div class="signal-details open">${detailsHtml}</div>` : ""}
    </div>`;
}

function renderSignalsTab() {
  const el = document.getElementById("signals-content");
  if (!state.signalHistory.length) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ“Š</div>Sinyal bekleniyor...</div>';
    return;
  }
  el.innerHTML = state.signalHistory.map(sig => {
    const side = sig.side;
    const sideClass = side === "BUY" ? "buy" : side === "SELL" ? "sell" : "none";
    const sideLabel = side === "BUY" ? "LONG" : side === "SELL" ? "SHORT" : "YOK";
    const score = parseFloat(sig.score || 0);
    const pct = Math.min(Math.abs(score) / 0.75 * 100, 100);
    const fillClass = score > 0 ? "positive" : "negative";
    return `
      <div class="signal-card">
        <div class="signal-header">
          <div class="signal-symbol" style="font-size:13px">${sig.symbol || "â€“"}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-size:10px;color:var(--text3)">${timeAgo(sig.time)}</span>
            <div class="signal-side ${sideClass}">${sideLabel}</div>
          </div>
        </div>
        <div class="signal-score-bar">
          <div class="signal-score-fill ${fillClass}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:10px;color:var(--text3)">Skor: ${score >= 0 ? "+" : ""}${score.toFixed(3)} Â· ${sig.strength || ""}</div>
      </div>`;
  }).join("");
}

function renderRisk(data) {
  const el = document.getElementById("risk-content");
  const risk = data.risk ?? {};
  const maxPos = risk.max_positions ?? data.max_positions ?? 5;
  const openPos = data.open_positions ?? 0;
  const margin = risk.margin_usage_pct ?? data.margin_usage_pct ?? 0;
  const marginPct = parseFloat(margin).toFixed(1);
  const marginColor = marginPct > 70 ? "var(--red)" : marginPct > 40 ? "var(--yellow)" : "var(--green)";

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div class="agent-info-item">
        <div class="agent-info-label">Pozisyon KullanÄ±mÄ±</div>
        <div class="agent-info-value">${openPos} / ${maxPos}</div>
      </div>
      <div class="agent-info-item">
        <div class="agent-info-label">Margin KullanÄ±mÄ±</div>
        <div class="agent-info-value" style="color:${marginColor}">${marginPct}%</div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW POZÄ°SYON Ã–ZETÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshOverviewPositions() {
  try {
    const result = await apiFetch("/execution/positions/live");
    const positions = (result.ok ? result.positions : null) || [];
    state.positions = positions;

    const list = document.getElementById("overview-positions-list");
    const wrap = document.getElementById("overview-positions-wrap");
    const _opv = document.getElementById("open-pos-val"); if (_opv) _opv.textContent = positions.length;

    if (!positions.length) {
      if (wrap) wrap.style.display = "none";
      if (list) list.innerHTML = '<div style="color:var(--text3);font-size:11px;padding:8px 0">AÃ§Ä±k pozisyon yok</div>';
      return;
    }
    if (wrap) wrap.style.display = "block";

    list.innerHTML = positions.map(pos => {
      const pnl    = parseFloat(pos.unrealized_pnl ?? 0);
      const pnlPct = parseFloat(pos.pnl_pct ?? 0);
      const isLong = (pos.side || "").toUpperCase() === "LONG";
      const sideColor = isLong ? "var(--green)" : "var(--red)";
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="color:#fff;font-weight:600">${pos.symbol}</span>
            <span style="color:${sideColor};font-size:10px;font-weight:700">${pos.side}</span>
            <span style="color:var(--yellow);font-size:10px">${pos.leverage}x</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="text-align:right">
              <div style="font-size:11px;color:var(--text2)">GiriÅŸ: ${fmtPrice(pos.entry_price)}</div>
              <div style="font-size:10px;color:var(--text3)">Mark: ${fmtPrice(pos.mark_price)}</div>
            </div>
            <div style="text-align:right;min-width:70px">
              <div style="font-size:13px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
              <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
            </div>
            <button onclick="closePosition('${pos.symbol}','${pos.side}')"
              style="padding:4px 8px;background:rgba(255,61,87,0.1);border:1px solid rgba(255,61,87,0.3);color:var(--red);font-family:var(--mono);font-size:10px;border-radius:4px;cursor:pointer">
              Kapat
            </button>
          </div>
        </div>`;
    }).join("");
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadPositions() {
  const el = document.getElementById("positions-content");
  el.innerHTML = '<div class="loading-text"><span class="spinner"></span> Binance\'den yÃ¼kleniyor...</div>';

  // Ã–nce canlÄ± endpoint'i dene, olmazsa eski endpoint
  let result = await apiFetch("/execution/positions/live");
  if (!result.ok) result = await apiFetch("/execution/positions");

  if (!result.ok) {
    el.innerHTML = `<div class="empty-state"><div>âš </div>${result.reason || "BaÄŸlantÄ± hatasÄ±"}</div>`;
    return;
  }

  const positions = result.positions || [];
  state.positions = positions;
  const _opv = document.getElementById("open-pos-val"); if (_opv) _opv.textContent = positions.length;

  // Toplam PNL hesapla
  const totalPnl = positions.reduce((s, p) => s + parseFloat(p.unrealized_pnl ?? 0), 0);
  const pnlEl = document.getElementById("pos-total-pnl");
  if (pnlEl) {
    pnlEl.textContent = `PNL: ${totalPnl >= 0 ? "+" : ""}$${Math.abs(totalPnl).toFixed(2)}`;
    pnlEl.style.color = totalPnl >= 0 ? "var(--green)" : "var(--red)";
  }

  if (!positions.length) {
    el.innerHTML = '<div class="empty-state"><div>ğŸ”</div>AÃ§Ä±k pozisyon yok</div>';
    return;
  }

  el.innerHTML = positions.map(pos => {
    const pnl     = parseFloat(pos.unrealized_pnl ?? 0);
    const pnlPct  = parseFloat(pos.pnl_pct ?? 0);
    const side    = (pos.side || "â€“").toUpperCase();
    const isLong  = side === "LONG" || side === "BUY";
    const sideColor = isLong ? "var(--green)" : "var(--red)";
    const sideBg    = isLong ? "rgba(0,230,118,0.1)" : "rgba(255,61,87,0.1)";
    const liq     = parseFloat(pos.liquidation_price ?? 0);
    const margin  = parseFloat(pos.margin ?? 0);
    const notional= parseFloat(pos.notional ?? 0);

    return `
    <div style="background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;">
      <!-- BaÅŸlÄ±k satÄ±rÄ± -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-family:var(--sans);font-size:15px;font-weight:700;color:#fff">${pos.symbol || "â€“"}</span>
          <span style="background:${sideBg};color:${sideColor};border:1px solid ${sideColor}33;border-radius:4px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:0.05em">${side}</span>
          <span style="background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:10px;color:var(--yellow)">${pos.leverage ?? 1}x</span>
        </div>
        <div style="text-align:right">
          <div style="font-size:15px;font-weight:700;color:${pnl >= 0 ? "var(--green)" : "var(--red)"}">${pnl >= 0 ? "+" : ""}$${Math.abs(pnl).toFixed(2)}</div>
          <div style="font-size:10px;color:${pnl >= 0 ? "var(--green)" : "var(--red)"};opacity:0.8">${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%</div>
        </div>
      </div>

      <!-- Detay grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">GiriÅŸ</div>
          <div style="font-size:12px;color:var(--text)">${fmtPrice(pos.entry_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Mark</div>
          <div style="font-size:12px;color:var(--cyan)">${fmtPrice(pos.mark_price)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Liq.</div>
          <div style="font-size:12px;color:${liq > 0 ? "var(--red)" : "var(--text3)"}">${liq > 0 ? fmtPrice(liq) : "â€“"}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Miktar</div>
          <div style="font-size:12px;color:var(--text)">${fmt(pos.contracts ?? 0, 4)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Notional</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(notional, 2)}</div>
        </div>
        <div style="background:var(--bg3);border-radius:5px;padding:7px 9px">
          <div style="font-size:9px;color:var(--text3);margin-bottom:2px;text-transform:uppercase">Margin</div>
          <div style="font-size:12px;color:var(--text)">$${fmt(margin, 2)}</div>
        </div>
      </div>

      <!-- Kapat butonu -->
      <button onclick="closePosition('${pos.symbol}','${side}')"
        style="width:100%;padding:8px;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.25);color:var(--red);font-family:var(--mono);font-size:11px;border-radius:6px;cursor:pointer;transition:all 0.15s;font-weight:600"
        onmouseover="this.style.background='rgba(255,61,87,0.2)'"
        onmouseout="this.style.background='rgba(255,61,87,0.08)'">
        ğŸ›‘ ${pos.symbol} Pozisyonunu Kapat
      </button>
    </div>`;
  }).join("");
}

async function closePosition(symbol, side) {
  if (!confirm(`${symbol} ${side} pozisyonunu kapatmak istediÄŸinize emin misiniz?`)) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol, side }),
  });
  if (result.ok) {
    showToast(`âœ… ${symbol} pozisyonu kapatÄ±ldÄ±`, "success");
    addLog(`Pozisyon kapatÄ±ldÄ±: ${symbol} ${side}`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    const errMsg = result.reason || result.error || "Bilinmeyen hata";
    showToast(`âŒ Kapatma hatasÄ±: ${errMsg}`, "error");
    addLog(`Kapatma hatasÄ± [${symbol}]: ${errMsg}`, "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MARKET LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadMarketList() {
  try {
    const res = await fetch("/status/symbols");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    state.allSymbols = data.symbols || data || [];
    const cnt = state.allSymbols.length + " Ã§ift";
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = cnt;
    if (el2) el2.textContent = state.allSymbols.length;
    renderMarketList(state.allSymbols);
    renderMarketListRight(state.allSymbols);
    const cnt2 = document.getElementById('market-count-label'); if(cnt2) cnt2.textContent = state.allSymbols.length;
    renderModalList(state.allSymbols);
  } catch (err) {
    const fallback = [
      "BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT","DOGEUSDT",
      "ADAUSDT","AVAXUSDT","LINKUSDT","DOTUSDT","MATICUSDT","LTCUSDT",
      "ATOMUSDT","UNIUSDT","NEARUSDT","APTUSDT","ARBUSDT","OPUSDT",
    ];
    state.allSymbols = fallback;
    const el1 = document.getElementById("market-count");
    const el2 = document.getElementById("market-count2");
    if (el1) el1.textContent = fallback.length + " Ã§ift";
    if (el2) el2.textContent = fallback.length;
    renderMarketList(fallback);
    renderModalList(fallback);
  }
}

function renderMarketList(symbols) {
  // Center panel - coin grid
  const el = document.getElementById("market-list");
  if (el) {
    if (!symbols.length) {
      el.innerHTML = '<div class="loading-text">Sembol bulunamadÄ±</div>';
    } else {
      el.innerHTML = symbols.slice(0, 99).map(sym => {
        const base = String(sym).replace("USDT","").replace("BUSD","");
        const selected = sym === state.symbol ? "selected" : "";
        const chgData = state.marketPrices && state.marketPrices[sym];
        const chg = chgData ? chgData.chg : null;
        const price = chgData ? chgData.price : null;
        const chgClass = chg === null ? "" : (chg >= 0 ? "pos" : "neg");
        const chgStr = chg === null ? "" : (chg >= 0 ? "+" : "") + chg.toFixed(2) + "%";
        return `
          <div class="coin-cell ${selected}" onclick="selectSymbol('${sym}')">
            <div class="coin-sym">${base}</div>
            <div class="coin-price">${price ? fmtPrice(price) : ""}</div>
            <div class="coin-chg ${chgClass}">${chgStr}</div>
          </div>`;
      }).join("");
    }
  }
  // Right panel - market list
  const el2 = document.getElementById("market-list-right");
  if (el2) {
    el2.innerHTML = symbols.slice(0, 100).map(sym => {
      const base = String(sym).replace("USDT","").replace("BUSD","");
      return `
        <div class="market-item" onclick="selectSymbol('${sym}')">
          <div class="market-sym">${base}<span style="color:var(--text3)">/USDT</span></div>
          <button class="market-add-btn" onclick="event.stopPropagation();selectSymbol('${sym}')">+ Ä°ÅŸlem</button>
        </div>`;
    }).join("");
  }
}

function renderModalList(symbols) {
  const el = document.getElementById("modal-list");
  el.innerHTML = symbols.slice(0, 200).map(sym => {
    const base = String(sym).replace("USDT", "").replace("BUSD", "");
    return `
      <div class="market-item" onclick="selectSymbol('${sym}');closeMarketModal()" style="padding:10px 12px">
        <div class="market-sym">${base}<span>/USDT</span></div>
        <div style="font-size:10px;color:var(--text3)">${sym}</div>
      </div>`;
  }).join("");
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

function filterModal(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderModalList(filtered);
}

function selectSymbol(sym) {
  state.symbol = sym;
  document.getElementById("selected-symbol").textContent = sym;
  document.getElementById("current-price").textContent = "â€“";
  renderMarketList(state.allSymbols.filter(s =>
    s.toLowerCase().includes(document.getElementById("market-search-input").value.toLowerCase())
  ));
  // Fiyat gÃ¼ncelle
  fetchSymbolPrice(sym);
  addLog(`Sembol deÄŸiÅŸtirildi: ${sym}`, "info");
}

async function fetchSymbolPrice(sym) {
  try {
    const res = await fetch(`/status/price?symbol=${sym}`);
    if (!res.ok) return;
    const data = await res.json();
    const price = data.price ?? data.mark_price ?? 0;
    if (price) {
      state.price = price;
      document.getElementById("current-price").textContent = fmtPrice(price);
      updatePnLPreview();
    }
  } catch {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  P&L PREVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updatePnLPreview() {
  const qty = parseFloat(document.getElementById("qty-input").value) || 100;
  const tp = parseFloat(document.getElementById("tp-input").value) || 3;
  const lev = parseFloat(document.getElementById("leverage-input").value) || 3;
  const maxPnl = qty * (tp / 100);
  const el = document.getElementById("pnl-preview");
  el.textContent = "+" + "$" + maxPnl.toFixed(2) + " max TP";
}

["qty-input","tp-input","leverage-input","sl-input"].forEach(id => {
  document.getElementById(id)?.addEventListener("input", updatePnLPreview);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADE ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handleLong() {
  await submitTrade("BUY");
}
async function handleShort() {
  await submitTrade("SELL");
}

async function submitTrade(side) {
  const symbol    = state.symbol;
  const qty       = parseFloat(document.getElementById("qty-input").value) || 100;
  const leverage  = parseInt(document.getElementById("leverage-input").value) || 3;
  const orderType = document.getElementById("order-type").value;
  const slPct     = parseFloat(document.getElementById("sl-input").value) || 1.5;
  const tpPct     = parseFloat(document.getElementById("tp-input").value) || 3.0;

  const btnId = side === "BUY" ? "btn-long" : "btn-short";
  const btn = document.getElementById(btnId);
  const origHtml = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> Ä°ÅŸleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({
      symbol,
      side,
      quantity: qty,
      leverage,
      order_type: orderType,
      sl_pct: slPct,
      tp_pct: tpPct,
      strategy_tag: "manual",
    }),
  });

  btn.disabled = false;
  btn.innerHTML = origHtml;

  if (result.ok) {
    const sideLabel = side === "BUY" ? "LONG" : "SHORT";
    showToast(`âœ… ${sideLabel} iÅŸlem aÃ§Ä±ldÄ±: ${symbol}`, "success");
    addLog(`Ä°ÅŸlem aÃ§Ä±ldÄ±: ${symbol} ${sideLabel} ${qty} USDT`, "ok");
    await loadPositions();
    await refreshStatus();
  } else {
    addLog(`Ä°ÅŸlem reddedildi: ${result.reason}`, "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONTROL PANELÄ° â€” Ä°ÅŸlem Testi
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ctrlUpdateTestPreview() {
  const sym  = document.getElementById("test-symbol").value || "BTCUSDT";
  const side = document.getElementById("test-side").value;
  const qty  = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev  = parseFloat(document.getElementById("test-lev").value) || 3;
  const sl   = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const tp   = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const maxGain = (qty * tp / 100).toFixed(2);
  const maxLoss = (qty * sl / 100).toFixed(2);
  const sideLabel = side === "BUY" ? "ğŸŸ¢ LONG" : "ğŸ”´ SHORT";
  document.getElementById("test-preview").innerHTML =
    `<span style="color:#fff">${sym}</span> ${sideLabel} &nbsp;|&nbsp; ` +
    `Miktar: <span style="color:var(--cyan)">$${qty}</span> &nbsp;|&nbsp; ` +
    `KaldÄ±raÃ§: <span style="color:var(--yellow)">${lev}x</span><br>` +
    `Max KÃ¢r: <span style="color:var(--green)">+$${maxGain}</span> &nbsp;|&nbsp; ` +
    `Max KayÄ±p: <span style="color:var(--red)">-$${maxLoss}</span> &nbsp;|&nbsp; ` +
    `SL: ${sl}% / TP: ${tp}%`;
}

["test-symbol","test-side","test-qty","test-lev","test-sl","test-tp","test-order-type"].forEach(id => {
  document.getElementById(id)?.addEventListener("input",  ctrlUpdateTestPreview);
  document.getElementById(id)?.addEventListener("change", ctrlUpdateTestPreview);
});

async function ctrlOpenTrade(forceSide) {
  const side   = forceSide || document.getElementById("test-side").value;
  const symbol = document.getElementById("test-symbol").value.trim().toUpperCase() || "BTCUSDT";
  const qty    = parseFloat(document.getElementById("test-qty").value) || 100;
  const lev    = parseInt(document.getElementById("test-lev").value) || 3;
  const tp     = parseFloat(document.getElementById("test-tp").value) || 3.0;
  const sl     = parseFloat(document.getElementById("test-sl").value) || 1.5;
  const otype  = document.getElementById("test-order-type").value;

  const btnId = side === "BUY" ? "ctrl-btn-long" : "ctrl-btn-short";
  const btn = document.getElementById(btnId);
  const orig = btn.innerHTML;
  btn.disabled = true; btn.innerHTML = `<span class="spinner"></span> Ä°ÅŸleniyor...`;

  const result = await apiFetch("/execution/open", {
    method: "POST",
    body: JSON.stringify({ symbol, side, quantity: qty, leverage: lev,
      order_type: otype, sl_pct: sl, tp_pct: tp, strategy_tag: "manual_test" }),
  });

  btn.disabled = false; btn.innerHTML = orig;

  const el = document.getElementById("test-result");
  el.style.display = "block";
  if (result.ok) {
    el.style.cssText = "display:block;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--green);margin-top:10px";
    el.innerHTML = `âœ… Ä°ÅŸlem aÃ§Ä±ldÄ±: <strong>${symbol}</strong> ${side === "BUY" ? "LONG" : "SHORT"} $${qty} â€” ${new Date().toLocaleTimeString("tr-TR")}`;
    showToast(`âœ… ${symbol} ${side === "BUY" ? "LONG" : "SHORT"} aÃ§Ä±ldÄ±`, "success");
    addLog(`TEST iÅŸlemi aÃ§Ä±ldÄ±: ${symbol} ${side} $${qty} ${lev}x`, "ok");
    await loadPositions(); await refreshStatus();
  } else {
    el.style.cssText = "display:block;background:rgba(255,61,87,0.08);border:1px solid rgba(255,61,87,0.3);border-radius:6px;padding:10px 12px;font-size:11px;color:var(--red);margin-top:10px";
    el.innerHTML = `âŒ Hata: ${result.reason || "Bilinmeyen hata"}`;
    addLog(`TEST iÅŸlemi reddedildi: ${result.reason}`, "error");
  }
}

async function ctrlCloseAll() {
  if (!confirm("TÃ¼m aÃ§Ä±k pozisyonlarÄ± kapatmak istediÄŸinize emin misiniz?")) return;
  const result = await apiFetch("/execution/close", {
    method: "POST",
    body: JSON.stringify({ symbol: "ALL" }),
  });
  if (result.ok) {
    showToast("âœ… TÃ¼m pozisyonlar kapatÄ±ldÄ±", "success");
    addLog("TÃ¼m pozisyonlar manuel kapatÄ±ldÄ±", "warn");
    await loadPositions(); await refreshStatus();
  } else {
    showToast("âŒ Kapatma hatasÄ±: " + (result.reason || "?"), "error");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONTROL PANELÄ° â€” Ajan AyarlarÄ±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ctrlUpdateAgentPreview() {
  const scan    = document.getElementById("ctrl-scan-interval").value;
  const eps     = document.getElementById("ctrl-epsilon").value;
  const minScore= document.getElementById("ctrl-min-score").value;
  const maxPos  = document.getElementById("ctrl-max-pos").value;
  const dayLoss = document.getElementById("ctrl-daily-loss").value;
  const drawdown= document.getElementById("ctrl-max-drawdown").value;
  const rpt     = document.getElementById("ctrl-risk-per-trade").value;
  const conLoss = document.getElementById("ctrl-consec-loss").value;
  document.getElementById("ctrl-agent-preview").innerHTML =
    `Tarama: <span style="color:var(--cyan)">${scan} dk</span> &nbsp;|&nbsp; ` +
    `Epsilon: <span style="color:var(--yellow)">${eps}</span> &nbsp;|&nbsp; ` +
    `Min Skor: <span style="color:var(--cyan)">${minScore}</span><br>` +
    `Max Poz: <span style="color:var(--cyan)">${maxPos}</span> &nbsp;|&nbsp; ` +
    `GÃ¼nlÃ¼k KayÄ±p: <span style="color:var(--red)">${dayLoss}%</span> &nbsp;|&nbsp; ` +
    `Drawdown: <span style="color:var(--red)">${drawdown}%</span><br>` +
    `Risk/Ä°ÅŸlem: <span style="color:var(--green)">${rpt}%</span> &nbsp;|&nbsp; ` +
    `Ard. KayÄ±p: <span style="color:var(--yellow)">${conLoss}</span>`;
}

async function ctrlToggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const statusEl = document.getElementById("ctrl-agent-status-text");
  if (result.ok !== false) {
    state.agentRunning = enabled;
    statusEl.textContent = enabled ? "âœ… Ajan Ã§alÄ±ÅŸÄ±yor" : "â¹ Ajan durduruldu";
    statusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    // Ana panel toggle da gÃ¼ncelle
    const mainToggle = document.getElementById("agent-toggle");
    if (mainToggle) mainToggle.checked = enabled;
    showToast(enabled ? "ğŸ¤– Ajan aktifleÅŸtirildi" : "â¹ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Ajan baÅŸlatÄ±ldÄ± (kontrol panelinden)" : "Ajan durduruldu (kontrol panelinden)", enabled ? "ok" : "warn");
  }
}

async function ctrlApplyAgentSettings() {
  const settings = {
    scan_interval_min: parseInt(document.getElementById("ctrl-scan-interval").value),
    rl_epsilon:        parseFloat(document.getElementById("ctrl-epsilon").value),
    min_signal_score:  parseFloat(document.getElementById("ctrl-min-score").value),
    max_positions:     parseInt(document.getElementById("ctrl-max-pos").value),
    daily_max_loss_pct:parseFloat(document.getElementById("ctrl-daily-loss").value),
    max_drawdown_pct:  parseFloat(document.getElementById("ctrl-max-drawdown").value),
    risk_per_trade_pct:parseFloat(document.getElementById("ctrl-risk-per-trade").value),
    kill_switch_consecutive_loss: parseInt(document.getElementById("ctrl-consec-loss").value),
  };

  // /status/agent endpoint'ine settings gÃ¶nder
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: state.agentRunning, settings }),
  });

  if (result.ok !== false) {
    showToast("ğŸ’¾ Ajan ayarlarÄ± uygulandÄ±", "success");
    addLog(`Ajan ayarlarÄ± gÃ¼ncellendi: scan=${settings.scan_interval_min}dk eps=${settings.rl_epsilon}`, "ok");
  } else {
    showToast("âš  Ayarlar uygulanamadÄ±: " + (result.reason || "?"), "warn");
  }
}

async function ctrlKillSwitch(activate) {
  const action = activate ? "aktifleÅŸtir" : "devre dÄ±ÅŸÄ± bÄ±rak";
  if (!confirm(`Kill switch'i ${action}mak istediÄŸinize emin misiniz?`)) return;

  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled: !activate, kill_switch: activate }),
  });

  const el = document.getElementById("kill-switch-status");
  if (activate) {
    el.style.color = "var(--red)";
    el.textContent = "ğŸ”´ Kill Switch AKTÄ°F â€” Bot tÃ¼m iÅŸlemleri durdurdu";
    showToast("ğŸ”´ Kill Switch aktifleÅŸtirildi!", "error");
    addLog("KILL SWITCH AKTÄ°F â€” tÃ¼m iÅŸlemler durduruldu", "error");
    // Ajan toggle'Ä± kapat
    document.getElementById("ctrl-agent-toggle").checked = false;
    document.getElementById("ctrl-agent-status-text").textContent = "ğŸ”´ Kill switch aktif";
    document.getElementById("ctrl-agent-status-text").style.color = "var(--red)";
  } else {
    el.style.color = "var(--green)";
    el.textContent = "ğŸŸ¢ Kill Switch devre dÄ±ÅŸÄ± â€” Bot normal Ã§alÄ±ÅŸmaya devam edebilir";
    showToast("ğŸŸ¢ Kill Switch devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±", "success");
    addLog("Kill switch devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ± (manuel)", "warn");
  }
}

// Kontrol sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda preview gÃ¼ncelle
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    if (tab.dataset.tab === "control") {
      ctrlUpdateTestPreview();
      ctrlUpdateAgentPreview();
    }
  });
});

function copyWebhookUrl() {
  const url = document.getElementById("webhook-url").textContent;
  navigator.clipboard.writeText(url).then(() => showToast("ğŸ“‹ URL kopyalandÄ±", "success"));
}

function copyWebhookJson() {
  const json = `{\n  "symbol": "BTCUSDT",\n  "side": "BUY",\n  "timeframe": "1h",\n  "strategy_tag": "ema_cross",\n  "secret": "tv-secret"\n}`;
  navigator.clipboard.writeText(json).then(() => showToast("ğŸ“‹ JSON kopyalandÄ±", "success"));
}

// AGENT TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function toggleAgent(enabled) {
  const result = await apiFetch("/status/agent", {
    method: "POST",
    body: JSON.stringify({ enabled }),
  });
  const agentStatusEl = document.getElementById("agent-status-val");
  if (result.ok || true) { // optimistic
    state.agentRunning = enabled;
    agentStatusEl.textContent = enabled ? "Aktif" : "Pasif";
    agentStatusEl.style.color = enabled ? "var(--green)" : "var(--text3)";
    showToast(enabled ? "ğŸ¤– Otomatik ajan aktifleÅŸtirildi" : "â¹ Ajan durduruldu", enabled ? "success" : "info");
    addLog(enabled ? "Otomatik ajan baÅŸlatÄ±ldÄ±" : "Otomatik ajan durduruldu", enabled ? "ok" : "warn");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMarketModal() {
  document.getElementById("market-modal").classList.add("open");
  document.getElementById("modal-search").focus();
}
function closeMarketModal() {
  document.getElementById("market-modal").classList.remove("open");
}
document.getElementById("market-modal").addEventListener("click", e => {
  if (e.target === document.getElementById("market-modal")) closeMarketModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _logKeys = new Set();  // dedup: "time|msg"

function addLog(message, type = "info", time = null) {
  const el = document.getElementById("log-area");
  if (!el) return;
  const ts = time || new Date().toTimeString().slice(0, 8);
  const key = ts + "|" + message;
  if (_logKeys.has(key)) return;  // duplicate Ã¶nle
  _logKeys.add(key);
  if (_logKeys.size > 500) {
    const oldest = _logKeys.values().next().value;
    _logKeys.delete(oldest);
  }
  const line = document.createElement("div");
  line.className = `log-line ${type}`;
  line.innerHTML = `<span class="log-time">${ts}</span>${escHtml(message)}`;
  // En yeni Ã¼stte gÃ¶ster
  if (el.firstChild) {
    el.insertBefore(line, el.firstChild);
  } else {
    el.appendChild(line);
  }
  while (el.children.length > 300) el.removeChild(el.lastChild);
  // Scroll sadece kullanÄ±cÄ± zaten en Ã¼stteyse
  if (el.scrollTop < 30) el.scrollTop = 0;
}

function escHtml(str) {
  return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

let _logFilter = "all";

function setLogFilter(level, btn) {
  _logFilter = level;
  document.querySelectorAll(".log-filter-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  applyLogFilter();
}

function applyLogFilter() {
  const el = document.getElementById("log-area");
  if (!el) return;
  el.querySelectorAll(".log-line").forEach(line => {
    if (_logFilter === "all") {
      line.style.display = "";
    } else if (_logFilter === "agent") {
      line.style.display = (line.textContent.includes("ğŸ¤–") || line.textContent.includes("RL") || line.textContent.includes("Sinyal") || line.textContent.includes("Ä°ÅŸlem aÃ§")) ? "" : "none";
    } else {
      line.style.display = line.classList.contains(_logFilter) ? "" : "none";
    }
  });
}

let _lastLogTotal = -1;

async function fetchLogs() {
  try {
    const res = await fetch("/status/logs?limit=200");
    if (!res.ok) return;
    const data = await res.json();
    const logs = (data.logs || data || []);
    
    // EÄŸer yeni log yoksa hiÃ§bir ÅŸey yapma (flicker Ã¶nle)
    if (data.total !== undefined && data.total === _lastLogTotal && logs.length > 0) return;
    _lastLogTotal = data.total || logs.length;

    // Yeni loglarÄ± ekle (en yeni Ã¶nce geliyor, dedup ile Ã§ift ekleme olmaz)
    logs.forEach(entry => {
      let msg, lvl, time;
      if (typeof entry === "string") {
        msg = entry; lvl = "info"; time = null;
      } else {
        msg = entry.message || entry.msg || JSON.stringify(entry);
        time = entry.time || null;
        const lv = (entry.level || "").toUpperCase();
        lvl = lv === "ERROR" ? "error" 
            : lv === "WARNING" ? "warn"
            : (msg.includes("âœ…") || msg.includes("aÃ§Ä±ldÄ±") || msg.includes("hazÄ±r") || msg.includes("Emir:")) ? "ok" 
            : "info";
      }
      addLog(msg, lvl, time);
    });
    applyLogFilter();
  } catch(e) {
    // sessiz hata
  }
}

function clearLogs() {
  const el = document.getElementById("log-area");
  if (el) el.innerHTML = "";
  _logKeys.clear();
  _lastLogTotal = -1;
  addLog("Loglar temizlendi", "info");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT & POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchFarTab(tab, el) {
  document.querySelectorAll(".far-tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".far-panel").forEach(p => p.classList.remove("active"));
  el.classList.add("active");
  const panel = document.getElementById("far-panel-" + tab);
  if (panel) panel.classList.add("active");
}

let _sortMode = "pct";
function sortMarket(mode) {
  _sortMode = mode;
  document.querySelectorAll(".sort-btn").forEach(b => {
    b.classList.toggle("active", b.getAttribute("onclick").includes(mode));
  });
  // Re-render with current list
  renderMarketList(state.allSymbols);
    renderMarketListRight(state.allSymbols);
    const cnt2 = document.getElementById('market-count-label'); if(cnt2) cnt2.textContent = state.allSymbols.length;
}

function filterMarket(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketList(filtered);
}

// Update header stats from overview data

function filterMarketList(q) {
  const filtered = state.allSymbols.filter(s => s.toLowerCase().includes(q.toLowerCase()));
  renderMarketListRight(filtered);
}

function renderMarketListRight(symbols) {
  const el = document.getElementById("market-list-right");
  if (!el) return;
  const list = (symbols || state.allSymbols).slice(0, 200);
  el.innerHTML = list.map(sym => {
    const selected = sym === state.symbol ? "selected" : "";
    return `<div class="market-item ${selected}" onclick="selectSymbol('${sym}')">
      <span class="market-item-sym">${sym.replace('USDT','')}</span>
      <span class="market-item-quote">/USDT</span>
    </div>`;
  }).join("");
}

function updateHeaderStats(data) {
  const bal = parseFloat(data.balance || data.wallet_balance || 0);
  const pnl = parseFloat(data.unrealized_pnl || 0);
  const se = data.signal_engine || {};
  const hb = document.getElementById("header-balance");
  const hp = document.getElementById("header-pnl");
  if (hb) hb.textContent = "$" + bal.toFixed(2);
  if (hp) {
    hp.textContent = (pnl >= 0 ? "+" : "") + "$" + pnl.toFixed(2);
    hp.style.color = pnl >= 0 ? "var(--green)" : "var(--red)";
  }
  // Update balance-val in stats bar
  const bv = document.getElementById("balance-val");
  if (bv) bv.textContent = "$" + bal.toFixed(2);
  // Update agent header btn
  const aBtn = document.getElementById("header-agent-btn");
  if (aBtn && se.running !== undefined) {
    aBtn.textContent = se.running ? "â–  DURDUR AJAN" : "â–¶ BAÅLAT";
    aBtn.className = se.running ? "btn-stop" : "btn-start";
    aBtn.onclick = se.running ? () => toggleAgent(false) : () => toggleAgent(true);
  }
}

async function init() {
  addLog("Dashboard baÅŸlatÄ±lÄ±yor...", "info");
  await Promise.all([
    refreshStatus(),
    loadPositions(),
    loadMarketList(),
    refreshOverviewPositions(),
    fetchLogs(),
  ]);
  addLog("Dashboard hazÄ±r âœ“", "ok");
  updatePnLPreview();
  ctrlUpdateTestPreview();
  ctrlUpdateAgentPreview();
}

// Poll every 10s
// â”€â”€â”€ Anti-flicker: sadece bir poll aynÄ± anda Ã§alÄ±ÅŸsÄ±n â”€â”€â”€â”€â”€â”€â”€
let _polling = false;
setInterval(async () => {
  if (_polling) return;
  _polling = true;
  try {
    await refreshStatus();
    await refreshOverviewPositions();
    if (document.querySelector(".tab[data-tab='positions'].active")) {
      await loadPositions();
    }
  } finally {
    _polling = false;
  }
}, 8000);

// Loglar ayrÄ± interval (daha sÄ±k ama hafif)
setInterval(async () => {
  const autoRefresh = document.getElementById("log-auto-refresh");
  if (!autoRefresh || autoRefresh.checked) await fetchLogs();
}, 4000);

// Price poll for selected symbol every 6s
setInterval(() => fetchSymbolPrice(state.symbol), 6000);

init();

// Alias for settings button
async function ctrlApplySettings() {
  return await ctrlApplyAgentSettings();
}
</script>



</body>
</html>